<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlackJack v2</title>
  <style>
    :root{
      --bg:#061b12;
      --felt1:#0b3d1a;
      --felt2:#0f5a25;
      --panel: rgba(9, 18, 14, .72);
      --panel2: rgba(14, 32, 22, .72);
      --line: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --danger: #ff5c73;
      --ok: #53ffa8;
      --warn: #ffd36a;

      --card: #fbfbfd;
      --shadow: rgba(0,0,0,.35);
      --shadow2: rgba(0,0,0,.5);

      --btn: rgba(255,255,255,.10);
      --btn2: rgba(255,255,255,.16);
      --btnGlow: rgba(83,255,168,.16);

      --chip10:#7bd0ff;
      --chip25:#9b8cff;
      --chip50:#ff8cc8;
      --chip100:#ffd36a;
      --chip500:#53ffa8;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background:
        radial-gradient(1200px 700px at 18% 0%, rgba(83,255,168,.12), transparent 55%),
        radial-gradient(1300px 800px at 90% 10%, rgba(155,140,255,.10), transparent 55%),
        radial-gradient(900px 700px at 60% 110%, rgba(255,140,200,.08), transparent 55%),
        linear-gradient(180deg, #04140e 0%, #03120c 60%, #020e09 100%);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 12px;
    }

    .brand{
      display:flex;
      align-items:end;
      gap:10px;
      min-width: 0;
    }
    .brand h1{
      margin:0;
      font-size: 20px;
      letter-spacing: .2px;
      line-height:1.1;
      white-space:nowrap;
    }
    .tag{
      font-size: 12px;
      color: var(--muted);
      padding: 4px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .pillrow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      justify-content:flex-end;
    }

    .pill{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      padding: 8px 10px;
      border-radius: 14px;
      display:flex;
      gap: 8px;
      align-items:center;
      min-width: 0;
      box-shadow: 0 10px 35px rgba(0,0,0,.18);
    }
    .pill b{ font-weight: 700; }
    .pill span{
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }

    .grid{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr 340px;
      align-items:start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .table{
      border-radius: 22px;
      overflow: hidden;
      background:
        radial-gradient(1000px 500px at 50% 0%, rgba(255,255,255,.10), transparent 56%),
        linear-gradient(160deg, var(--felt1), var(--felt2));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 24px 80px rgba(0,0,0,.32);
      position: relative;
      padding: 14px;
      min-height: 520px;
    }

    .table::before{
      content:"";
      position:absolute;
      inset: 10px;
      border-radius: 18px;
      border: 1px dashed rgba(255,255,255,.14);
      pointer-events:none;
      opacity:.6;
    }

    .zone{
      position:relative;
      z-index:1;
      background: rgba(7,16,12,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
      backdrop-filter: blur(6px);
    }

    .zone + .zone{ margin-top: 12px; }

    .zoneHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .zoneTitle{
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .3px;
    }
    .zoneMeta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .badge{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }

    .hands{
      display:grid;
      gap: 10px;
    }

    .hand{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .hand.active{
      border-color: rgba(83,255,168,.40);
      box-shadow: 0 0 0 4px rgba(83,255,168,.10);
    }

    .cards{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-right:auto;
      min-width: 220px;
    }

    .card{
      width: 52px;
      height: 72px;
      border-radius: 12px;
      background: var(--card);
      color: #121416;
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 10px 20px var(--shadow);
      position:relative;
      overflow:hidden;
      transform: translateY(0);
      transition: transform .12s ease;
      user-select:none;
    }
    .card:hover{ transform: translateY(-2px); }

    .card .r{
      position:absolute;
      top: 6px; left: 8px;
      font-weight: 900;
      font-size: 16px;
      letter-spacing:.1px;
    }
    .card .s{
      position:absolute;
      top: 26px; left: 8px;
      font-size: 16px;
      opacity: .92;
    }
    .card .big{
      position:absolute;
      right: 6px; bottom: 6px;
      font-size: 22px;
      opacity:.18;
      transform: rotate(12deg);
    }
    .card.red{ color:#b51616; }

    .card.back{
      background:
        radial-gradient(50px 50px at 30% 30%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(135deg, rgba(155,140,255,.55), rgba(83,255,168,.45));
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.92);
      box-shadow: 0 12px 26px var(--shadow2);
    }
    .card.back::before{
      content:"";
      position:absolute;
      inset: 7px;
      border-radius: 10px;
      border: 1px dashed rgba(255,255,255,.55);
      opacity:.6;
    }
    .card.back .r, .card.back .s{ display:none; }
    .card.back .big{ opacity:.65; }

    .handInfo{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .kv{
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      white-space: nowrap;
    }
    .kv b{ color: var(--text); }

    .resultBanner{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      display:none;
    }
    .resultBanner.show{ display:block; }
    .resultBanner .line1{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .resultBanner .title{
      font-weight: 900;
      letter-spacing: .4px;
    }
    .resultBanner .profit{
      font-weight: 900;
    }
    .profit.pos{ color: var(--ok); }
    .profit.neg{ color: var(--danger); }
    .profit.zero{ color: var(--warn); }

    /* Right panel */
    .side{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .panel{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--panel);
      box-shadow: 0 20px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .panelHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .panelHead .h{
      font-size: 13px;
      letter-spacing:.3px;
      font-weight: 900;
    }
    .panelBody{ padding: 12px; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: var(--btn);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 800;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .10s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:hover{
      background: var(--btn2);
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.22);
    }
    .btn:active{ transform: translateY(0); }
    .btn[disabled]{
      opacity: .45;
      cursor:not-allowed;
      transform:none;
    }
    .btn.primary{
      background: rgba(83,255,168,.14);
      border-color: rgba(83,255,168,.28);
      box-shadow: 0 0 0 4px rgba(83,255,168,.07);
    }
    .btn.primary:hover{ background: rgba(83,255,168,.20); }
    .btn.danger{
      background: rgba(255,92,115,.12);
      border-color: rgba(255,92,115,.30);
    }
    .btn.danger:hover{ background: rgba(255,92,115,.18); }

    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap: 10px;
    }

    .field{
      display:flex;
      gap: 8px;
      align-items:center;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    input[type="number"]{
      width: 120px;
      padding: 8px 10px;
      border-radius: 12px;
      outline: none;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      color: var(--text);
      font-weight: 800;
    }
    label{
      display:flex;
      align-items:center;
      gap: 8px;
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .10s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      display:flex; align-items:center; gap: 8px;
    }
    .chip:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }
    .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.7);
      box-shadow: 0 0 0 3px rgba(255,255,255,.08);
    }
    .dot.c10{ background: var(--chip10); }
    .dot.c25{ background: var(--chip25); }
    .dot.c50{ background: var(--chip50); }
    .dot.c100{ background: var(--chip100); }
    .dot.c500{ background: var(--chip500); }

    .mini{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      margin-top: 10px;
    }

    details{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    details summary{
      list-style:none;
      cursor:pointer;
      padding: 12px;
      font-weight: 900;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    details summary::-webkit-details-marker{ display:none; }
    .ruleGrid{
      padding: 0 12px 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .ck{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .ck input{ transform: scale(1.15); }
    .ck span{ color: var(--text); font-weight: 800; font-size: 12px; }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }
    .toast strong{ color: var(--text); }

    pre{
      margin:0;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.86);
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 11px;
      max-height: 230px;
      overflow:auto;
    }

    .kbd{
      font-size: 11px;
      color: rgba(255,255,255,.72);
      border: 1px solid rgba(255,255,255,.18);
      padding: 2px 6px;
      border-radius: 7px;
      background: rgba(0,0,0,.25);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>BlackJack v2</h1>
        <div class="tag">üíö cozy / addicting UI</div>
      </div>
      <div class="pillrow">
        <div class="pill"><span>Bank</span><b id="uiBank">-</b></div>
        <div class="pill"><span>Bet</span><b id="uiBet">-</b></div>
        <div class="pill"><span>Round</span><b id="uiRound">-</b></div>
        <div class="pill"><span>Time</span><b id="uiTime">-</b></div>
        <div class="pill"><span>Streak</span><b id="uiStreak">-</b></div>
      </div>
    </div>

    <div class="grid">
      <!-- TABLE -->
      <div class="table">
        <div class="zone" id="dealerZone">
          <div class="zoneHead">
            <div class="zoneTitle">DEALER</div>
            <div class="zoneMeta">
              <span class="badge">Up: <b id="uiUpcard">-</b></span>
              <span class="badge">Shown: <b id="uiDealerShown">-</b></span>
              <span class="badge">Total: <b id="uiDealerTotal">-</b></span>
            </div>
          </div>
          <div class="hand">
            <div class="cards" id="dealerCards"></div>
          </div>
        </div>

        <div class="zone" id="playerZone">
          <div class="zoneHead">
            <div class="zoneTitle">YOU</div>
            <div class="zoneMeta">
              <span class="badge">Phase: <b id="uiPhase">-</b></span>
              <span class="badge">Active Hand: <b id="uiActiveHand">-</b></span>
            </div>
          </div>

          <div class="hands" id="playerHands"></div>

          <div class="resultBanner" id="resultBanner">
            <div class="line1">
              <div class="title" id="resultTitle">ROUND OVER</div>
              <div class="profit" id="resultProfit">0</div>
            </div>
            <div style="color:var(--muted); font-size:12px;">
              Bonus: <b id="resultBonus">0</b>%Ôºà+<b id="resultBonusApplied">0</b>Ôºâ
            </div>
          </div>
        </div>
      </div>

      <!-- SIDE -->
      <div class="side">
        <div class="panel">
          <div class="panelHead">
            <div class="h">üéõÔ∏è Quick Actions</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="kbd">H</span><span class="kbd">S</span><span class="kbd">D</span>
            </div>
          </div>
          <div class="panelBody">
            <div class="controls">
              <button class="btn primary" id="btnStart">start_session</button>
              <button class="btn" id="btnDeal">deal</button>

              <button class="btn" id="btnHit">hit</button>
              <button class="btn" id="btnStand">stand</button>

              <button class="btn" id="btnDouble">double_down</button>
              <button class="btn" id="btnSplit">split</button>

              <button class="btn danger" id="btnSurrender">surrender</button>
              <button class="btn" id="btnReset">reset_session</button>
            </div>

            <div class="toast" id="toast">
              <strong>loading...</strong>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHead">
            <div class="h">ü™ô Bet & Chips</div>
            <div class="tag" style="padding:6px 10px;">ÂÅ∂Êï∞„ÅÆ„Åø</div>
          </div>
          <div class="panelBody">
            <div class="row">
              <div class="field">
                <label>BET
                  <input id="betInput" type="number" value="100" step="10" min="0" />
                </label>
              </div>
              <button class="btn" id="btnSetBet">set_bet</button>
            </div>

            <div class="chips">
              <div class="chip" data-add="10"><span class="dot c10"></span>+10</div>
              <div class="chip" data-add="25"><span class="dot c25"></span>+25</div>
              <div class="chip" data-add="50"><span class="dot c50"></span>+50</div>
              <div class="chip" data-add="100"><span class="dot c100"></span>+100</div>
              <div class="chip" data-add="500"><span class="dot c500"></span>+500</div>
              <div class="chip" data-add="-999999"><span class="dot"></span>clear</div>
            </div>

            <div class="mini">
              ‚Äª bet „ÅØ„Ç®„É≥„Ç∏„É≥ÂÅ¥„Åß <b>ÂÅ∂Êï∞„Å´‰∏∏„ÇÅ</b>ÔºàfloorÔºâ„Åï„Çå„Åæ„Åô„ÄÇ<br>
              ‚ÄúDeal‚Äù „Åô„Çã„Å® <b>„Åù„ÅÆ bet „Åå bank „Åã„ÇâÂ∑Æ„ÅóÂºï„Åã„Çå„Å¶</b> „É©„Ç¶„É≥„ÉâÈñãÂßã„ÄÇ
            </div>
          </div>
        </div>

        <div class="panel" id="insurancePanel" style="display:none;">
          <div class="panelHead">
            <div class="h">üõ°Ô∏è Insurance</div>
            <div class="tag">A upcard</div>
          </div>
          <div class="panelBody">
            <div class="row" style="justify-content:space-between;">
              <div class="badge">max: <b id="insMax">0</b></div>
              <div class="badge">bet: <b id="insBet">0</b></div>
            </div>

            <div class="row" style="margin-top:10px;">
              <label>amount
                <input id="insInput" type="number" value="0" min="0" step="1" />
              </label>
              <button class="btn" id="btnBuyIns">buy_insurance(x)</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn" id="btnBuyIns0">buy_insurance(0)</button>
              <button class="btn primary" id="btnEven">take_even_money</button>
            </div>

            <div class="mini">
              Even Money „ÅØ <b>„Éó„É¨„Ç§„É§„ÉºBJ</b> „ÅÆ„Å®„Åç„Å†„ÅëË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
            </div>
          </div>
        </div>

        <details class="panel" open>
          <summary>
            ‚öôÔ∏è Session Options
            <span style="color:var(--muted); font-size:12px;">(rules mask)</span>
          </summary>
          <div class="ruleGrid">
            <label class="ck"><input type="checkbox" id="rDouble" checked><span>Double</span></label>
            <label class="ck"><input type="checkbox" id="rSplit" checked><span>Split</span></label>
            <label class="ck"><input type="checkbox" id="rSurrender" checked><span>Surrender (Late)</span></label>
            <label class="ck"><input type="checkbox" id="rIns" checked><span>Insurance</span></label>
            <label class="ck"><input type="checkbox" id="rEven" checked><span>Even Money</span></label>
            <label class="ck"><input type="checkbox" id="rDAS" checked><span>DAS</span></label>
            <label class="ck"><input type="checkbox" id="rSplitBJ" checked><span>Split BJ as BJ</span></label>
            <label class="ck"><input type="checkbox" id="rH17" checked><span>Dealer hit soft 17</span></label>

            <div class="field" style="grid-column:1/-1; justify-content:space-between;">
              <label>sessionSeconds <input id="sessSec" type="number" value="300" step="30" min="30"></label>
              <label>roundLimit <input id="roundLimit" type="number" value="12" step="1" min="1"></label>
            </div>
          </div>
        </details>

        <div class="panel">
          <div class="panelHead">
            <div class="h">üì¶ Debug JSON</div>
            <div class="tag">engine state</div>
          </div>
          <div class="panelBody">
            <pre id="debugOut">loading...</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== UI helpers =====
    const $ = (id) => document.getElementById(id);

    const ui = {
      bank: $("uiBank"),
      bet: $("uiBet"),
      round: $("uiRound"),
      time: $("uiTime"),
      streak: $("uiStreak"),
      phase: $("uiPhase"),
      activeHand: $("uiActiveHand"),

      upcard: $("uiUpcard"),
      dealerShown: $("uiDealerShown"),
      dealerTotal: $("uiDealerTotal"),

      dealerCards: $("dealerCards"),
      playerHands: $("playerHands"),

      banner: $("resultBanner"),
      bannerTitle: $("resultTitle"),
      bannerProfit: $("resultProfit"),
      bannerBonus: $("resultBonus"),
      bannerBonusApplied: $("resultBonusApplied"),

      toast: $("toast"),
      debug: $("debugOut"),

      insurancePanel: $("insurancePanel"),
      insMax: $("insMax"),
      insBet: $("insBet"),
      insInput: $("insInput"),
    };

    function yen(n){ return String(n); } // ‰ªä„ÅØÂçò‰Ωç„Å™„ÅóË°®Á§∫ÔºàÂ•Ω„Åç„Å™„Çâ "¬•" Ë∂≥„Åó„Å¶OKÔºâ

    function msToMMSS(ms){
      const t = Math.max(0, Math.floor(ms/1000));
      const m = String(Math.floor(t/60)).padStart(2,'0');
      const s = String(t%60).padStart(2,'0');
      return `${m}:${s}`;
    }

    function isRedSuit(cardStr){
      // "Q‚ô¶" "A‚ô•" „ÇíËµ§„Å´
      return cardStr.includes("‚ô¶") || cardStr.includes("‚ô•");
    }

    function makeCardEl(cardStr){
      const el = document.createElement("div");
      if (cardStr === "?"){
        el.className = "card back";
        el.innerHTML = `<div class="big">üÇ†</div>`;
        return el;
      }
      const rank = cardStr.slice(0, -1);
      const suit = cardStr.slice(-1);
      el.className = "card" + (isRedSuit(cardStr) ? " red" : "");
      el.innerHTML = `
        <div class="r">${rank}</div>
        <div class="s">${suit}</div>
        <div class="big">${suit}</div>
      `;
      return el;
    }

    function setToast(kind, msg){
      // kind: "ok" "warn" "danger" "info"
      const color =
        kind === "ok" ? "var(--ok)" :
        kind === "danger" ? "var(--danger)" :
        kind === "warn" ? "var(--warn)" :
        "var(--text)";
      ui.toast.innerHTML = `<strong style="color:${color}">${msg}</strong>`;
    }

    // ===== Engine bridge =====
    let api = null;
    let lastState = null;

    function seed64(){
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return {lo: a[0] >>> 0, hi: a[1] >>> 0};
    }

    function readRulesMask(){
      const bits = {
        rDouble:  1 << 0,
        rSplit:   1 << 1,
        rSurrender: 1 << 2,
        rIns:     1 << 3,
        rEven:    1 << 4,
        rDAS:     1 << 5,
        rSplitBJ: 1 << 6,
        rH17:     1 << 7,
      };
      let mask = 0;
      for (const [id,bit] of Object.entries(bits)){
        if ($(id).checked) mask |= bit;
      }
      return mask >>> 0;
    }

    function refresh(){
      const p = api.get_state_json();
      const s = Module.UTF8ToString(p);
      api.free_ptr(p);

      lastState = JSON.parse(s);
      render(lastState);
    }

    function callAction(fnName, ...args){
      const rc = api[fnName](...args);
      refresh();
      // „Ç®„É©„ÉºË°®Á§∫
      if (rc !== 0 || lastState.lastErrorCode !== 0){
        setToast("danger", `Error: ${lastState.lastError || "Unknown"} (code ${lastState.lastErrorCode})`);
        console.warn("rc=", rc, "state=", lastState);
      } else {
        // Áä∂Ê≥Å„Å´Âøú„Åò„Å¶„É°„ÉÉ„Çª„Éº„Ç∏
        if (fnName === "deal") setToast("ok", "Dealt! „Åï„ÅÇÂãùË≤†„ÄÇ");
        else if (fnName === "hit") setToast("info", "Hit!");
        else if (fnName === "stand") setToast("info", "Stand.");
        else if (fnName === "double_down") setToast("warn", "Double down!");
        else if (fnName === "split") setToast("warn", "Split!");
        else if (fnName === "surrender") setToast("warn", "Surrender‚Ä¶ ÔºàÂçäÈ°çÊàª„ÇãÔºâ");
        else if (fnName === "set_bet") setToast("ok", `Bet set: ${lastState.baseBet}`);
        else if (fnName === "start_session") setToast("ok", "Session started. Set bet ‚Üí Deal!");
        else if (fnName === "reset_session") setToast("info", "Reset.");
        else if (fnName === "buy_insurance") setToast("info", "Insurance decided.");
        else if (fnName === "take_even_money") setToast("ok", "Even money taken.");
        else setToast("info", "OK");
      }
    }

    // ===== Render =====
    function render(st){
      ui.debug.textContent = JSON.stringify(st, null, 2);

      ui.bank.textContent = yen(st.bank);
      ui.bet.textContent  = yen(st.baseBet);
      ui.round.textContent = `${st.session.round}/${st.session.roundLimit}`;
      ui.time.textContent = msToMMSS(st.session.timeLeftMs);
      ui.streak.textContent = String(st.roundResult.streak);

      ui.phase.textContent = st.phase;
      ui.activeHand.textContent = String(st.player.activeHandIndex);

      ui.upcard.textContent = st.dealer.upcard || "-";
      ui.dealerShown.textContent = String(st.dealer.scoreShown ?? 0);
      ui.dealerTotal.textContent = st.dealer.holeKnown ? String(st.dealer.score ?? 0) : "??";

      // Dealer cards
      ui.dealerCards.innerHTML = "";
      for (const c of st.dealer.cards){
        ui.dealerCards.appendChild(makeCardEl(c));
      }

      // Player hands
      ui.playerHands.innerHTML = "";
      const hands = st.player.hands || [];
      hands.forEach((h, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "hand" + (idx === st.player.activeHandIndex ? " active" : "");
        const cards = document.createElement("div");
        cards.className = "cards";
        for (const c of h.cards){
          cards.appendChild(makeCardEl(c));
        }

        const info = document.createElement("div");
        info.className = "handInfo";

        const flags = h.flags || {};
        const status = [];
        if (flags.blackjack) status.push("BJ");
        if (flags.bust) status.push("BUST");
        if (flags.doubled) status.push("DBL");
        if (flags.surrendered) status.push("SRR");
        if (flags.fromSplit) status.push("SPLIT");

        info.innerHTML = `
          <div class="kv">score <b>${h.score}</b></div>
          <div class="kv">bet <b>${h.bet}</b></div>
          <div class="kv">status <b>${status.length ? status.join(" / ") : "‚Äî"}</b></div>
        `;

        wrap.appendChild(cards);
        wrap.appendChild(info);
        ui.playerHands.appendChild(wrap);
      });

      // Result banner
      const isRoundOver = (st.phase === "roundOver" || st.phase === "sessionOver");
      if (isRoundOver){
        const p = st.roundResult.netProfit || 0;
        ui.banner.classList.add("show");
        ui.bannerProfit.textContent = `${p >= 0 ? "+" : ""}${p}`;
        ui.bannerProfit.className = "profit " + (p > 0 ? "pos" : p < 0 ? "neg" : "zero");

        let title = "ROUND OVER";
        if (p > 0) title = "YOU WIN ‚ú®";
        else if (p < 0) title = "YOU LOSE‚Ä¶";
        else title = "PUSH ü§ù";
        ui.bannerTitle.textContent = title;

        ui.bannerBonus.textContent = String(st.roundResult.bonusPercent || 0);
        ui.bannerBonusApplied.textContent = String(st.roundResult.bonusApplied || 0);
      } else {
        ui.banner.classList.remove("show");
      }

      // Buttons enable/disable from `can`
      const can = st.can || {};
      $("btnDeal").disabled = !can.deal;
      $("btnHit").disabled = !can.hit;
      $("btnStand").disabled = !can.stand;
      $("btnDouble").disabled = !can.double;
      $("btnSplit").disabled = !can.split;
      $("btnSurrender").disabled = !can.surrender;

      // Insurance panel
      const showIns = (st.phase === "offerInsurance");
      ui.insurancePanel.style.display = showIns ? "" : "none";
      if (showIns){
        ui.insMax.textContent = String(st.insurance.max || 0);
        ui.insBet.textContent = String(st.insurance.bet || 0);
        ui.insInput.max = String(st.insurance.max || 0);
        $("btnEven").disabled = !can.evenMoney;
      }

      // Toast auto message
      if (st.lastErrorCode && st.lastError){
        setToast("danger", `Error: ${st.lastError} (code ${st.lastErrorCode})`);
      } else {
        // phase guide
        if (st.phase === "betting") setToast("info", "Bet „ÇíÊ±∫„ÇÅ„Å¶ ‚Üí Deal!");
        else if (st.phase === "inHand") setToast("ok", "Your move: Hit / Stand / Double / Surrender");
        else if (st.phase === "offerInsurance") setToast("warn", "Insurance?Ôºà„Éá„Ç£„Éº„É©„ÉºAÔºâ");
        else if (st.phase === "roundOver") setToast("info", "Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„ÅØ Deal „ÅßOKÔºàbetÂ§â„Åà„Çã„Å™„Çâ set_betÔºâ");
        else if (st.phase === "sessionOver") setToast("danger", "Session Over. start_session „ÅßÂÜçÈñã„ÄÇ");
        else if (st.phase === "menu") setToast("info", "start_session „Åã„ÇâÂßã„ÇÅ„Çà„ÅÜ„ÄÇ");
      }
    }

    // ===== Wire UI =====
    function evenize(n){ n = Number(n||0); if (!Number.isFinite(n)) n = 0; return Math.floor(n/2)*2; }

    function addToBet(delta){
      const inp = $("betInput");
      if (delta <= -999999){
        inp.value = 0;
        return;
      }
      inp.value = Math.max(0, Number(inp.value||0) + delta);
    }

    document.querySelectorAll(".chip").forEach(el=>{
      el.addEventListener("click", () => addToBet(Number(el.dataset.add)));
    });

    $("btnStart").addEventListener("click", () => {
      const {lo,hi} = seed64();
      const rulesMask = readRulesMask();
      const sessionSeconds = Number($("sessSec").value || 300);
      const roundLimit = Number($("roundLimit").value || 12);

      callAction("start_session", lo, hi, rulesMask, sessionSeconds, roundLimit);

      // start Áõ¥Âæå„Å´ bet „ÇÇÂèçÊò†ÔºàÊ∞óÊåÅ„Å°„Çà„ÅïÈáçË¶ñÔºâ
      const v = Number($("betInput").value || 0);
      callAction("set_bet", v);
    });

    $("btnSetBet").addEventListener("click", () => {
      const v = Number($("betInput").value || 0);
      callAction("set_bet", v);
      // UIÂÅ¥„Åß„ÇÇÂÅ∂Êï∞„Å´ÂØÑ„Åõ„Å¶Ë¶ã„Åõ„ÇãÔºàÊ∞óÊåÅ„Å°„ÅÑ„ÅÑÔºâ
      $("betInput").value = evenize(v);
    });

    $("btnDeal").addEventListener("click", ()=> callAction("deal"));
    $("btnHit").addEventListener("click", ()=> callAction("hit"));
    $("btnStand").addEventListener("click", ()=> callAction("stand"));
    $("btnDouble").addEventListener("click", ()=> callAction("double_down"));
    $("btnSplit").addEventListener("click", ()=> callAction("split"));
    $("btnSurrender").addEventListener("click", ()=> callAction("surrender"));
    $("btnReset").addEventListener("click", ()=> callAction("reset_session"));

    $("btnBuyIns").addEventListener("click", ()=> {
      const v = Number(ui.insInput.value || 0);
      callAction("buy_insurance", v);
    });
    $("btnBuyIns0").addEventListener("click", ()=> callAction("buy_insurance", 0));
    $("btnEven").addEventListener("click", ()=> callAction("take_even_money"));

    // „Ç≠„Éº„Éú„Éº„ÉâÔºà‰∏≠ÊØíÊÄß„Ç¢„ÉÉ„ÉóÔºâ
    window.addEventListener("keydown", (e)=>{
      if (!api || !lastState) return;
      if (e.key === "h" || e.key === "H"){ if (!$("btnHit").disabled) callAction("hit"); }
      if (e.key === "s" || e.key === "S"){ if (!$("btnStand").disabled) callAction("stand"); }
      if (e.key === "d" || e.key === "D"){ if (!$("btnDouble").disabled) callAction("double_down"); }
    });

    // ===== Emscripten Module =====
    var Module = {
      onRuntimeInitialized: () => {
        api = {
          start_session: Module.cwrap('start_session', 'number', ['number','number','number','number','number']),
          reset_session: Module.cwrap('reset_session', 'number', []),
          set_bet: Module.cwrap('set_bet', 'number', ['number']),
          deal: Module.cwrap('deal', 'number', []),
          hit: Module.cwrap('hit', 'number', []),
          stand: Module.cwrap('stand', 'number', []),
          double_down: Module.cwrap('double_down', 'number', []),
          split: Module.cwrap('split', 'number', []),
          surrender: Module.cwrap('surrender', 'number', []),
          buy_insurance: Module.cwrap('buy_insurance', 'number', ['number']),
          take_even_money: Module.cwrap('take_even_money', 'number', []),
          get_state_json: Module.cwrap('get_state_json', 'number', []),
          free_ptr: Module.cwrap('free_ptr', null, ['number']),
        };

        setToast("ok", "Ready! start_session „ÅßÈñãÂßã„ÄÇ");
        try { refresh(); } catch(e){ /* ÂàùÊúü„ÅØmenuÊÉ≥ÂÆö */ }
      }
    };
  </script>

  <!-- v2 build (must be in same folder) -->
  <script src="blackjack_v2.js"></script>
</body>
</html>
