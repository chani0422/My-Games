<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BlackJack</title>
  <style>
    :root{
      --bg0:#06180e;
      --bg1:#0b3d1a;
      --bg2:#0f5a25;
      --panel:#0e3b1c;
      --panel2:#114a22;
      --text:#ffffff;
      --muted:rgba(255,255,255,.75);
      --muted2:rgba(255,255,255,.55);
      --border:rgba(255,255,255,.16);
      --shadow:rgba(0,0,0,.35);
      --good:#37d67a;
      --bad:#ff4d4d;
      --warn:#ffcc66;
      --chip:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 30%, var(--bg2));
      overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius:16px;
      box-shadow:0 12px 30px var(--shadow);
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(8px);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.32), rgba(255,255,255,.06)),
                  linear-gradient(135deg, rgba(255,209,102,.9), rgba(55,214,122,.7));
      box-shadow:0 10px 20px rgba(0,0,0,.25);
    }
    .brand h1{margin:0;font-size:14px;letter-spacing:.06em}
    .sub{font-size:12px;color:var(--muted2)}
    .stats{display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end}
    .pill{
      display:flex; gap:8px; align-items:baseline;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      min-width: 130px;
      justify-content:space-between;
    }
    .pill b{font-size:13px}
    .pill span{font-size:12px;color:var(--muted)}
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:hover{box-shadow:0 10px 22px rgba(0,0,0,.22)}
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn[disabled]{opacity:.38; cursor:not-allowed; box-shadow:none}
    .btn.primary{
      border-color: rgba(255,255,255,.22);
      background:linear-gradient(135deg, rgba(55,214,122,.55), rgba(255,209,102,.35));
    }
    .btn.danger{
      background:linear-gradient(180deg, rgba(255,77,77,.28), rgba(255,255,255,.03));
      border-color: rgba(255,77,77,.35);
    }
    .btn.ghost{background:rgba(0,0,0,.14)}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns: 1fr}
      .pill{min-width:auto}
    }
    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.18));
      border-radius:18px;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,.10);
    }
    .card .hd h2{margin:0;font-size:13px;letter-spacing:.06em}
    .card .bd{padding:14px}
    .table{
      display:flex; flex-direction:column; gap:12px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .muted{color:var(--muted); font-size:12px}
    .small{font-size:12px}
    .divider{height:1px;background:var(--border);margin:10px 0}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chipbtn{
      border:1px solid rgba(255,209,102,.35);
      background:linear-gradient(180deg, rgba(255,209,102,.18), rgba(0,0,0,.10));
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      color:var(--text);
      font-weight:700;
      letter-spacing:.02em;
    }
    .chipbtn:active{transform:translateY(1px)}
    input[type="number"]{
      width: 140px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    .handArea{display:flex; flex-direction:column; gap:12px}
    .handBox{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:rgba(0,0,0,.16);
      transition: transform .12s ease, border-color .12s ease;
    }
    .handBox.active{
      border-color: rgba(55,214,122,.55);
      box-shadow: 0 0 0 2px rgba(55,214,122,.12) inset, 0 10px 22px rgba(0,0,0,.22);
      transform: translateY(-1px);
    }
    .cards{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .cardFace{
      width:44px;height:62px;border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      color:#111;
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      border:1px solid rgba(0,0,0,.10);
    }
    .cardBack{
      width:44px;height:62px;border-radius:12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), transparent 50%),
        linear-gradient(135deg, rgba(255,209,102,.75), rgba(55,214,122,.65));
      border:1px solid rgba(255,255,255,.20);
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }
    .badge{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      color:var(--muted);
    }
    .badge.good{border-color: rgba(55,214,122,.40); color:#d8ffe7}
    .badge.bad{border-color: rgba(255,77,77,.40); color:#ffd1d1}
    .actions{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .actions .btn{width:100%}
    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .banner .msg{font-weight:800}
    .banner .msg.win{color:#d8ffe7}
    .banner .msg.lose{color:#ffd1d1}
    .banner .msg.neutral{color:#fff1cc}
    .screen{
      display:none;
      animation: fadeIn .18s ease;
    }
    .screen.active{display:block}
    @keyframes fadeIn{from{opacity:.5; transform: translateY(6px)}to{opacity:1; transform:none}}
    .titleHero{
      padding:18px 16px;
      text-align:center;
    }
    .titleHero h2{margin:10px 0 2px; font-size:26px; letter-spacing:.02em}
    .titleHero p{margin:0; color:var(--muted)}
    .optGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 560px){ .optGrid{grid-template-columns:1fr} }
    .opt{
      padding:12px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .opt label{display:flex; gap:10px; align-items:center; cursor:pointer; width:100%}
    .opt input{transform: scale(1.1)}
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.52);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
      backdrop-filter: blur(8px);
    }
    .overlay.show{display:flex}
    .modal{
      width:min(560px, 100%);
      border-radius:18px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.30));
      box-shadow:0 22px 52px rgba(0,0,0,.40);
      overflow:hidden;
    }
    .modal .hd{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center}
    .modal .bd{padding:14px}
    .toastWrap{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:16px;
      display:flex; flex-direction:column; gap:8px;
      z-index:99;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.55);
      color:#fff;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      font-size:13px;
      max-width:min(560px, calc(100vw - 24px));
    }
    .prog{
      height:8px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .prog > div{height:100%; width:0% ; background: linear-gradient(90deg, rgba(255,209,102,.9), rgba(55,214,122,.9));}
  </style>
</head>
<body>
  <button onclick="onClickStartSession()">Start Session</button>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>BlackJack</h1>
          <div class="sub" id="subLine">loading engine...</div>
        </div>
      </div>

      <div class="stats">
        <div class="pill"><span>Bank</span><b id="bank">-</b></div>
        <div class="pill"><span>Round</span><b id="round">-</b></div>
        <div class="pill"><span>Time</span><b id="time">-</b></div>

        <button class="btn ghost" id="btnPause" title="Pause">MENU</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>
    </div>

    <!-- TITLE -->
    <div class="screen active" id="screenTitle">
      <div class="card">
        <div class="titleHero">
          <div class="badge good">3:2 payout • 6 decks • H17</div>
          <h2>3分でサクッと、One more playing!</h2>
          <p>ルールを選んでスタート。</p>
        </div>
        <div class="bd">
          <div class="row" style="justify-content:center; gap:12px;">
            <button class="btn primary" id="btnStart" style="min-width:220px;">Start Session</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <div class="muted">Bet（偶数のみ推奨：3:2 や insurance bet/2 で端数を出さない）</div>
              <div class="row" style="margin-top:8px;">
                <input id="betInput" type="number" value="100" step="10" min="10">
                <div class="chips">
                  <button class="chipbtn" data-add="10">+10</button>
                  <button class="chipbtn" data-add="50">+50</button>
                  <button class="chipbtn" data-add="100">+100</button>
                  <button class="chipbtn" data-add="200">+200</button>
                </div>
              </div>
              <div class="muted" id="betHint" style="margin-top:6px;"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted">Options（タイトルでON/OFF）</div>
          <div class="optGrid" style="margin-top:10px;">
            <div class="opt"><label><input type="checkbox" id="optDouble" checked> Double Down</label></div>
            <div class="opt"><label><input type="checkbox" id="optSplit" checked> Split</label></div>
            <div class="opt"><label><input type="checkbox" id="optSurrender" checked> Surrender (Late)</label></div>
            <div class="opt"><label><input type="checkbox" id="optInsurance" checked> Insurance</label></div>
            <div class="opt"><label><input type="checkbox" id="optEvenMoney" checked> Even Money</label></div>
            <div class="opt"><label><input type="checkbox" id="optDAS" checked> DAS (Double after split)</label></div>
            <div class="opt"><label><input type="checkbox" id="optSplitBJ" checked> Split BJ as BJ</label></div>
            <div class="opt"><label><input type="checkbox" id="optH17" checked> Dealer hits Soft 17</label></div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between">
            <div class="muted">Tips：Reset は “1回タップ → Hold to reset → 2秒長押し”</div>
            <button class="btn" id="btnHowTitle">遊び方</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div class="screen" id="screenGame">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>TABLE</h2>
            <div class="badge" id="phaseBadge">-</div>
          </div>
          <div class="bd">
            <div class="table">
              <div class="handBox" id="dealerBox">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <b>Dealer</b>
                    <span class="muted" id="dealerScoreLine"></span>
                  </div>
                  <div class="badge" id="dealerHole">-</div>
                </div>
                <div class="cards" id="dealerCards"></div>
              </div>

              <div class="handArea" id="playerHands"></div>

              <div class="banner" id="roundBanner" style="display:none;">
                <div class="msg neutral" id="roundMsg">-</div>
                <div class="muted" id="roundMeta">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>CONTROLS</h2>
            <div class="badge" id="rulesMini">-</div>
          </div>
          <div class="bd">
            <div class="row">
              <div class="muted">Bet</div>
              <input id="betInGame" type="number" value="100" step="10">
              <button class="btn" id="btnSetBet">set_bet</button>
            </div>

            <div class="row chips" style="margin-top:10px;">
              <button class="chipbtn" data-add2="10">+10</button>
              <button class="chipbtn" data-add2="50">+50</button>
              <button class="chipbtn" data-add2="100">+100</button>
              <button class="chipbtn" data-add2="200">+200</button>
            </div>

            <div class="divider"></div>

            <div class="actions">
              <button class="btn primary" id="btnDeal">Deal / Next Round</button>
              <button class="btn" id="btnHit">Hit</button>
              <button class="btn" id="btnStand">Stand</button>
              <button class="btn" id="btnDouble">Double</button>
              <button class="btn" id="btnSplit">Split</button>
              <button class="btn" id="btnSurrender">Surrender</button>
            </div>

            <div class="divider"></div>

            <div class="handBox" id="insuranceBox" style="display:none;">
              <div class="row" style="justify-content:space-between;">
                <b>Insurance</b>
                <span class="muted" id="insHint">-</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <input id="insAmount" type="number" value="0" step="2" min="0">
                <button class="btn" id="btnInsBuy">buy_insurance</button>
                <button class="btn" id="btnInsNo">No thanks</button>
              </div>
              <div class="row" style="margin-top:8px;">
                <button class="btn" id="btnEvenMoney">Even Money</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="muted small" id="debugLine">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OVERLAYS -->
  <div class="overlay" id="overlayPause">
    <div class="modal">
      <div class="hd">
        <b>PAUSED</b>
        <button class="btn ghost" id="btnClosePause">Close</button>
      </div>
      <div class="bd">
        <p class="muted" style="margin-top:0;">
          セッションは終了しません。<b>Continue</b>で復帰、<b>Quit</b>でタイトルに戻れます。
        </p>
        <div class="row" style="justify-content:flex-end; gap:10px;">
          <button class="btn" id="btnHowPause">遊び方</button>
          <button class="btn primary" id="btnContinue">Continue</button>
          <button class="btn danger" id="btnQuit">Quit to Title</button>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlayHow">
    <div class="modal">
      <div class="hd">
        <b>HOW TO PLAY</b>
        <button class="btn ghost" id="btnCloseHow">Close</button>
      </div>
      <div class="bd">
        <div class="muted">
          <ul>
            <li>目標：<b>21に近づける</b>（21超えはBust）</li>
            <li>10/J/Q/Kは<b>全部10扱い</b>、Aは<b>1 or 11</b></li>
            <li><b>Deal</b>で開始（RoundOver中は次ラウンドに進む）</li>
            <li><b>Double</b>：同額追加→1回Hitで強制終了</li>
            <li><b>Split</b>：同“点数”ならOK。Aスプリットは1枚で終了</li>
            <li><b>Surrender</b>：最初の2枚のみ。掛け金の半分が返る（Late／peek後）</li>
            <li><b>Insurance</b>：ディーラー表がAの時のみ。最大 bet/2</li>
            <li><b>Even Money</b>：プレイヤーBJ時に提示</li>
          </ul>
          <p>※操作可否はC++が返す <b>state.can</b> が真実。ボタンは自動で無効化されます。</p>
        </div>
      </div>
    </div>
  </div>

  <div class="toastWrap" id="toastWrap"></div>

  <script>
    // ========= Utilities =========
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const w = $("toastWrap");
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = msg;
      w.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, 1400);
      setTimeout(()=>{ el.remove(); }, 1900);
    }

    function seed64(){
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return {lo: a[0] >>> 0, hi: a[1] >>> 0};
    }

    function floorEven(x){
      x = Number(x||0);
      if (!Number.isFinite(x)) x = 0;
      if (x < 0) x = 0;
      return Math.floor(x/2)*2;
    }

    function fmtTime(ms){
      ms = Math.max(0, ms|0);
      const s = Math.ceil(ms/1000);
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    // ========= Engine API =========
    let api = null;
    let state = null;

    // timer (JS drives timeLeftMs)
    let sessionMs = 300000;
    let startTickAt = 0;        // performance.now
    let pausedAt = 0;
    let pausedTotal = 0;
    let tickHandle = null;
    let lastTimePush = 0;

    function rulesMaskFromUI(){
      // C++側 RuleBits と一致
      const RB_ALLOW_DOUBLE      = 1 << 0;
      const RB_ALLOW_SPLIT       = 1 << 1;
      const RB_ALLOW_SURRENDER   = 1 << 2;
      const RB_ALLOW_INSURANCE   = 1 << 3;
      const RB_ALLOW_EVEN_MONEY  = 1 << 4;
      const RB_ALLOW_DAS         = 1 << 5;
      const RB_SPLIT_BJ_AS_BJ    = 1 << 6;
      const RB_DEALER_HIT_S17    = 1 << 7;

      let m = 0;
      if ($("optDouble").checked)   m |= RB_ALLOW_DOUBLE;
      if ($("optSplit").checked)    m |= RB_ALLOW_SPLIT;
      if ($("optSurrender").checked)m |= RB_ALLOW_SURRENDER;
      if ($("optInsurance").checked)m |= RB_ALLOW_INSURANCE;
      if ($("optEvenMoney").checked)m |= RB_ALLOW_EVEN_MONEY;
      if ($("optDAS").checked)      m |= RB_ALLOW_DAS;
      if ($("optSplitBJ").checked)  m |= RB_SPLIT_BJ_AS_BJ;
      if ($("optH17").checked)      m |= RB_DEALER_HIT_S17;
      return m >>> 0;
    }

    function refresh(){
      const p = api.get_state_json();
      const s = Module.UTF8ToString(p);
      api.free_ptr(p);
      state = JSON.parse(s);
      render();
      return state;
    }

    function callAction(fnName, ...args){
      const rc = api[fnName](...args);
      const st = refresh();
      if (rc !== 0 || st.lastErrorCode !== 0){
        if (st.lastError) toast(st.lastError);
        console.warn("action", fnName, "rc=", rc, "err=", st.lastErrorCode, st.lastError);
      }
      return rc;
    }

    function goScreen(name){
      $("screenTitle").classList.toggle("active", name==="title");
      $("screenGame").classList.toggle("active", name==="game");
    }

    function startTick(){
      stopTick();
      startTickAt = performance.now();
      pausedTotal = 0;
      pausedAt = 0;
      lastTimePush = 0;
      tickHandle = setInterval(()=>{
        if (!state) return;
        // paused phaseなら進めない
        if (state.phase === "paused") return;

        const now = performance.now();
        const elapsed = now - startTickAt - pausedTotal;
        const left = Math.max(0, sessionMs - elapsed);
        // C++へは1秒に1回くらいで十分
        if (now - lastTimePush > 1000){
          api.set_time_left_ms(left|0);
          lastTimePush = now;
          refresh();
        } else {
          // UIの表示用だけ更新（stateは次refreshで追従）
          $("time").textContent = fmtTime(left|0);
        }
      }, 120);
    }

    function stopTick(){
      if (tickHandle){ clearInterval(tickHandle); tickHandle = null; }
    }

    function pauseOn(){
      if (!state) return;
      callAction("set_paused", 1);
      pausedAt = performance.now();
      $("overlayPause").classList.add("show");
    }
    function pauseOff(){
      if (!state) return;
      if (pausedAt){
        pausedTotal += performance.now() - pausedAt;
        pausedAt = 0;
      }
      callAction("set_paused", 0);
      $("overlayPause").classList.remove("show");
    }

    // ========= Hold to reset =========
    let resetArmed = false;
    let holdTimer = null;
    let holdStart = 0;

    function disarmReset(){
      resetArmed = false;
      $("btnReset").textContent = "Reset";
      $("btnReset").classList.remove("danger");
      if (holdTimer){ clearInterval(holdTimer); holdTimer = null; }
    }

    function armResetOnce(){
      resetArmed = true;
      $("btnReset").textContent = "Hold to reset";
      $("btnReset").classList.add("danger");
      toast("2秒長押しでリセット");
      // 5秒で自動解除
      setTimeout(()=>{ if (resetArmed) disarmReset(); }, 5000);
    }

    function doResetToTitle(){
      stopTick();
      disarmReset();
      callAction("reset_session");
      $("overlayPause").classList.remove("show");
      $("overlayHow").classList.remove("show");
      goScreen("title");
      $("subLine").textContent = "ready.";
      toast("Reset!");
    }

    // ========= Render =========
    function render(){
      if (!state) return;

      $("subLine").textContent = `phase: ${state.phase}`;
      $("bank").textContent = state.bank;
      $("round").textContent = `${state.session.round}/${state.session.roundLimit}`;
      $("time").textContent = fmtTime(state.session.timeLeftMs);

      $("phaseBadge").textContent = state.phase;
      $("rulesMini").textContent = [
        state.rules.allowDouble ? "Dbl" : "",
        state.rules.allowSplit ? "Spl" : "",
        state.rules.allowSurrender ? "Sur" : "",
        state.rules.allowInsurance ? "Ins" : "",
        state.rules.allowEvenMoney ? "EM" : "",
        state.rules.allowDAS ? "DAS" : "",
        state.rules.splitBJAsBJ ? "SplitBJ" : "",
        state.rules.dealerHitSoft17 ? "H17" : "S17"
      ].filter(Boolean).join(" • ") || "-";

      // Dealer
      $("dealerScoreLine").textContent = ` (shown ${state.dealer.scoreShown} / total ${state.dealer.score})`;
      $("dealerHole").textContent = state.dealer.holeKnown ? "hole open" : "hole hidden";

      const dWrap = $("dealerCards");
      dWrap.innerHTML = "";
      (state.dealer.cards||[]).forEach((c, idx)=>{
        const el = document.createElement("div");
        if (c === "?") { el.className="cardBack"; }
        else { el.className="cardFace"; el.textContent=c; }
        dWrap.appendChild(el);
      });

      // Player hands
      const ph = $("playerHands");
      ph.innerHTML = "";
      const hands = (state.player && state.player.hands) ? state.player.hands : [];
      hands.forEach((h, i)=>{
        const box = document.createElement("div");
        box.className = "handBox" + (i === state.player.activeHandIndex ? " active" : "");
        const flags = [];
        if (h.flags.blackjack) flags.push("BJ");
        if (h.flags.bust) flags.push("BUST");
        if (h.flags.doubled) flags.push("DBL");
        if (h.flags.surrendered) flags.push("SUR");
        if (h.flags.fromSplit) flags.push("SPLIT");
        if (h.flags.splitAces) flags.push("A-SPLIT");
        const badgeClass =
          h.flags.blackjack ? "good" :
          h.flags.bust ? "bad" :
          h.flags.surrendered ? "bad" : "";

        box.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div>
              <b>Player ${hands.length>1 ? `Hand ${i+1}` : ""}</b>
              <span class="muted"> score ${h.score} / bet ${h.bet}</span>
            </div>
            <div class="badge ${badgeClass}">${flags.length?flags.join(" • "):"playing"}</div>
          </div>
          <div class="cards">${(h.cards||[]).map(cc=>`<div class="cardFace">${cc}</div>`).join("")}</div>
        `;
        ph.appendChild(box);
      });

      // Controls enable/disable from state.can
      const can = state.can || {};
      $("btnDeal").disabled = !can.deal;
      $("btnHit").disabled = !can.hit;
      $("btnStand").disabled = !can.stand;
      $("btnDouble").disabled = !can.double;
      $("btnSplit").disabled = !can.split;
      $("btnSurrender").disabled = !can.surrender;

      // Insurance UI
      const showIns = (state.phase === "offerInsurance");
      $("insuranceBox").style.display = showIns ? "block" : "none";
      $("btnInsBuy").disabled = !can.insurance;
      $("btnInsNo").disabled = !can.insurance;
      $("btnEvenMoney").disabled = !can.evenMoney;

      if (showIns){
        $("insHint").textContent = `max ${state.insurance.max}`;
        const a = $("insAmount");
        a.max = state.insurance.max;
        a.step = 2;
        a.value = Math.min(Number(a.value||0), state.insurance.max);
      }

      // Round banner
      const isRoundOver = (state.phase === "roundOver" || state.phase === "sessionOver");
      $("roundBanner").style.display = isRoundOver ? "flex" : "none";
      const net = state.roundResult.netProfit|0;
      const msgEl = $("roundMsg");
      const metaEl = $("roundMeta");
      if (isRoundOver){
        if (state.phase === "sessionOver"){
          msgEl.textContent = "SESSION OVER";
          msgEl.className = "msg neutral";
        } else if (net > 0){
          msgEl.textContent = `WIN +${net}`;
          msgEl.className = "msg win";
        } else if (net < 0){
          msgEl.textContent = `LOSE ${net}`;
          msgEl.className = "msg lose";
        } else {
          msgEl.textContent = "PUSH ±0";
          msgEl.className = "msg neutral";
        }
        metaEl.textContent = `streak ${state.roundResult.streak} / bonus ${state.roundResult.bonusPercent}% (+${state.roundResult.bonusApplied})`;
      }

      $("debugLine").textContent = `lastErrorCode=${state.lastErrorCode} lastError="${state.lastError || ""}"`;

      // bet hint
      const hint = $("betHint");
      const v = floorEven($("betInput").value);
      hint.textContent = `入力=${$("betInput").value} → 偶数化=${v}（min ${state.minBet} / max bank）`;
    }

    // ========= Module (emscripten) =========
    var Module = {
      onRuntimeInitialized: () => {
        api = {
          start_session: Module.cwrap('start_session', 'number', ['number','number','number','number','number']),
          reset_session: Module.cwrap('reset_session', 'number', []),
          set_time_left_ms: Module.cwrap('set_time_left_ms', 'number', ['number']),
          set_paused: Module.cwrap('set_paused', 'number', ['number']),
          set_bet: Module.cwrap('set_bet', 'number', ['number']),
          deal: Module.cwrap('deal', 'number', []),
          hit: Module.cwrap('hit', 'number', []),
          stand: Module.cwrap('stand', 'number', []),
          double_down: Module.cwrap('double_down', 'number', []),
          split: Module.cwrap('split', 'number', []),
          surrender: Module.cwrap('surrender', 'number', []),
          buy_insurance: Module.cwrap('buy_insurance', 'number', ['number']),
          take_even_money: Module.cwrap('take_even_money', 'number', []),
          get_state_json: Module.cwrap('get_state_json', 'number', []),
          free_ptr: Module.cwrap('free_ptr', null, ['number']),
        };

        try { refresh(); } catch(e){ console.warn(e); }
        $("subLine").textContent = "ready.";
        toast("Engine ready");
      }
    };

    // ========= UI events =========
    // Title chips
    document.querySelectorAll('[data-add]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cur = Number($("betInput").value||0);
        $("betInput").value = cur + Number(btn.dataset.add);
      });
    });

    document.querySelectorAll('[data-add2]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cur = Number($("betInGame").value||0);
        $("betInGame").value = cur + Number(btn.dataset.add2);
      });
    });

    $("btnHowTitle").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnHowPause").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnCloseHow").onclick = ()=> $("overlayHow").classList.remove("show");

    $("btnPause").onclick = ()=>{
      if (!state) return;
      // ゲーム画面だけで有効
      if ($("screenGame").classList.contains("active")){
        pauseOn();
      } else {
        toast("ゲーム中に使えます");
      }
    };
    $("btnClosePause").onclick = pauseOff;
    $("btnContinue").onclick = pauseOff;
    $("btnQuit").onclick = ()=> doResetToTitle();

    // Reset: 1回タップでHoldモードへ、2秒長押しで実行
    $("btnReset").addEventListener("click", ()=>{
      if (!resetArmed) armResetOnce();
    });

    $("btnReset").addEventListener("pointerdown", ()=>{
      if (!resetArmed) return;
      holdStart = performance.now();
      const btn = $("btnReset");
      btn.textContent = "Holding...";
      const wrap = document.createElement("div");
      wrap.className = "prog";
      const bar = document.createElement("div");
      wrap.appendChild(bar);
      btn.appendChild(wrap);

      holdTimer = setInterval(()=>{
        const t = performance.now() - holdStart;
        const pct = Math.min(100, (t / 2000) * 100);
        bar.style.width = pct + "%";
        if (t >= 2000){
          clearInterval(holdTimer); holdTimer=null;
          doResetToTitle();
        }
      }, 30);
    });

    function cancelHold(){
      if (holdTimer){ clearInterval(holdTimer); holdTimer = null; }
      if (resetArmed){
        $("btnReset").textContent = "Hold to reset";
        $("btnReset").classList.add("danger");
      }
    }
    $("btnReset").addEventListener("pointerup", cancelHold);
    $("btnReset").addEventListener("pointerleave", cancelHold);
    $("btnReset").addEventListener("pointercancel", cancelHold);

    $("btnStart").onclick = ()=>{
      if (!api){ toast("engine not ready"); return; }
      const {lo,hi} = seed64();
      const mask = rulesMaskFromUI();
      sessionMs = 300000; // 5分（必要ならUI化）
      const sessionSeconds = (sessionMs/1000)|0;
      const roundLimit = 12;

      callAction("start_session", lo, hi, mask, sessionSeconds, roundLimit);

      // set_bet（偶数化）
      const bet = floorEven($("betInput").value);
      $("betInGame").value = bet;
      callAction("set_bet", bet);

      goScreen("game");
      startTick();
      toast("Good luck!");
    };

    $("btnSetBet").onclick = ()=>{
      const v = floorEven($("betInGame").value);
      $("betInGame").value = v;
      callAction("set_bet", v);
    };

    $("btnDeal").onclick = ()=> callAction("deal");
    $("btnHit").onclick = ()=> callAction("hit");
    $("btnStand").onclick = ()=> callAction("stand");
    $("btnDouble").onclick = ()=> callAction("double_down");
    $("btnSplit").onclick = ()=> callAction("split");
    $("btnSurrender").onclick = ()=> callAction("surrender");

    $("btnInsNo").onclick = ()=> callAction("buy_insurance", 0);
    $("btnInsBuy").onclick = ()=>{
      const v = floorEven($("insAmount").value);
      $("insAmount").value = v;
      callAction("buy_insurance", v);
    };
    $("btnEvenMoney").onclick = ()=> callAction("take_even_money");

  </script>

  <!-- build -->
<script src="blackjack.js"></script>
<script src="blackjack_ui.js"></script>

</body>
</html>
