<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlackJack</title>
<style>
* {
  box-sizing: border-box;
}

/* âœ¨ ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®é›°å›²æ°—ï¼ˆã‚«ã‚¸ãƒé¢¨ï¼‰ */
body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  padding: 24px 12px;
  background: radial-gradient(circle at top left, #388e3c 0%, #1b5e20 40%, #0b3d16 100%);
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-x: hidden;
}

/* ã‚¿ã‚¤ãƒˆãƒ«ã¯ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãªãƒ•ã‚©ãƒ³ãƒˆã§ */
h1 {
  font-family: "Georgia", "Times New Roman", serif;
  letter-spacing: 0.1em;
  font-size: 32px;
  margin: 0 0 24px;
}

/* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
#controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  margin-bottom: 20px;
}

/* ğŸ”´âš« ãƒœã‚¿ãƒ³å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆã‚«ã‚¸ãƒé¢¨ï¼‰ */
button {
  padding: 14px 32px;
  font-size: 18px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid #111;
  font-weight: 600;
  letter-spacing: 0.05em;
  box-shadow: 0 3px 0 rgba(0,0,0,0.7);
  transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.15s ease;
}

/* èµ¤ãƒœã‚¿ãƒ³ï¼ˆStart, Retryï¼‰ */
#init,
#retry {
  background: #b71c1c;
  color: #fff;
}

/* é»’ãƒœã‚¿ãƒ³ï¼ˆHit, Standï¼‰ */
#hit,
#stand {
  background: #111;
  color: #fff;
}

/* ãƒ›ãƒãƒ¼ï¼†æŠ¼ã—ãŸã¨ãã®æ¼”å‡º */
button:hover {
  transform: translateY(-1px);
  box-shadow: 0 5px 0 rgba(0,0,0,0.8);
}
button:active {
  transform: translateY(1px);
  box-shadow: 0 1px 0 rgba(0,0,0,0.6);
}

/* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã‚¨ãƒªã‚¢ */
#game {
  display: flex;
  justify-content: center;
  gap: 24px;
  flex-wrap: wrap;
  margin-top: 10px;
  width: 100%;
  max-width: 920px;
}

/* æ‰‹æœ­ã®æ ï¼ˆç™½ã„æ ï¼†ã¡ã‚‡ã„å½±ï¼‰ */
.hand {
  border: 2px solid rgba(255,255,255,0.9);
  padding: 12px;
  border-radius: 12px;
  width: 260px;
  margin: 6px;
  background: rgba(0,0,0,0.25);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.hand h3 {
  margin: 0;
  font-size: 18px;
}

/* ã‚«ãƒ¼ãƒ‰ãŒæ¨ªã«ä¸¦ã¶ã‚¨ãƒªã‚¢ */
.cards {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

/* ã‚«ãƒ¼ãƒ‰1æšã®è¦‹ãŸç›® */
.card {
  background: #fff;
  color: #000;
  text-align: center;
  border-radius: 6px;
  width: 52px;
  height: 72px;
  line-height: 72px;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}

/* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
#dealerScore,
#playerScore {
  margin-top: 8px;
  font-size: 14px;
}

/* ãƒ‡ãƒƒã‚­æ®‹æ•°ï¼†æˆ¦ç¸¾ */
#info {
  margin-top: 14px;
  text-align: center;
  font-size: 14px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.6);
}
#deckCount {
  margin-right: 12px;
}

/* çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä¸­å¤®ä¸Šéƒ¨ã«ãµã‚ã£ã¨ï¼‰ */
.result {
  display: none;
  position: fixed;
  top: 14%;
  left: 50%;
  transform: translateX(-50%);
  font-size: 26px;
  font-weight: bold;
  padding: 10px 24px;
  border-radius: 999px;
  background: rgba(0,0,0,0.55);
  color: #fff;
  pointer-events: none;
}

/* ---------- PCå‘ã‘ï¼ˆ601px ä»¥ä¸Šï¼‰ ---------- */
@media (min-width: 601px) {
  h1 {
    font-size: 32px;
  }

  .card {
    width: 60px;
    height: 90px;
    line-height: 90px;
    font-size: 22px;
  }
}

/* ---------- ã‚¹ãƒãƒ›å‘ã‘ï¼ˆ600px ä»¥ä¸‹ï¼‰ ---------- */
@media (max-width: 600px) {
  body {
    padding: 16px 8px;
  }

  h1 {
    font-size: 24px;
    margin-bottom: 16px;
  }

  #game {
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .hand {
    width: 95%;
  }

  .card {
    width: 40px;
    height: 60px;
    line-height: 60px;
    font-size: 16px;
  }

  /* ã‚¹ãƒãƒ›ã§ã¯ãƒœã‚¿ãƒ³ã‚’ç¸¦ã«ä¸¦ã¹ã¦å¤§ãã */
  #controls {
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  button {
    width: 100%;
    max-width: 320px;
    padding: 14px 0;
    font-size: 18px;
  }

  .result {
    font-size: 20px;
    top: 10%;
  }
}
</style>

</head>
<body>

<h1>BlackJack</h1>

<div id="result" class="result"></div>

<div id="controls">
  <button id="init">Start Game</button>
  <button id="hit">Hit</button>
  <button id="stand">Stand</button>
  <button id="retry" style="display: none;">Retry</button>
</div>

<div id="game">
  <div class="hand" id="dealer">
    <h3>Dealer</h3>
    <div class="cards" id="dealerCards"></div>
    <div id="dealerScore"></div>
  </div>
  <div class="hand" id="player">
    <h3>Player</h3>
    <div class="cards" id="playerCards"></div>
    <div id="playerScore"></div>
  </div>
</div>

<div id="info">
  <span id="deckCount"></span>
  <span id="stats"></span>
</div>

<pre id="output"></pre>

<script>
var Module = {
  onRuntimeInitialized: function() {
    let gameOver = false;        // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ•ãƒ©ã‚°
    let dealerRevealed = false;  // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼1æšç›®ã‚’ã‚ãã£ãŸã‹
    let wins = 0, losses = 0, draws = 0; // æˆ¦ç¸¾

    const init_game = Module.cwrap('init_game', null, []);
    const player_hit = Module.cwrap('player_hit', 'number', []);
    const player_stand_and_dealer = Module.cwrap('player_stand_and_dealer', 'number', []);
    const get_state_json = Module.cwrap('get_state_json', 'number', []);
    const free_ptr = Module.cwrap('free_ptr', null, ['number']);

    const dealerCards = document.getElementById('dealerCards');
    const playerCards = document.getElementById('playerCards');
    const dealerScore = document.getElementById('dealerScore');
    const playerScore = document.getElementById('playerScore');
    const result = document.getElementById('result');
    const retryBtn = document.getElementById('retry');
    const hitBtn = document.getElementById('hit');
    const standBtn = document.getElementById('stand');
    const initBtn = document.getElementById('init');
    const deckCountEl = document.getElementById('deckCount');
    const statsEl = document.getElementById('stats');

    function renderState() {
      let ptr = get_state_json();
      let jsonStr = Module.UTF8ToString(ptr);
      free_ptr(ptr);

      let state = JSON.parse(jsonStr);

      dealerCards.innerHTML = '';
      playerCards.innerHTML = '';

      // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ï¼š1æšç›®ã¯ stand ã™ã‚‹ã¾ã§ã€Œ?ã€
      const dealerArr = state.dealer.trim().split(' ').filter(c => c);
      dealerArr.forEach((c, idx) => {
        const div = document.createElement('div');
        div.className = 'card';
        if (!dealerRevealed && idx === 0) {
          div.textContent = '?';
        } else {
          div.textContent = c;
        }
        dealerCards.appendChild(div);
      });

      const playerArr = state.player.trim().split(' ').filter(c => c);
      playerArr.forEach(c => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = c;
        playerCards.appendChild(div);
      });

      dealerScore.textContent = 'Score: ' + state.dealerScore;
      playerScore.textContent = 'Score: ' + state.playerScore;

      // ãƒ‡ãƒƒã‚­æ®‹ã‚Šæšæ•°
      if (typeof state.deckSize === 'number') {
        deckCountEl.textContent = 'Deck: ' + state.deckSize + ' cards left';
      }
    }

    // çµæœè¡¨ç¤º
    function showMessage(text, type) {
      result.textContent = text;

      if (type === 'win') {
        result.style.color = '#ffeb3b';
      } else if (type === 'lose') {
        result.style.color = '#ffccbc';
      } else if (type === 'draw') {
        result.style.color = '#ffffff';
      } else if (type === 'bust') {
        result.style.color = '#ff8a80';
      } else {
        result.style.color = '#ffffff';
      }
    }

    function clearMessage() {
      result.textContent = '';
    }

    // æˆ¦ç¸¾æ›´æ–°
    function updateStats() {
      statsEl.textContent = `Win: ${wins} / Lose: ${losses} / Draw: ${draws}`;
    }

    // ã‚²ãƒ¼ãƒ çµ‚äº†çŠ¶æ…‹ã«ã™ã‚‹
    function setGameOver(resultType) {
      gameOver = true;
      hitBtn.disabled = true;
      standBtn.disabled = true;
      retryBtn.style.display = 'inline-block';

      if (resultType === 'win') wins++;
      else if (resultType === 'lose') losses++;
      else if (resultType === 'draw') draws++;

      updateStats();
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ãƒœã‚¿ãƒ³ãªã©ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetForNewGame() {
      gameOver = false;
      dealerRevealed = false;
      hitBtn.disabled = false;
      standBtn.disabled = false;
      retryBtn.style.display = 'none';
      clearMessage();
    }

    // Start Game & Retry å…±é€šã®å‡¦ç†
    function startNewGame() {
      init_game();
      resetForNewGame();
      renderState();
    }

    initBtn.onclick = startNewGame;
    retryBtn.onclick = startNewGame;

    // Hitï¼š21è¶…ãˆãŸã‚‰ Bustï¼ˆã“ã®æ™‚ç‚¹ã§ã¯ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã¯ã¾ã éš ã‚ŒãŸã¾ã¾ï¼‰
    hitBtn.onclick = () => {
      if (gameOver) return;

      const sc = player_hit();
      renderState();
      if (sc > 21) {
        showMessage("Bust! You lose...", "bust");
        setGameOver('lose');  // æˆ¦ç¸¾ä¸Šã¯ã€Œè² ã‘ã€
      }
    };

    // Standï¼šãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®1æšç›®ã‚’ã‚ãã£ã¦çµæœè¡¨ç¤º
    standBtn.onclick = () => {
      if (gameOver) return;

      dealerRevealed = true;  // â˜… ã“ã“ã§ã‚ãã‚‹
      const res = player_stand_and_dealer();
      renderState();

      let msg = "";
      let type = "";

      if (res >= 100 && res < 200) {
        msg = "Dealer Bust! You Win!";
        type = "win";
      } else if (res >= 200 && res < 300) {
        msg = "You Win!";
        type = "win";
      } else if (res >= 300 && res < 400) {
        msg = "You Lose...";
        type = "lose";
      } else {
        msg = "Draw.";
        type = "draw";
      }

      showMessage(msg, type);
      setGameOver(type);
    };

    // ãƒšãƒ¼ã‚¸é–‹ã„ãŸç›´å¾Œã¯ã¾ã ã‚²ãƒ¼ãƒ ãªã—ãªã®ã§ã€Start Game ã‚’æŠ¼ã—ã¦ã‚‚ã‚‰ã†
  }
};
</script>
<script src="blackjack.js"></script>

</body>
</html>
