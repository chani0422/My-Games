<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>BlackJack</title>

  <style>
    :root{
      --felt0:#071a10;
      --felt1:#0b3d1a;
      --felt2:#0f5a25;

      --rail0:#0b0b0c;
      --rail1:#17171a;

      --gold:#d8b15a;
      --gold2:#ffdf8a;

      --text:#ffffff;
      --muted:rgba(255,255,255,.78);
      --muted2:rgba(255,255,255,.56);

      --border:rgba(255,255,255,.14);
      --shadow:rgba(0,0,0,.45);

      --good:#37d67a;
      --bad:#ff4d4d;
      --warn:#ffcc66;

      --radius:18px;
      --dockH: 78px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      color:var(--text);
      overflow-x:hidden;

      /* casino ambience */
      background:
        radial-gradient(1400px 920px at 50% -25%, rgba(255,223,138,.22), transparent 62%),
        radial-gradient(980px 760px at 15% 10%, rgba(55,214,122,.12), transparent 62%),
        radial-gradient(980px 760px at 85% 12%, rgba(216,177,90,.12), transparent 64%),
        radial-gradient(1200px 900px at 50% 120%, rgba(0,0,0,.62), transparent 62%),
        linear-gradient(180deg, #03120a, #052414 40%, #07351a);
    }

    body::before, body::after{
      content:"";
      position:fixed; inset:-20%;
      pointer-events:none;
      z-index:-1;
    }
    body::before{
      background:
        radial-gradient(620px 420px at 12% 28%, rgba(255,223,138,.10), transparent 60%),
        radial-gradient(620px 420px at 88% 32%, rgba(255,255,255,.06), transparent 62%),
        radial-gradient(520px 420px at 48% 5%, rgba(216,177,90,.08), transparent 62%);
      filter: blur(1px);
      animation: sweep 10s ease-in-out infinite alternate;
      opacity:.9;
    }
    body::after{
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, transparent 1px, transparent 2px);
      mix-blend-mode: overlay;
      opacity:.10;
    }
    @keyframes sweep{
      from{ transform: translate3d(-2%, -1%, 0) scale(1.02) }
      to  { transform: translate3d( 2%,  1%, 0) scale(1.04) }
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
      padding-bottom: calc(var(--dockH) + 34px);
    }

    /* ===== HUD ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
      border-radius: calc(var(--radius) + 4px);
      box-shadow: 0 22px 70px rgba(0,0,0,.28);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0}
    .logo{
      width:38px; height:38px; border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.06)),
        linear-gradient(135deg, rgba(255,223,138,.95), rgba(216,177,90,.55)),
        linear-gradient(225deg, rgba(55,214,122,.55), rgba(0,0,0,0));
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-60% -40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
      transform: rotate(20deg);
      animation: shine 2.8s ease-in-out infinite;
      opacity:.9;
    }
    @keyframes shine{
      0%{ transform: translateX(-40%) rotate(20deg) }
      45%{ transform: translateX(60%) rotate(20deg) }
      100%{ transform: translateX(60%) rotate(20deg) }
    }

    .brandTxt{min-width:0}
    .brandTxt h1{
      margin:0;
      font-size:14px;
      letter-spacing:.14em;
      font-weight: 950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    .sub{
      font-size:12px;
      color:var(--muted2);
      margin-top:2px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .statusBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(216,177,90,.35);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      box-shadow: 0 16px 50px rgba(0,0,0,.25);
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.08em;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 0 rgba(255,223,138,.0);
    }
    .statusBadge.good{ border-color: rgba(55,214,122,.40); color:#d8ffe7; }
    .statusBadge.good .dot{ background: rgba(55,214,122,.85); box-shadow: 0 0 0 10px rgba(55,214,122,.12); }
    .statusBadge.bad{ border-color: rgba(255,77,77,.40); color:#ffd1d1; }
    .statusBadge.bad .dot{ background: rgba(255,77,77,.85); box-shadow: 0 0 0 10px rgba(255,77,77,.12); }

    .stats{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .pill{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(0,0,0,.20);
      min-width: 140px;
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
    }
    .pill span{font-size:12px;color:var(--muted)}
    .pill b{font-size:13px; letter-spacing:.02em}
    .pill.bank{
      border-color: rgba(216,177,90,.35);
      background:
        radial-gradient(120px 70px at 10% 0%, rgba(255,223,138,.18), transparent 60%),
        rgba(0,0,0,.20);
    }
    .bankFlash{ animation: bankFlash .35s ease; }
    @keyframes bankFlash{
      from{ transform: translateY(-1px) scale(1.01); filter: brightness(1.25) }
      to{ transform:none; filter:none }
    }

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
      box-shadow: 0 14px 35px rgba(0,0,0,.25);
      font-weight: 900;
      letter-spacing:.06em;
    }
    .btn:hover{ box-shadow: 0 22px 60px rgba(0,0,0,.32); filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn[disabled]{ opacity:.40; cursor:not-allowed; box-shadow:none; filter:saturate(.2); }
    .btn.primary{
      border-color: rgba(216,177,90,.45);
      background:
        radial-gradient(160px 70px at 50% 0%, rgba(255,223,138,.40), transparent 65%),
        linear-gradient(180deg, rgba(216,177,90,.18), rgba(0,0,0,.18));
      box-shadow: 0 26px 85px rgba(216,177,90,.20), 0 24px 55px rgba(0,0,0,.35);
    }
    .btn.danger{
      border-color: rgba(255,77,77,.35);
      background: linear-gradient(180deg, rgba(255,77,77,.18), rgba(0,0,0,.18));
    }
    .btn.ghost{ background: rgba(0,0,0,.16); }

    /* ===== Layout ===== */
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .pill{ min-width:auto; }
    }

    .card{
      border:1px solid var(--border);
      background:
        radial-gradient(1200px 500px at 30% -10%, rgba(255,223,138,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.22));
      border-radius: var(--radius);
      box-shadow: 0 28px 90px rgba(0,0,0,.25);
      overflow:hidden;
      position:relative;
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .card .hd h2{
      margin:0;
      font-size:13px;
      letter-spacing:.16em;
      font-weight: 950;
    }
    .card .bd{ padding:14px; }

    .muted{ color: var(--muted); font-size:12px; }
    .small{ font-size:12px; color: var(--muted2); }
    .divider{ height:1px; background: rgba(255,255,255,.12); margin:12px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    input[type="number"]{
      width: 160px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      box-shadow: 0 18px 45px rgba(0,0,0,.20);
      font-weight: 800;
      letter-spacing:.02em;
    }

    /* chips = aligned (â‘¢A) */
    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start }
    .chipbtn{
      border:1px solid rgba(216,177,90,.35);
      background:
        radial-gradient(70px 40px at 30% 25%, rgba(255,223,138,.26), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      color:var(--text);
      font-weight: 950;
      letter-spacing:.06em;
      box-shadow: 0 20px 55px rgba(0,0,0,.20);
      transition: transform .08s ease, filter .15s ease;
    }
    .chipbtn:hover{ filter: brightness(1.06) }
    .chipbtn:active{ transform: translateY(1px) scale(.99) }

    /* ===== Screens ===== */
    .screen{ display:none; animation: fadeIn .20s ease; }
    .screen.active{ display:block; }
    @keyframes fadeIn{
      from{ opacity:.5; transform: translateY(8px) }
      to{ opacity:1; transform:none }
    }

    /* ===== Title hero ===== */
    .titleHero{
      padding:22px 16px;
      text-align:center;
      position:relative;
    }
    .titleHero .chipline{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(216,177,90,.35);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-weight:900;
      letter-spacing:.06em;
    }
    .titleHero h2{
      margin:12px 0 6px;
      font-size:28px;
      letter-spacing:.02em;
      font-weight: 950;
      text-shadow: 0 22px 60px rgba(0,0,0,.35);
    }
    .titleHero p{ margin:0; color: var(--muted); }

    .ctaRow{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .ctaBig{
      min-width: 260px;
      height: 54px;
      border-radius: 18px;
      font-size: 14px;
      letter-spacing:.14em;
    }

    /* ===== Options ===== */
    .optGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 560px){ .optGrid{grid-template-columns:1fr} }
    .opt{
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background: rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .opt label{display:flex; gap:10px; align-items:center; cursor:pointer; width:100%}
    .opt input{ transform: scale(1.1) }

    /* ===== Casino Table (â˜…ã“ã“ãŒè¦‹ãŸç›®ã®æœ¬ä½“) ===== */
    .tableStage{
      perspective: 900px; /* â‘ B: moderate */
    }
    .tableTilt{
      transform: rotateX(12deg); /* â‘ B */
      transform-origin: 50% 20%;
    }

    .tableFrame{
      padding:14px;
      border-radius: 28px 28px 380px 380px; /* â‘¡A: half-ish */
      background:
        radial-gradient(1200px 500px at 50% 0%, rgba(255,223,138,.08), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.20));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 40px 90px rgba(0,0,0,.32);
      position:relative;
      overflow:hidden;
    }

    /* matte black rail */
    .tableFrame::before{
      content:"";
      position:absolute; inset:0;
      border-radius: inherit;
      padding: 14px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.65));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
    /* è¿½åŠ ï¼ˆæ¨™æº–ï¼‰ */
  mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  mask-composite: exclude;
              mask-composite: exclude;
      opacity:.95;
      pointer-events:none;
    }
    .tableFrame::after{
      /* subtle stitched highlight */
      content:"";
      position:absolute;
      inset:10px 10px 18px 10px;
      border-radius: 22px 22px 360px 360px;
      border: 1px dashed rgba(255,255,255,.10);
      opacity:.55;
      pointer-events:none;
    }

    .tableSurface{
      position:relative;
      border-radius: 18px 18px 340px 340px;
      overflow:hidden;
      min-height: 520px;
      background:
        radial-gradient(900px 520px at 50% -20%, rgba(255,255,255,.10), transparent 62%),
        radial-gradient(900px 520px at 10% 10%, rgba(255,223,138,.06), transparent 62%),
        radial-gradient(900px 520px at 90% 12%, rgba(55,214,122,.06), transparent 64%),
        linear-gradient(180deg, var(--felt0), var(--felt1) 45%, var(--felt2));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 0 0 1px rgba(0,0,0,.30) inset;
    }

    /* felt grain */
    .tableSurface::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.015), rgba(255,255,255,.015) 1px, transparent 1px, transparent 3px),
        radial-gradient(1200px 700px at 50% 120%, rgba(0,0,0,.25), transparent 62%);
      mix-blend-mode: overlay;
      opacity:.25;
      pointer-events:none;
    }

    /* Markings: â‘¡C (B + small rule text) but keep moderate overall (â‘¤B) */
    .markings{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.82;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.20));
    }
    .markText{
      fill: rgba(255,255,255,.78);
      font-weight: 900;
      letter-spacing: .18em;
    }
    .markSmall{
      fill: rgba(255,255,255,.48);
      font-weight: 800;
      letter-spacing: .14em;
    }
    .markLine{
      stroke: rgba(255,255,255,.32);
      stroke-width: 2.2;
      fill:none;
    }
    .markDots{
      stroke: rgba(255,223,138,.18);
      stroke-width: 2;
      stroke-dasharray: 3 10;
      fill:none;
    }

    /* Zones on table */
    .dealerZone{
      position:absolute;
      top: 38px;
      left: 50%;
      transform: translateX(-50%);
      width: min(720px, 92%);
    }
    .playerZone{
      position:absolute;
      left: 50%;
      bottom: 46px;
      transform: translateX(-50%);
      width: min(860px, 94%);
    }

    /* boxes */
    .handBox{
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.18);
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
      box-shadow: 0 18px 55px rgba(0,0,0,.16);
      backdrop-filter: blur(2px);
    }
    .handBox.active{
      border-color: rgba(55,214,122,.55);
      box-shadow:
        0 0 0 2px rgba(55,214,122,.12) inset,
        0 26px 70px rgba(0,0,0,.25);
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .handArea{ display:flex; flex-direction:column; gap:12px }

    .cards{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* card look: â‘§A (photo-ish) */
    .cardFace, .cardBack{
      width: 48px;
      height: 68px;
      border-radius: 13px;
      box-shadow: 0 16px 30px rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      letter-spacing:.02em;
      user-select:none;
      position:relative;
      overflow:hidden;
      transform: translate3d(0,0,0);
    }
    .cardFace{
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.90), rgba(255,255,255,.62)),
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      color:#0e0e10;
      border-color: rgba(0,0,0,.10);
    }
    .cardFace::after{
      content:"";
      position:absolute;
      inset:-30% -40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      transform: rotate(22deg);
      opacity:.55;
      pointer-events:none;
    }

    .cardBack{
      background:
        radial-gradient(circle at 25% 25%, rgba(255,255,255,.32), transparent 60%),
        linear-gradient(135deg, rgba(255,223,138,.60), rgba(216,177,90,.22)),
        linear-gradient(225deg, rgba(55,214,122,.38), rgba(0,0,0,0));
      border-color: rgba(216,177,90,.28);
    }
    .cardBack::before{
      /* back pattern */
      content:"";
      position:absolute; inset:10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.22);
      background:
        repeating-linear-gradient(45deg, rgba(255,255,255,.10) 0 6px, transparent 6px 12px),
        radial-gradient(circle at 50% 50%, rgba(0,0,0,.10), transparent 62%);
      opacity:.85;
    }

    /* â‘£A: slide deal + flip (no extra spin/glow) */
    .dealIn{
      animation: dealIn .42s cubic-bezier(.2,.8,.2,1) both;
    }
    @keyframes dealIn{
      from{ opacity:0; transform: translate(120px,-60px) rotate(-8deg) scale(.95); filter: blur(.35px) }
      to{ opacity:1; transform:none; filter:none }
    }
    .flipIn{
      animation: flipIn .46s cubic-bezier(.2,.8,.2,1) both;
      transform-origin: center;
    }
    @keyframes flipIn{
      0%{ transform: rotateY(0deg) }
      50%{ transform: rotateY(90deg); filter: brightness(1.10) }
      100%{ transform: rotateY(0deg); filter:none }
    }

    .badge{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.06em;
    }
    .badge.good{ border-color: rgba(55,214,122,.35); color:#d8ffe7 }
    .badge.bad{ border-color: rgba(255,77,77,.35); color:#ffd1d1 }

    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      box-shadow: 0 20px 60px rgba(0,0,0,.20);
    }
    .banner .msg{ font-weight: 950; letter-spacing:.10em; }
    .banner .msg.win{ color:#d8ffe7 }
    .banner .msg.lose{ color:#ffd1d1 }
    .banner .msg.neutral{ color:#fff1cc }

    /* ===== Dock (â‘©A) ===== */
    .dock{
      position:fixed;
      left: 12px;
      right: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      height: var(--dockH);
      display:grid;
      grid-template-columns: 1.25fr 1fr 1fr .95fr;
      gap:10px;
      padding:10px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.25));
      backdrop-filter: blur(14px);
      box-shadow: 0 40px 90px rgba(0,0,0,.45);
      z-index: 30;
    }
    .dock .btn{
      height:100%;
      border-radius: 18px;
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:0 12px;
    }
    .dock .btn .k{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      letter-spacing:.12em;
      padding: 3px 8px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
    }

    /* ===== Overlays ===== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:60;
      backdrop-filter: blur(10px);
    }
    .overlay.show{ display:flex }
    .modal{
      width:min(620px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 400px at 20% -20%, rgba(255,223,138,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.34));
      box-shadow: 0 30px 90px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modal .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(0,0,0,.16);
    }
    .modal .bd{ padding:14px; }
    .actionsGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top: 10px;
    }
    .actionsGrid .btn{ width:100% }

    /* Toast */
    .toastWrap{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom: calc(var(--dockH) + 18px + env(safe-area-inset-bottom, 0px));
      display:flex; flex-direction:column; gap:8px;
      z-index:99;
      pointer-events:none;
    }
    .toast{
      pointer-events:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.62);
      color:#fff;
      box-shadow:0 18px 50px rgba(0,0,0,.28);
      font-size:13px;
      max-width:min(640px, calc(100vw - 24px));
    }

    /* Hold progress */
    .prog{
      height:8px; border-radius:999px; background: rgba(255,255,255,.12);
      overflow:hidden; border:1px solid rgba(255,255,255,.10);
      margin-top:8px;
    }
    .prog > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,223,138,.95), rgba(55,214,122,.90));
    }
    /* =========================
   VISIBILITY FIX PACK
   - sharper text
   - markings behind content
   - content stays inside frame
   ========================= */

/* æ–‡å­—ã®æ»²ã¿ã‚’æ¸›ã‚‰ã™ï¼ˆå…¨ä½“ï¼‰ */
body{
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: geometricPrecision;
}

/* 3Då¤‰å½¢ãŒãƒ†ã‚­ã‚¹ãƒˆã‚’æ»²ã¾ã›ã‚‹ã®ã§ä¸€æ—¦OFFï¼ˆæœ€å„ªå…ˆã§è¦‹ã‚„ã™ãã™ã‚‹ï¼‰ */
.tableStage{ perspective: none !important; }
.tableTilt{ transform: none !important; }

/* ãƒãƒ¼ã‚­ãƒ³ã‚°ãŒâ€œä¸Šã«è¢«ã£ã¦ã‚‹â€ã®ãŒæœ€å¤§ã®è¦‹ã¥ã‚‰ã•ï¼šèƒŒé¢ã¸ */
.tableSurface{ position: relative; }
.markings{
  z-index: 0 !important;
  filter: none !important;      /* drop-shadow ãŒæ»²ã¿ã‚„ã™ã„ */
  opacity: .60 !important;      /* æ§ãˆã‚ã« */
  pointer-events: none;
}

/* å®Ÿã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆDealer/Playerï¼‰ã¯å‰é¢ã¸ */
.dealerZone, .playerZone{
  z-index: 2 !important;
}

/* absoluteé…ç½®ã ã¨ä¸¸æ ã§è¦‹åˆ‡ã‚ŒãŒã¡ â†’ é€šå¸¸ãƒ•ãƒ­ãƒ¼ + paddingã§ä¸­ã«åã‚ã‚‹ */
.tableSurface{
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between !important;
  gap: 18px !important;

  /* æ å†…ã«åã‚ã‚‹ãŸã‚ã®â€œå®‰å…¨åœ°å¸¯â€ */
  padding: 64px 44px 120px !important;

  /* ä¸¸æ ã«åˆã‚ã›ã¦ä¸­èº«ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã« */
  overflow: hidden;
}

/* absolute ã‚’è§£é™¤ã—ã¦ã‚»ãƒ³ã‚¿ãƒ¼ã«åã‚ã‚‹ */
.dealerZone, .playerZone{
  position: relative !important;
  top: auto !important; bottom: auto !important; left: auto !important;
  transform: none !important;              /* translateX(-50%)ã‚’è§£é™¤ */
  width: 100% !important;
  margin: 0 auto !important;
}
.dealerZone{ max-width: 760px !important; }
.playerZone{ max-width: 920px !important; }

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›²ç‡ãŒå¼·ã™ãã‚‹ã¨è¦‹åˆ‡ã‚Œã‚„ã™ã„ â†’ å°‘ã—ç·©ã‚ã‚‹ */
.tableFrame{
  border-radius: 28px 28px 280px 280px !important;
}
.tableSurface{
  border-radius: 18px 18px 240px 240px !important;
  min-height: 620px !important;            /* ä½™ç™½ä¸è¶³ã«ã‚ˆã‚‹ä¸‹åˆ‡ã‚Œã‚’é˜²ã */
}

/* backdrop-filter ãŒæ–‡å­—ã‚’æ»²ã¾ã›ã‚‹æ™‚ãŒã‚ã‚‹ã®ã§ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã¯åˆ‡ã‚‹ */
.handBox{
  backdrop-filter: none !important;
}

/* å°ã•ã„æ–‡å­—ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆUP */
.muted{ color: rgba(255,255,255,.88) !important; }
.small{ color: rgba(255,255,255,.72) !important; }
.badge{ color: rgba(255,255,255,.84) !important; }

/* ã‚«ãƒ¼ãƒ‰é ˜åŸŸãŒä¸‹ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«å¾®èª¿æ•´ */
.playerZone .cards{ padding-bottom: 6px !important; }

.morePanel{
  display:block;
  margin-top:10px;
  padding:12px;
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
}
.moreHd{ opacity:.9; }
.moreGrid .btn{ font-weight:800; letter-spacing:.02em; }


.moreHd{
  font-weight:900;
  letter-spacing:.06em;
  font-size:12px;
  opacity:.92;
  margin-bottom:10px;
}
.moreGrid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:10px;
}
.moreGrid .btn{ width:100%; }

.metaLine{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.kv{
  display:inline-flex;
  align-items:baseline;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.18);
}
.kv .k{ font-size:11px; color:rgba(255,255,255,.78); letter-spacing:.04em; }
.kv .v{ font-size:14px; font-weight:900; color:#fff; }
#btnMore{ display:none; }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandTxt">
          <h1>BLACKJACK</h1>
          <div class="sub">
            <span id="subLine">bootingâ€¦</span>
            <span id="engineBadge" class="statusBadge"><span class="dot"></span><span id="engineText">LOADING</span></span>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="pill bank"><span>Bank</span><b id="bank">-</b></div>
        <div class="pill"><span>Round</span><b id="round">-</b></div>
        <div class="pill"><span>Time</span><b id="time">-</b></div>

        <button class="btn ghost" id="btnPause" title="Menu">MENU</button>
        <button class="btn danger" id="btnReset" title="Hold to reset">Reset</button>
      </div>
    </div>

    <!-- TITLE -->
    <div class="screen active" id="screenTitle">
      <div class="card">
        <div class="titleHero">
          <div class="chipline">ğŸ° BLACKJACK PAYS 3 TO 2 â€¢ INSURANCE PAYS 2 TO 1</div>
          <h2>One moreâ€¦ ãŒæ­¢ã¾ã‚‰ãªã„ Blackjack</h2>
          <p>é…å¸ƒã¯æ°—æŒã¡ã‚ˆãã€‚å‹ã£ãŸã‚‰BankãŒã¬ã‚‹ã£ã¨ä¼¸ã³ã‚‹ã€‚</p>

          <div class="ctaRow">
            <button class="btn primary ctaBig" id="btnStart" disabled>DEAL / START</button>
            <button class="btn ghost" id="btnHowTitle">éŠã³æ–¹</button>
          </div>
        </div>

        <div class="bd">
          <div class="row" style="justify-content:space-between; align-items:flex-end;">
            <div>
              <div class="muted">Betï¼ˆå¶æ•°æ¨å¥¨ï¼šInsurance = bet/2 ã§ç«¯æ•°å›é¿ï¼‰</div>
              <div class="row" style="margin-top:8px;">
                <input id="betInput" type="number" value="100" step="10" min="10">
                <div class="chips">
                  <button class="chipbtn" data-add="10">+10</button>
                  <button class="chipbtn" data-add="50">+50</button>
                  <button class="chipbtn" data-add="100">+100</button>
                  <button class="chipbtn" data-add="200">+200</button>
                </div>
              </div>
              <div class="muted" id="betHint" style="margin-top:6px;"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted">Optionsï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã§ON/OFFï¼‰</div>
          <div class="optGrid">
            <div class="opt"><label><input type="checkbox" id="optDouble" checked> Double Down</label></div>
            <div class="opt"><label><input type="checkbox" id="optSplit" checked> Split</label></div>
            <div class="opt"><label><input type="checkbox" id="optSurrender" checked> Surrender (Late)</label></div>
            <div class="opt"><label><input type="checkbox" id="optInsurance" checked> Insurance</label></div>
            <div class="opt"><label><input type="checkbox" id="optEvenMoney" checked> Even Money</label></div>
            <div class="opt"><label><input type="checkbox" id="optDAS" checked> DAS</label></div>
            <div class="opt"><label><input type="checkbox" id="optSplitBJ" checked> Split BJ as BJ</label></div>
            <div class="opt"><label><input type="checkbox" id="optH17" checked> Dealer hits Soft 17</label></div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between">
            <div class="small">Tipsï¼šReset ã¯ã€Œ1å›ã‚¿ãƒƒãƒ—ã§æ­¦è£… â†’ 2ç§’é•·æŠ¼ã—ã€ã§å®Ÿè¡Œ</div>
            <button class="btn" id="btnHowTitle2">ãƒãƒ¼ã‚­ãƒ³ã‚°/æ“ä½œ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div class="screen" id="screenGame">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2>CASINO TABLE</h2>
            <div class="badge" id="phaseBadge">-</div>
          </div>
          <div class="bd">
            <div class="tableStage">
              <div class="tableTilt">
                <div class="tableFrame">
                  <div class="tableSurface">

                    <!-- Markings (â‘¡C) -->
                    <svg class="markings" viewBox="0 0 1000 650" preserveAspectRatio="none">
                      <path id="arcPayout" d="M140,510 C260,600 740,600 860,510" />
                      <path id="arcInner"  d="M210,475 C320,555 680,555 790,475" />
                      <path class="markLine" d="M160,515 C280,610 720,610 840,515" />
                      <path class="markDots" d="M210,478 C320,558 680,558 790,478" />

                      <text font-size="28" class="markText">
                        <textPath href="#arcPayout" startOffset="50%" text-anchor="middle">
                          BLACKJACK PAYS 3 TO 2
                        </textPath>
                      </text>

                      <text font-size="20" class="markText" style="letter-spacing:.22em;">
                        <textPath href="#arcInner" startOffset="50%" text-anchor="middle">
                          INSURANCE PAYS 2 TO 1
                        </textPath>
                      </text>

                      <!-- Small rules line -->
                      <text x="500" y="100" text-anchor="middle" font-size="20" class="markSmall">
                        DEALER MUST DRAW TO 16 AND STAND ON 17 â€¢ 6 DECKS â€¢ HOUSE RULES APPLY
                      </text>
                    </svg>

                    <!-- Dealer -->
                    <div class="dealerZone">
                      <div class="handBox" id="dealerBox">
                        <div class="row" style="justify-content:space-between;">
                          <div>
                            <b>Dealer</b>
                            <span class="muted" id="dealerScoreLine"></span>
                          </div>
                          <div class="badge" id="dealerHole">-</div>
                        </div>
                        <div class="cards" id="dealerCards"></div>
                      </div>
                    </div>

                    <!-- Player -->
                    <div class="playerZone">
                      <div class="handArea" id="playerHands"></div>

                      <div class="banner" id="roundBanner" style="display:none;">
                        <div class="msg neutral" id="roundMsg">-</div>
                        <div class="muted" id="roundMeta">-</div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div><!-- /tableStage -->
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>BET / INFO</h2>
            <div class="badge" id="rulesMini">-</div>
          </div>
          <div class="bd">
            <div class="row">
              <div class="muted">Bet</div>
              <input id="betInGame" type="number" value="100" step="10">
              <button class="btn" id="btnSetBet">SET</button>
            </div>

            <div class="row chips" style="margin-top:10px;">
              <button class="chipbtn" data-add2="10">+10</button>
              <button class="chipbtn" data-add2="50">+50</button>
              <button class="chipbtn" data-add2="100">+100</button>
              <button class="chipbtn" data-add2="200">+200</button>
            </div>

            <div class="divider"></div>

            <div class="row" style="justify-content:space-between;">
              <div class="muted">Main actions are in DOCK</div>
              <button class="btn ghost" id="btnMore" disabled>MORE</button>
              <div id="morePanel" class="morePanel">
  <div class="moreHd">More actions</div>
  <div class="moreGrid">
    <button class="btn" id="btnDoubleSide">Double</button>
    <button class="btn" id="btnSplitSide">Split</button>
    <button class="btn danger" id="btnSurrenderSide">Surrender</button>
    <button class="btn" id="btnEvenMoneySide">Even Money</button>
  </div>
  <div class="muted small" style="margin-top:8px;">
    â€»æŠ¼ã›ã‚‹å ´åˆã«é™ã‚Šæ©Ÿèƒ½ã—ã¾ã™ã€‚
  </div>
</div>

            </div>

            <div class="divider"></div>

            <div class="small" id="debugLine">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Dock -->
  <nav class="dock" aria-label="main controls">
    <button class="btn primary" id="btnDeal" disabled>DEAL <span class="k">D</span></button>
    <button class="btn" id="btnHit" disabled>HIT <span class="k">H</span></button>
    <button class="btn" id="btnStand" disabled>STAND <span class="k">S</span></button>
    <button class="btn ghost" id="btnDockMore" disabled>MORE <span class="k">M</span></button>
  </nav>

  <!-- OVERLAYS -->
  <div class="overlay" id="overlayPause">
    <div class="modal">
      <div class="hd">
        <b>PAUSED</b>
        <button class="btn ghost" id="btnClosePause">Close</button>
      </div>
      <div class="bd">
        <p class="muted" style="margin-top:0;">
          ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯çµ‚äº†ã—ã¾ã›ã‚“ã€‚<b>Continue</b>ã§å¾©å¸°ã€<b>Quit</b>ã§ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Œã¾ã™ã€‚
        </p>
        <div class="row" style="justify-content:flex-end; gap:10px;">
          <button class="btn" id="btnHowPause">éŠã³æ–¹</button>
          <button class="btn primary" id="btnContinue">Continue</button>
          <button class="btn danger" id="btnQuit">Quit to Title</button>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlayHow">
    <div class="modal">
      <div class="hd">
        <b>HOW TO PLAY</b>
        <button class="btn ghost" id="btnCloseHow">Close</button>
      </div>
      <div class="bd">
        <div class="muted">
          <ul>
            <li>ç›®æ¨™ï¼š<b>21ã«è¿‘ã¥ã‘ã‚‹</b>ï¼ˆ21è¶…ãˆã¯Bustï¼‰</li>
            <li>10/J/Q/Kã¯<b>å…¨éƒ¨10æ‰±ã„</b>ã€Aã¯<b>1 or 11</b></li>
            <li><b>DEAL</b>ã§é–‹å§‹ï¼ˆRoundOverä¸­ã¯æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚€ï¼‰</li>
            <li><b>Double</b>ï¼šåŒé¡è¿½åŠ â†’1å›Hitã§å¼·åˆ¶çµ‚äº†</li>
            <li><b>Split</b>ï¼šåŒâ€œç‚¹æ•°â€ãªã‚‰OKã€‚Aã‚¹ãƒ—ãƒªãƒƒãƒˆã¯1æšã§çµ‚äº†</li>
            <li><b>Surrender</b>ï¼šæœ€åˆã®2æšã®ã¿ã€‚æ›ã‘é‡‘ã®åŠåˆ†ãŒè¿”ã‚‹ï¼ˆLateï¼peekå¾Œï¼‰</li>
            <li><b>Insurance</b>ï¼šãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼è¡¨ãŒAã®æ™‚ã®ã¿ã€‚æœ€å¤§ bet/2</li>
            <li><b>Even Money</b>ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼BJæ™‚ã«æç¤º</li>
          </ul>
          <p>â€»æ“ä½œå¯å¦ã¯C++ãŒè¿”ã™ <b>state.can</b> ãŒçœŸå®Ÿã€‚ãƒœã‚¿ãƒ³ã¯è‡ªå‹•ã§ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚</p>
        </div>
      </div>
    </div>
  </div>

  <!-- MORE overlay (Advanced actions + Insurance) -->
  <div class="overlay" id="overlayMore">
    <div class="modal">
      <div class="hd">
        <b>MORE / ACTIONS</b>
        <button class="btn ghost" id="btnCloseMore">Close</button>
      </div>
      <div class="bd">
        <div class="muted">åŸºæœ¬ã¯ä¸‹ã®DOCKã§OKã€‚ã“ã“ã¯â€œç‰¹æ®Šæ‰‹â€ã ã‘ã€‚</div>

        <div class="actionsGrid">
          <button class="btn" id="btnDouble">Double</button>
          <button class="btn" id="btnSplit">Split</button>
          <button class="btn" id="btnSurrender">Surrender</button>
          <button class="btn ghost" id="btnOpenHow">How</button>
        </div>

        <div class="divider"></div>

        <div class="handBox" id="insuranceBox" style="display:none;">
          <div class="row" style="justify-content:space-between;">
            <b>Insurance</b>
            <span class="muted" id="insHint">-</span>
          </div>
          <div class="row" style="margin-top:10px;">
            <input id="insAmount" type="number" value="0" step="2" min="0">
            <button class="btn" id="btnInsBuy">BUY</button>
            <button class="btn" id="btnInsNo">NO</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button class="btn" id="btnEvenMoney">Even Money</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toastWrap" id="toastWrap"></div>

  <script>
    // ========= Utilities =========
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const w = $("toastWrap");
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = msg;
      w.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, 1400);
      setTimeout(()=>{ el.remove(); }, 1900);
    }

    function seed64(){
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return {lo: a[0] >>> 0, hi: a[1] >>> 0};
    }

    function floorEven(x){
      x = Number(x||0);
      if (!Number.isFinite(x)) x = 0;
      if (x < 0) x = 0;
      return Math.floor(x/2)*2;
    }

    function fmtTime(ms){
      ms = Math.max(0, ms|0);
      const s = Math.ceil(ms/1000);
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    function setEngineBadge(text, kind){
      const b = $("engineBadge");
      const t = $("engineText");
      t.textContent = text;
      b.classList.remove("good","bad");
      if (kind) b.classList.add(kind);
    }

    function animateNumber(el, from, to, duration=520){
      from = Number(from); to = Number(to);
      if (!Number.isFinite(from)) from = 0;
      if (!Number.isFinite(to)) to = 0;
      if (from === to){ el.textContent = String(to); return; }
      const start = performance.now();
      const diff = to - from;
      const ease = (x)=> 1 - Math.pow(1-x, 3);
      const step = (now)=>{
        const t = Math.min(1, (now - start) / duration);
        const v = Math.round(from + diff * ease(t));
        el.textContent = String(v);
        if (t < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    // ========= Engine bjApi =========
    // blackjack_ui.js å´ã§ Engine / engineReady / bjApi ã‚’ç”¨æ„ã—ã¦ã„ã‚‹æƒ³å®š
    let Engine = null;
    let bjApi = null;
    let state = null;

function apiReady(){
  if (globalThis.bjApi) bjApi = globalThis.bjApi;
  if (globalThis.Engine) Engine = globalThis.Engine;
  return !!(globalThis.engineReady && Engine && bjApi);
}


    function syncEngine(){
      if (apiReady()){
        // Engine = window.Engine;
        // bjApi = window.bjApi;

        setEngineBadge("READY", "good");
        $("subLine").textContent = "ready.";
        $("btnStart").disabled = false;
        $("btnMore").disabled = false;
        $("btnDockMore").disabled = false;

        toast("Engine ready!");
        return;
      }
      setEngineBadge("LOADING", null);
      $("subLine").textContent = "loading engineâ€¦";
      requestAnimationFrame(syncEngine);
    }

    // ========= timer =========
    let sessionMs = 300000;
    let startTickAt = 0;
    let pausedAt = 0;
    let pausedTotal = 0;
    let tickHandle = null;
    let lastTimePush = 0;

    function startTick(){
      stopTick();
      startTickAt = performance.now();
      pausedTotal = 0;
      pausedAt = 0;
      lastTimePush = 0;
      tickHandle = setInterval(()=>{
        if (!state) return;
        if (state.phase === "paused") return;

        const now = performance.now();
        const elapsed = now - startTickAt - pausedTotal;
        const left = Math.max(0, sessionMs - elapsed);

        if (now - lastTimePush > 1000){
          bjApi.set_time_left_ms(left|0);
          lastTimePush = now;
          refresh();
        } else {
          $("time").textContent = fmtTime(left|0);
        }
      }, 120);
    }

    function stopTick(){
      if (tickHandle){ clearInterval(tickHandle); tickHandle = null; }
    }

    function rulesMaskFromUI(){
      const RB_ALLOW_DOUBLE      = 1 << 0;
      const RB_ALLOW_SPLIT       = 1 << 1;
      const RB_ALLOW_SURRENDER   = 1 << 2;
      const RB_ALLOW_INSURANCE   = 1 << 3;
      const RB_ALLOW_EVEN_MONEY  = 1 << 4;
      const RB_ALLOW_DAS         = 1 << 5;
      const RB_SPLIT_BJ_AS_BJ    = 1 << 6;
      const RB_DEALER_HIT_S17    = 1 << 7;

      let m = 0;
      if ($("optDouble").checked)   m |= RB_ALLOW_DOUBLE;
      if ($("optSplit").checked)    m |= RB_ALLOW_SPLIT;
      if ($("optSurrender").checked)m |= RB_ALLOW_SURRENDER;
      if ($("optInsurance").checked)m |= RB_ALLOW_INSURANCE;
      if ($("optEvenMoney").checked)m |= RB_ALLOW_EVEN_MONEY;
      if ($("optDAS").checked)      m |= RB_ALLOW_DAS;
      if ($("optSplitBJ").checked)  m |= RB_SPLIT_BJ_AS_BJ;
      if ($("optH17").checked)      m |= RB_DEALER_HIT_S17;
      return m >>> 0;
    }

    function refresh(){
      if (!bjApi) return;
      const p = bjApi.get_state_json();
      const s = Engine.UTF8ToString(p);
      bjApi.free_ptr(p);
      state = JSON.parse(s);
      render();
      return state;
    }

    function callAction(fnName, ...args){
      const rc = bjApi[fnName](...args);
      const st = refresh();
      if (rc !== 0 || st.lastErrorCode !== 0){
        if (st.lastError) toast(st.lastError);
        console.warn("action", fnName, "rc=", rc, "err=", st.lastErrorCode, st.lastError);
      }
      return rc;
    }

    function goScreen(name){
      $("screenTitle").classList.toggle("active", name==="title");
      $("screenGame").classList.toggle("active", name==="game");
    }

    // ========= Hold to reset =========
    let resetArmed = false;
    let holdTimer = null;
    let holdStart = 0;

    function disarmReset(){
      resetArmed = false;
      $("btnReset").textContent = "Reset";
      $("btnReset").classList.remove("danger");
      if (holdTimer){ clearInterval(holdTimer); holdTimer = null; }
    }

    function armResetOnce(){
      resetArmed = true;
      $("btnReset").textContent = "Hold to reset";
      $("btnReset").classList.add("danger");
      toast("2ç§’é•·æŠ¼ã—ã§ãƒªã‚»ãƒƒãƒˆ");
      setTimeout(()=>{ if (resetArmed) disarmReset(); }, 5000);
    }

    function doResetToTitle(){
      stopTick();
      disarmReset();
      callAction("reset_session");
      $("overlayPause").classList.remove("show");
      $("overlayHow").classList.remove("show");
      $("overlayMore").classList.remove("show");
      goScreen("title");
      $("subLine").textContent = "ready.";
      toast("Reset!");
      // animation caches reset
      prevDealerCards = [];
      prevPlayerLens = [];
      prevBank = null;
    }

    // ========= Anim caches =========
    let prevBank = null;
    let prevDealerCards = [];
    let prevPlayerLens = [];

    // ========= Render =========
    function render(){
function setDis(id, disabled){
  const el = document.getElementById(id);
  if (el) el.disabled = !!disabled;
}

      if (!state) return;

      $("subLine").textContent = `phase: ${state.phase}`;

      // Bank anim
      const bankEl = $("bank");
      const bankPill = bankEl.closest(".pill");
      const newBank = Number(state.bank);
      if (prevBank === null){
        bankEl.textContent = String(newBank);
      } else if (prevBank !== newBank){
        animateNumber(bankEl, prevBank, newBank, 520);
        bankPill.classList.remove("bankFlash"); void bankPill.offsetWidth; bankPill.classList.add("bankFlash");
      }
      prevBank = newBank;

      $("round").textContent = `${state.session.round}/${state.session.roundLimit}`;
      $("time").textContent = fmtTime(state.session.timeLeftMs);

      $("phaseBadge").textContent = state.phase;
      $("rulesMini").textContent = [
        state.rules.allowDouble ? "Dbl" : "",
        state.rules.allowSplit ? "Spl" : "",
        state.rules.allowSurrender ? "Sur" : "",
        state.rules.allowInsurance ? "Ins" : "",
        state.rules.allowEvenMoney ? "EM" : "",
        state.rules.allowDAS ? "DAS" : "",
        state.rules.splitBJAsBJ ? "SplitBJ" : "",
        state.rules.dealerHitSoft17 ? "H17" : "S17"
      ].filter(Boolean).join(" â€¢ ") || "-";

      // Dealer
const totalText = state.dealer.holeKnown ? String(state.dealer.score) : "?";

$("dealerScoreLine").innerHTML = `
  <span class="metaLine">
    <span class="kv"><span class="k">Shown</span><b class="v">${state.dealer.scoreShown}</b></span>
    <span class="kv"><span class="k">Total</span><b class="v">${totalText}</b></span>
  </span>
`;

      $("dealerHole").textContent = state.dealer.holeKnown ? "hole open" : "hole hidden";

      const dWrap = $("dealerCards");
      dWrap.innerHTML = "";
      const dealerCards = (state.dealer.cards||[]);
      dealerCards.forEach((c, idx)=>{
        const el = document.createElement("div");
        const prev = prevDealerCards[idx];

        if (c === "?"){
          el.className = "cardBack";
        } else {
          el.className = "cardFace";
          el.textContent = c;
        }

        const isNew = idx >= prevDealerCards.length;
        const reveal = (prev === "?" && c !== "?");
        if (isNew) el.classList.add("dealIn");
        if (reveal) el.classList.add("flipIn");

        dWrap.appendChild(el);
      });
      prevDealerCards = dealerCards.slice();

      // Player hands
      const ph = $("playerHands");
      ph.innerHTML = "";
      const hands = (state.player && state.player.hands) ? state.player.hands : [];

      hands.forEach((h, i)=>{
        const box = document.createElement("div");
        box.className = "handBox" + (i === state.player.activeHandIndex ? " active" : "");

        const flags = [];
        if (h.flags.blackjack) flags.push("BJ");
        if (h.flags.bust) flags.push("BUST");
        if (h.flags.doubled) flags.push("DBL");
        if (h.flags.surrendered) flags.push("SUR");
        if (h.flags.fromSplit) flags.push("SPLIT");
        if (h.flags.splitAces) flags.push("A-SPLIT");

        const badgeClass =
          h.flags.blackjack ? "good" :
          (h.flags.bust || h.flags.surrendered) ? "bad" : "";

        const header = document.createElement("div");
        header.className = "row";
        header.style.justifyContent = "space-between";
header.innerHTML = `
  <div>
    <b>Player ${hands.length > 1 ? `Hand ${i + 1}` : ""}</b>
    <div class="metaLine" style="margin-top:6px;">
      <span class="kv"><span class="k">Score</span><b class="v">${h.score}</b></span>
      <span class="kv"><span class="k">Bet</span><b class="v">${h.bet}</b></span>
    </div>
  </div>
  <div class="badge ${badgeClass}">${flags.length ? flags.join(" â€¢ ") : "playing"}</div>
`;

        box.appendChild(header);

        const cards = document.createElement("div");
        cards.className = "cards";
        const prevLen = prevPlayerLens[i] ?? 0;

        (h.cards||[]).forEach((cc, idx)=>{
          const ce = document.createElement("div");
          ce.className = "cardFace";
          ce.textContent = cc;
          if (idx >= prevLen) ce.classList.add("dealIn"); // â‘£A slide
          cards.appendChild(ce);
        });

        box.appendChild(cards);
        ph.appendChild(box);

        prevPlayerLens[i] = (h.cards||[]).length;
      });

      // Controls enable/disable from state.can
const can = state.can || {};

setDis("btnDeal", !can.deal);
setDis("btnHit", !can.hit);
setDis("btnStand", !can.stand);
setDis("btnDouble", !can.double);
setDis("btnSplit", !can.split);
setDis("btnSurrender", !can.surrender);

// å³ãƒ‘ãƒãƒ«å´ï¼ˆè¿½åŠ ï¼‰

setDis("btnDoubleSide", !can.double);
setDis("btnSplitSide", !can.split);
setDis("btnSurrenderSide", !can.surrender);
setDis("btnEvenMoneySide", !can.evenMoney);

      // Insurance UI (in MORE overlay)
      const showIns = (state.phase === "offerInsurance");
      $("insuranceBox").style.display = showIns ? "block" : "none";
      $("btnInsBuy").disabled = !can.insurance;
      $("btnInsNo").disabled = !can.insurance;
      $("btnEvenMoney").disabled = !can.evenMoney;

      if (showIns){
        $("insHint").textContent = `max ${state.insurance.max}`;
        const a = $("insAmount");
        a.max = state.insurance.max;
        a.step = 2;
        a.value = Math.min(Number(a.value||0), state.insurance.max);
      }

      // Round banner
      const isRoundOver = (state.phase === "roundOver" || state.phase === "sessionOver");
      $("roundBanner").style.display = isRoundOver ? "flex" : "none";
      const net = state.roundResult.netProfit|0;
      const msgEl = $("roundMsg");
      const metaEl = $("roundMeta");
      if (isRoundOver){
        if (state.phase === "sessionOver"){
          msgEl.textContent = "SESSION OVER";
          msgEl.className = "msg neutral";
        } else if (net > 0){
          msgEl.textContent = `WIN +${net}`;
          msgEl.className = "msg win";
        } else if (net < 0){
          msgEl.textContent = `LOSE ${net}`;
          msgEl.className = "msg lose";
        } else {
          msgEl.textContent = "PUSH Â±0";
          msgEl.className = "msg neutral";
        }
        metaEl.textContent = `streak ${state.roundResult.streak} / bonus ${state.roundResult.bonusPercent}% (+${state.roundResult.bonusApplied})`;
      }

      $("debugLine").textContent = `lastErrorCode=${state.lastErrorCode} lastError="${state.lastError || ""}"`;

      const v = floorEven($("betInput").value);
      $("betHint").textContent = `å…¥åŠ›=${$("betInput").value} â†’ å¶æ•°åŒ–=${v}`;


      // ===== Bet lock/unlock =====
// BETã‚’ç·¨é›†ã§ãã‚‹ã®ã¯ã€Œé…ã‚‹å‰ã€orã€Œå‹æ•—ç¢ºå®šå¾Œã€ã ã‘
const betEditable = (state.phase === "betting" || state.phase === "roundOver");

// å…¥åŠ›æ¬„ã¨SETãƒœã‚¿ãƒ³
setDis("betInGame", !betEditable);
setDis("btnSetBet", !betEditable);

// +10 +50 ... ã®ãƒãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚‚å…¨éƒ¨
document.querySelectorAll("[data-add2]").forEach((b) => {
  b.disabled = !betEditable;
});

      console.log("render ok", state.phase);

    }

    // ========= UI events =========
    document.querySelectorAll('[data-add]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cur = Number($("betInput").value||0);
        $("betInput").value = cur + Number(btn.dataset.add);
      });
    });

    document.querySelectorAll('[data-add2]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cur = Number($("betInGame").value||0);
        $("betInGame").value = cur + Number(btn.dataset.add2);
      });
    });

    $("btnHowTitle").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnHowTitle2").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnHowPause").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnOpenHow").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnCloseHow").onclick = ()=> $("overlayHow").classList.remove("show");

    //$("btnMore").onclick = ()=> $("overlayMore").classList.add("show");
    $("btnDockMore").onclick = ()=> $("overlayMore").classList.add("show");
    $("btnCloseMore").onclick = ()=> $("overlayMore").classList.remove("show");

    $("btnPause").onclick = ()=>{
      if (!state) return toast("ã‚²ãƒ¼ãƒ ä¸­ã«ä½¿ãˆã¾ã™");
      if ($("screenGame").classList.contains("active")){
        callAction("set_paused", 1);
        pausedAt = performance.now();
        $("overlayPause").classList.add("show");
      } else {
        toast("ã‚²ãƒ¼ãƒ ä¸­ã«ä½¿ãˆã¾ã™");
      }
    };
    $("btnClosePause").onclick = ()=>{
      if (pausedAt){
        pausedTotal += performance.now() - pausedAt;
        pausedAt = 0;
      }
      callAction("set_paused", 0);
      $("overlayPause").classList.remove("show");
    };
    $("btnContinue").onclick = $("btnClosePause").onclick;
    $("btnQuit").onclick = ()=> doResetToTitle();

    $("btnReset").addEventListener("click", ()=>{
      if (!resetArmed) armResetOnce();
    });

    $("btnReset").addEventListener("pointerdown", ()=>{
      if (!resetArmed) return;
      holdStart = performance.now();
      const btn = $("btnReset");
      btn.textContent = "Holdingâ€¦";
      const wrap = document.createElement("div");
      wrap.className = "prog";
      const bar = document.createElement("div");
      wrap.appendChild(bar);
      btn.appendChild(wrap);

      holdTimer = setInterval(()=>{
        const t = performance.now() - holdStart;
        const pct = Math.min(100, (t / 2000) * 100);
        bar.style.width = pct + "%";
        if (t >= 2000){
          clearInterval(holdTimer); holdTimer=null;
          doResetToTitle();
        }
      }, 30);
    });

    function cancelHold(){
      if (holdTimer){ clearInterval(holdTimer); holdTimer = null; }
      if (resetArmed){
        $("btnReset").textContent = "Hold to reset";
        $("btnReset").classList.add("danger");
      }
    }
    $("btnReset").addEventListener("pointerup", cancelHold);
    $("btnReset").addEventListener("pointerleave", cancelHold);
    $("btnReset").addEventListener("pointercancel", cancelHold);

    // Start session (engine ready guard)
    $("btnStart").onclick = () => {
      if (!apiReady()){
        toast("engine not ready");
        return;
      }

      const {lo,hi} = seed64();
      const mask = rulesMaskFromUI();
      const sessionSeconds = 300;
      const roundLimit = 12;

      callAction("start_session", lo, hi, mask, sessionSeconds, roundLimit);

      const bet = floorEven($("betInput").value);
      $("betInGame").value = bet;
      callAction("set_bet", bet);

      // clear animation caches
      prevDealerCards = [];
      prevPlayerLens = [];
      prevBank = null;

      goScreen("game");
      startTick();
      toast("Good luck!");
    };

$("btnSetBet").onclick = ()=>{
  if (!state || !(state.phase === "betting" || state.phase === "roundOver")) return;
  const v = floorEven($("betInGame").value);
  $("betInGame").value = v;
  callAction("set_bet", v);
};


    // Main actions (Dock)
    $("btnDeal").onclick = ()=> callAction("deal");
    $("btnHit").onclick = ()=> callAction("hit");
    $("btnStand").onclick = ()=> callAction("stand");

    // Advanced (More)
    $("btnDouble").onclick = ()=> callAction("double_down");
    $("btnSplit").onclick = ()=> callAction("split");
    $("btnSurrender").onclick = ()=> callAction("surrender");

    $("btnInsNo").onclick = ()=> callAction("buy_insurance", 0);
    $("btnInsBuy").onclick = ()=>{
      const v = floorEven($("insAmount").value);
      $("insAmount").value = v;
      callAction("buy_insurance", v);
    };
    $("btnEvenMoney").onclick = ()=> callAction("take_even_money");

    //è¿½åŠ ã—ãŸã‚‚ã®ã§ã™ã€‚
    // MORE: å³ãƒ‘ãƒãƒ«ã®é–‹é–‰
$("btnMore").onclick = ()=> {
  $("morePanel").classList.toggle("open");
};

// å³ãƒ‘ãƒãƒ«ã®å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
$("btnDoubleSide").onclick = ()=> callAction("double_down");
$("btnSplitSide").onclick  = ()=> callAction("split");
$("btnSurrenderSide").onclick = ()=> callAction("surrender");
$("btnEvenMoneySide").onclick = ()=> callAction("take_even_money");


    // keyboard shortcuts
    window.addEventListener("keydown", (e)=>{
      if (!apiReady() || !$("screenGame").classList.contains("active")) return;
      const k = e.key.toLowerCase();
      if (k === "d") $("btnDeal").click();
      if (k === "h") $("btnHit").click();
      if (k === "s") $("btnStand").click();
      if (k === "m") $("btnDockMore").click();
      if (k === "escape"){
        if ($("overlayMore").classList.contains("show")) $("overlayMore").classList.remove("show");
        else if ($("overlayHow").classList.contains("show")) $("overlayHow").classList.remove("show");
        else if ($("overlayPause").classList.contains("show")) $("btnClosePause").click();
      }
    });

    // bet hint pre-engine
    function updateBetHintPreEngine(){
      const v = floorEven($("betInput").value);
      $("betHint").textContent = `å…¥åŠ›=${$("betInput").value} â†’ å¶æ•°åŒ–=${v}`;
    }
    $("betInput").addEventListener("input", updateBetHintPreEngine);
    updateBetHintPreEngine();

    // kick engine sync loop
    syncEngine();
  </script>

  <!-- build -->
  <script src="blackjack.js"></script>
  <script src="blackjack_ui.js"></script>
</body>
</html>
