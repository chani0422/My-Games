<!-- index.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>BlackJack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --felt0:#071a10;
      --felt1:#0b3d1a;
      --felt2:#0f5a25;

      --rail0:#0b0b0c;
      --rail1:#17171a;

      --gold:#d8b15a;
      --gold2:#ffdf8a;

      --text:#ffffff;
      --muted:rgba(255,255,255,.78);
      --muted2:rgba(255,255,255,.56);

      --border:rgba(255,255,255,.14);
      --shadow:rgba(0,0,0,.45);

      --good:#37d67a;
      --bad:#ff4d4d;
      --warn:#ffcc66;

      --radius:18px;
      --dockH: 78px;
      --font-serif: 'Cinzel', serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      /* Safe Area & Touch Action */
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      touch-action: manipulation;
      
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      color:var(--text);
      overflow-x:hidden;

      /* ã‚«ã‚¸ãƒã®é›°å›²æ°— */
      background:
        radial-gradient(1400px 920px at 50% -25%, rgba(255,223,138,.22), transparent 62%),
        radial-gradient(980px 760px at 15% 10%, rgba(55,214,122,.12), transparent 62%),
        radial-gradient(980px 760px at 85% 12%, rgba(216,177,90,.12), transparent 64%),
        radial-gradient(1200px 900px at 50% 120%, rgba(0,0,0,.62), transparent 62%),
        linear-gradient(180deg, #03120a, #052414 40%, #07351a);
    }

    body::before, body::after{
      content:"";
      position:fixed; inset:-20%;
      pointer-events:none;
      z-index:-1;
    }
    body::before{
      background:
        radial-gradient(620px 420px at 12% 28%, rgba(255,223,138,.10), transparent 60%),
        radial-gradient(620px 420px at 88% 32%, rgba(255,255,255,.06), transparent 62%),
        radial-gradient(520px 420px at 48% 5%, rgba(216,177,90,.08), transparent 62%);
      filter: blur(1px);
      animation: sweep 10s ease-in-out infinite alternate;
      opacity:.9;
    }
    body::after{
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, transparent 1px, transparent 2px);
      mix-blend-mode: overlay;
      opacity:.10;
    }
    @keyframes sweep{
      from{ transform: translate3d(-2%, -1%, 0) scale(1.02) }
      to  { transform: translate3d( 2%,  1%, 0) scale(1.04) }
    }
    @keyframes shimmer {
      0% { left: -100%; opacity: 0; }
      50% { opacity: 0.5; }
      100% { left: 200%; opacity: 0; }
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
      padding-bottom: calc(var(--dockH) + 34px);
    }

    /* ===== HUD ===== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
      border-radius: calc(var(--radius) + 4px);
      box-shadow: 0 22px 70px rgba(0,0,0,.28);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0}
    .logo{
      width:38px; height:38px; border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.06)),
        linear-gradient(135deg, rgba(255,223,138,.95), rgba(216,177,90,.55)),
        linear-gradient(225deg, rgba(55,214,122,.55), rgba(0,0,0,0));
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      font-family: var(--font-serif);
    }
    .logo::after{
      content:"";
      position:absolute; inset:-60% -40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
      transform: rotate(20deg);
      animation: shine 2.8s ease-in-out infinite;
      opacity:.9;
    }
    @keyframes shine{
      0%{ transform: translateX(-40%) rotate(20deg) }
      45%{ transform: translateX(60%) rotate(20deg) }
      100%{ transform: translateX(60%) rotate(20deg) }
    }

    .brandTxt{min-width:0}
    .brandTxt h1{
      margin:0;
      font-size:14px;
      letter-spacing:.14em;
      font-weight: 950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow: 0 18px 40px rgba(0,0,0,.45);
      font-family: var(--font-serif);
      transition: opacity 0.3s;
    }
    .topbar.in-game .brandTxt h1 { display:none; }
    
    /* Stats Layout */
    .stats-container {
      display:flex; flex-direction:column; align-items:flex-end; gap:2px;
    }
    .stats-row {
      display:flex; gap:6px; align-items:center;
    }
    .stats-row.bottom {
      margin-top:2px;
    }
    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨2è¡Œèª¿æ•´ */
    @media(max-width:600px){
      .stats-container { gap:1px; }
      /* ãƒ¢ãƒã‚¤ãƒ«ã§éå‰°ãªmin-widthã‚’å‰Šé™¤ */
      .pill { min-width:0; width:auto; flex:1 1 auto; padding:4px 6px; justify-content:center; }
      .pill span { font-size:10px; }
      .pill b { font-size:11px; }
      
      /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
      .btn.ghost { padding:4px 6px; font-size:10px; flex:1 1 auto; min-width:0; }
      .stats-row { width:100%; justify-content:flex-end; }
    }
    .sub{
      font-size:12px;
      color:var(--muted2);
      margin-top:2px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .statusBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(216,177,90,.35);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      box-shadow: 0 16px 50px rgba(0,0,0,.25);
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.08em;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 0 rgba(255,223,138,.0);
    }
    .statusBadge.good{ border-color: rgba(55,214,122,.40); color:#d8ffe7; }
    .statusBadge.good .dot{ background: rgba(55,214,122,.85); box-shadow: 0 0 0 10px rgba(55,214,122,.12); }
    .statusBadge.bad{ border-color: rgba(255,77,77,.40); color:#ffd1d1; }
    .statusBadge.bad .dot{ background: rgba(255,77,77,.85); box-shadow: 0 0 0 10px rgba(255,77,77,.12); }

    .stats{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .pill{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(0,0,0,.20);
      min-width: 140px;
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
    }
    .pill span{font-size:12px;color:var(--muted)}
    .pill b{font-size:13px; letter-spacing:.02em}
    .pill.bank{
      border-color: rgba(216,177,90,.35);
      background:
        radial-gradient(120px 70px at 10% 0%, rgba(255,223,138,.18), transparent 60%),
        rgba(0,0,0,.20);
    }
    .bankFlash{ animation: bankFlash .35s ease; }
    @keyframes bankFlash{
      from{ transform: translateY(-1px) scale(1.01); filter: brightness(1.25) }
      to{ transform:none; filter:none }
    }

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease, filter .15s ease, opacity .15s ease;
      user-select:none;
      box-shadow: 0 14px 35px rgba(0,0,0,.25);
      font-weight: 900;
      letter-spacing:.06em;
      touch-action: manipulation;
    }
    .btn:hover{ box-shadow: 0 22px 60px rgba(0,0,0,.32); filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn[disabled]{ opacity:.40; cursor:not-allowed; box-shadow:none; filter:saturate(.2); }
    .btn.primary{
      border-color: rgba(216,177,90,.45);
      background:
        radial-gradient(160px 70px at 50% 0%, rgba(255,223,138,.40), transparent 65%),
        linear-gradient(180deg, rgba(216,177,90,.18), rgba(0,0,0,.18));
      box-shadow: 0 26px 85px rgba(216,177,90,.20), 0 24px 55px rgba(0,0,0,.35);
      position: relative; overflow: hidden;
    }
    .btn.primary::after {
      content: "";
      position: absolute;
      top: 0; left: -100%;
      width: 50%; height: 100%;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
      transform: skewX(-25deg);
      animation: shimmer 3s infinite;
      pointer-events: none;
    }
    .btn.danger{
      border-color: rgba(255,77,77,.35);
      background: linear-gradient(180deg, rgba(255,77,77,.18), rgba(0,0,0,.18));
    }
    .btn.ghost{ background: rgba(0,0,0,.16); }

    /* ===== Layout ===== */
    .grid{
      display:flex;
      flex-direction:column;
      gap:16px;
      margin-top:16px;
      max-width: 800px; /* Prevent too wide table on desktop */
      margin-left: auto;
      margin-right: auto;
    }

    .card{
      border:1px solid var(--border);
      background:
        radial-gradient(1200px 500px at 30% -10%, rgba(255,223,138,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.22));
      border-radius: var(--radius);
      box-shadow: 0 28px 90px rgba(0,0,0,.25);
      overflow:hidden;
      position:relative;
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .card .hd h2{
      margin:0;
      font-size:13px;
      letter-spacing:.16em;
      font-weight: 950;
    }
    .card .bd{ padding:14px; }

    .muted{ color: var(--muted); font-size:12px; }
    .small{ font-size:12px; color: var(--muted2); }
    .divider{ height:1px; background: rgba(255,255,255,.12); margin:12px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    input[type="number"]{
      width: 160px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      box-shadow: 0 18px 45px rgba(0,0,0,.20);
      font-weight: 800;
      letter-spacing:.02em;
    }

    /* ãƒãƒƒãƒ—æ•´åˆ— (â‘¢A) */
    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start }
    .chipbtn{
      border:1px solid rgba(216,177,90,.35);
      background:
        radial-gradient(70px 40px at 30% 25%, rgba(255,223,138,.26), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      color:var(--text);
      font-weight: 950;
      letter-spacing:.06em;
      box-shadow: 0 20px 55px rgba(0,0,0,.20);
      transition: transform .08s ease, filter .15s ease;
    }
    .chipbtn:hover{ filter: brightness(1.06) }
    .chipbtn:active{ transform: translateY(1px) scale(.99) }

    /* ===== ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ ===== */
    .screen{ display:none; animation: fadeIn .20s ease; }
    .screen.active{ display:block; }
    @keyframes fadeIn{
      from{ opacity:.5; transform: translateY(8px) }
      to{ opacity:1; transform:none }
    }

    /* ===== ã‚¿ã‚¤ãƒˆãƒ«ãƒ’ãƒ¼ãƒ­ãƒ¼ ===== */
    .titleHero{
      padding:22px 16px;
      text-align:center;
      position:relative;
    }
    .titleHero .chipline{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(216,177,90,.35);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-weight:900;
      letter-spacing:.06em;
    }
    .titleHero h2{
      margin:12px 0 6px;
      font-size:28px;
      letter-spacing:.02em;
      font-weight: 950;
      text-shadow: 0 22px 60px rgba(0,0,0,.35);
    }
    .titleHero p{ margin:0; color: var(--muted); }

    .ctaRow{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .ctaBig{
      min-width: 260px;
      height: 54px;
      border-radius: 18px;
      font-size: 14px;
      letter-spacing:.14em;
    }

    /* ===== ã‚ªãƒ—ã‚·ãƒ§ãƒ³ ===== */
    .optGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 560px){ .optGrid{grid-template-columns:1fr} }
    .opt{
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background: rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .opt label{display:flex; gap:10px; align-items:center; cursor:pointer; width:100%}
    .opt input{ transform: scale(1.1) }

    /* ===== ã‚«ã‚¸ãƒãƒ†ãƒ¼ãƒ–ãƒ« (â˜…ã“ã“ãŒè¦‹ãŸç›®ã®æœ¬ä½“) ===== */
    .tableStage{
      perspective: 900px; /* â‘ B: æ§ãˆã‚ã« */
    }
    .tableTilt{
      transform: rotateX(12deg); /* â‘ B */
      transform-origin: 50% 20%;
    }

    .tableFrame{
      padding:14px;
      border-radius: 28px 28px 380px 380px; /* â‘¡A: åŠåˆ†ãã‚‰ã„ */
      background:
        radial-gradient(1200px 500px at 50% 0%, rgba(255,223,138,.08), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.20));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 40px 90px rgba(0,0,0,.32);
      position:relative;
      overflow:hidden;
    }

    /* ãƒãƒƒãƒˆãƒ–ãƒ©ãƒƒã‚¯ã®ãƒ¬ãƒ¼ãƒ« */
    .tableFrame::before{
      content:"";
      position:absolute; inset:0;
      border-radius: inherit;
      padding: 14px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.65));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
    /* è¿½åŠ ï¼ˆæ¨™æº–ï¼‰ */
  mask:
    linear-gradient(#000 0 0) content-box,
    linear-gradient(#000 0 0);
  mask-composite: exclude;
              mask-composite: exclude;
      opacity:.95;
      pointer-events:none;
    }
    .tableFrame::after{
      /* å¾®å¦™ãªã‚¹ãƒ†ãƒƒãƒãƒã‚¤ãƒ©ã‚¤ãƒˆ */
      content:"";
      position:absolute;
      inset:10px 10px 18px 10px;
      border-radius: 22px 22px 360px 360px;
      border: 1px dashed rgba(255,255,255,.10);
      opacity:.55;
      pointer-events:none;
    }

    .tableSurface{
      position:relative;
      border-radius: 18px 18px 340px 340px;
      overflow:hidden;
      min-height: 520px;
      background:
        radial-gradient(900px 520px at 50% -20%, rgba(255,255,255,.10), transparent 62%),
        radial-gradient(900px 520px at 10% 10%, rgba(255,223,138,.06), transparent 62%),
        radial-gradient(900px 520px at 90% 12%, rgba(55,214,122,.06), transparent 64%),
        linear-gradient(180deg, var(--felt0), var(--felt1) 45%, var(--felt2));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 0 0 1px rgba(0,0,0,.30) inset;
    }

    /* ãƒ•ã‚§ãƒ«ãƒˆã®è³ªæ„Ÿ */
    .tableSurface::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,.015), rgba(255,255,255,.015) 1px, transparent 1px, transparent 3px),
        radial-gradient(1200px 700px at 50% 120%, rgba(0,0,0,.25), transparent 62%);
      mix-blend-mode: overlay;
      opacity:.25;
      pointer-events:none;
    }

    /* ãƒãƒ¼ã‚­ãƒ³ã‚°: â‘¡C (B + å°ã•ã„ãƒ«ãƒ¼ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ) ã ãŒå…¨ä½“çš„ã«æ§ãˆã‚ã« (â‘¤B) */
    .markings{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.82;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.20));
    }
    .markText{
      fill: rgba(255,255,255,.78);
      font-weight: 900;
      letter-spacing: .18em;
    }
    .markSmall{
      fill: rgba(255,255,255,.48);
      font-weight: 800;
      letter-spacing: .14em;
    }
    .markLine{
      stroke: rgba(255,255,255,.32);
      stroke-width: 2.2;
      fill:none;
    }
    .markDots{
      stroke: rgba(255,223,138,.18);
      stroke-width: 2;
      stroke-dasharray: 3 10;
      fill:none;
    }

    #screenTitle #debugPhase { display:none; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸Šã®ã‚¾ãƒ¼ãƒ³ */
    .dealerZone{
      position:absolute;
      top: 70px; /* ä¸‹ã«ãšã‚‰ã™ */
      left: 50%;
      transform: translateX(-50%);
      width: min(720px, 92%);
    }
    .playerZone{
      position:absolute;
      left: 50%;
      bottom: 110px; /* å¤§å¹…ã«ä¸Šã«ãšã‚‰ã™ */
      transform: translateX(-50%);
      width: min(860px, 94%);
    }

    /* ãƒœãƒƒã‚¯ã‚¹ */
    .handBox{
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.18);
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
      box-shadow: inset 0 2px 12px rgba(0,0,0,0.5), 0 10px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(2px);
    }
    .handBox.active{
      /* border-color: rgba(55,214,122,.55); ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã«åˆã‚ã›ã‚‹ãŸã‚å‰Šé™¤ */
      border-color: rgba(255,255,255,.35); /* ç·‘ã®ä»£ã‚ã‚Šã«å¾®å¦™ãªç™½ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
      box-shadow:
        0 0 0 1px rgba(255,255,255,.10) inset,
        0 26px 70px rgba(0,0,0,.25);
      transform: translateY(-1px);
      /* filter: brightness(1.10); ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼è‰²ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã‚‹ãŸã‚å‰Šé™¤ */
    }

    .handArea{
      display:flex;
      flex-direction:row; /* Splitæ™‚ã«æ¨ªã«ä¸¦ã¹ã‚‹ */
      gap:12px;
      justify-content: center;
      align-items: flex-end; /* åº•æƒãˆ */
      flex-wrap: wrap; /* ç”»é¢ãŒç‹­ã„å ´åˆã¯æŠ˜ã‚Šè¿”ã™ */
    }


    .cards{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* ã‚«ãƒ¼ãƒ‰ã®è¦‹ãŸç›®: â‘§A (å†™çœŸé¢¨) */
    .cardFace, .cardBack{
      width: 48px;
      height: 68px;
      border-radius: 13px;
      box-shadow: 0 16px 30px rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      letter-spacing:.02em;
      user-select:none;
      position:relative;
      overflow:hidden;
      transform: translate3d(0,0,0);
    }
    .cardFace{
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.90), rgba(255,255,255,.62)),
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      color:#0e0e10;
      border-color: rgba(0,0,0,.10);
    }
    .cardFace::after{
      content:"";
      position:absolute;
      inset:-30% -40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      transform: rotate(22deg);
      opacity:.55;
      pointer-events:none;
    }

    .cardBack{
      background:
        radial-gradient(circle at 25% 25%, rgba(255,255,255,.32), transparent 60%),
        linear-gradient(135deg, rgba(255,223,138,.60), rgba(216,177,90,.22)),
        linear-gradient(225deg, rgba(55,214,122,.38), rgba(0,0,0,0));
      border-color: rgba(216,177,90,.28);
    }
    .cardBack::before{
      /* è£é¢ãƒ‘ã‚¿ãƒ¼ãƒ³ */
      content:"";
      position:absolute; inset:10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.22);
      background:
        repeating-linear-gradient(45deg, rgba(255,255,255,.10) 0 6px, transparent 6px 12px),
        radial-gradient(circle at 50% 50%, rgba(0,0,0,.10), transparent 62%);
      opacity:.85;
    }

    /* â‘£A: ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ã‚£ãƒ¼ãƒ« + ãƒ•ãƒªãƒƒãƒ— (ä½™åˆ†ãªå›è»¢/ç™ºå…‰ãªã—) */
    .dealIn{
      animation: dealIn .42s cubic-bezier(.2,.8,.2,1) both;
    }
    @keyframes dealIn{
      from{ opacity:0; transform: translate(120px,-60px) rotate(-8deg) scale(.95); filter: blur(.35px) }
      to{ opacity:1; transform:none; filter:none }
    }
    .flipIn{
      animation: flipIn .46s cubic-bezier(.2,.8,.2,1) both;
      transform-origin: center;
    }
    @keyframes flipIn{
      0%{ transform: rotateY(0deg) }
      50%{ transform: rotateY(90deg); filter: brightness(1.10) }
      100%{ transform: rotateY(0deg); filter:none }
    }

    .badge{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.06em;
    }
    .badge.good{ border-color: rgba(55,214,122,.35); color:#d8ffe7 }
    .badge.bad{ border-color: rgba(255,77,77,.35); color:#ffd1d1 }

    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      box-shadow: 0 20px 60px rgba(0,0,0,.20);
    }
    .banner .msg{ font-weight: 950; letter-spacing:.10em; }
    .banner .msg.win{ color:#d8ffe7 }
    .banner .msg.lose{ color:#ffd1d1 }
    .banner .msg.neutral{ color:#fff1cc }

    /* ===== ãƒ‰ãƒƒã‚¯ (â‘©A) ===== */
    .dock{
      position:fixed;
      left: 12px;
      right: 12px;
      bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      height: var(--dockH);
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      padding:10px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.25));
      backdrop-filter: blur(14px);
      box-shadow: 0 40px 90px rgba(0,0,0,.45);
      z-index: 30;
    }
    .dock .btn{
      height:100%;
      border-radius: 14px;
      font-size: 13px;
      display:flex;
      flex-direction:column; /* ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚­ãƒ¼ãƒ’ãƒ³ãƒˆã‚’ã‚¹ã‚¿ãƒƒã‚¯ */
      align-items:center;
      justify-content:center;
      gap:2px;
      padding:0 4px;
      line-height:1.1;
    }
    .dock .btn .k{
      font-size: 10px;
      padding: 2px 6px;
      margin-top:2px;
    }
    /* 6ãƒœã‚¿ãƒ³ç”¨ã®ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚°ãƒªãƒƒãƒ‰ -> ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ */
    .dock.full{
      display: flex !important;
      flex-wrap: wrap !important;
      align-content: stretch !important;
      height: auto !important;
      min-height: 90px;
      /* ä¸Šé™ã¾ã§æ‹¡å¤§è¨±å¯ */
      max-height: 40vh;
      bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      gap: 12px;
    }
    .dock .btn {
      flex: 1 1 45%; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: è¡Œã‚ãŸã‚Š2ã¤ã€‚ã‚®ãƒ£ãƒƒãƒ—ã‚’è€ƒæ…®ã—ã¦45%ã‚’ä½¿ç”¨ */
      min-height: 72px;
      font-size: 18px !important; /* Larger text */
      font-weight: 800;
      /* ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã«ã‚ˆã‚Šç„¡åŠ¹æ™‚ã¯éè¡¨ç¤ºã«ã™ã‚‹ */
    }
    .dock .btn:disabled {
      /* display: none !important; */
      opacity: 0.3 !important;
      pointer-events: none !important;
      filter: grayscale(1) !important;
    }
    
    @media (min-width: 600px) {
      .dock.full{
        /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼šå…¨ã¦è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼Ÿãã‚Œã¨ã‚‚åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã«å¾“ã†ï¼Ÿ
           ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¢ãƒã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ã€Œã“ã®ã‚±ãƒ¼ã‚¹ã€ã¨è¨€ã£ãŸã€‚
           ã—ã‹ã—ä¸€è²«æ€§ã¯è‰¯ã„ã“ã¨ã ã€‚ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«ã‚‚å‹•çš„ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã‚’é©ç”¨ã—ã‚ˆã†ã‹ã€
           ãã‚Œã¨ã‚‚6ã¤ä¸¦ã³ã‚’ç¶­æŒã™ã‚‹ã‹ï¼Ÿ
           ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«ååˆ†ãªå¹…ãŒã‚ã‚Œã°ã€1è¡Œã«6ãƒœã‚¿ãƒ³ã§å•é¡Œãªã„ã€‚
           ã—ã‹ã—ã€Œé¸æŠå¯èƒ½ã®ã¿ã€ã¯å¼·ã„è¦æœ›ã ã€‚
        */
        height: 100px;
      }
      .dock .btn {
        flex: 1 1 auto; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ã‚‹ */
        max-width: 300px;
      }
    }

    /* === ã‚¤ãƒ³ã‚·ãƒ¥ãƒ©ãƒ³ã‚¹ãƒ‰ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ === */
.dock.insMode{
  grid-template-columns: 1fr 1fr;
}
.dock.insMode #btnDeal{
  display:none;
}/* .dock.insMode #btnDockMore{
  display:none;
} */


    /* ===== Overlays ===== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:60;
      backdrop-filter: blur(10px);
    }
    .overlay.no-blur{
      backdrop-filter: none !important;
      background: rgba(0,0,0,0.20);
    }
    .overlay.show{ display:flex }
    .overlay.no-blur .modal {
      background: rgba(0,0,0,0.80);
      /* 80%ã®ä¸é€æ˜åº¦ãŒèªè­˜ã§ãã‚‹ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ãªèƒŒæ™¯ã‚’ä½¿ç”¨ */
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
    }
    .modal{
      width:min(620px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 400px at 20% -20%, rgba(255,223,138,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.34));
      box-shadow: 0 30px 90px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modal .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(0,0,0,.16);
    }
    .modal .bd{ padding:20px; overflow-y:auto; max-height:80vh; }
    
    .modal.wide { width: min(800px, 96%); }
    .rule-sec { margin-bottom: 24px; font-size:14px; line-height:1.6; }
    .rule-sec:last-child { margin-bottom:0; }
    .rule-sec > b { color: #8ad; display:block; margin-bottom:8px; font-size:15px; letter-spacing:.05em; }
    
    .rule-list { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .rule-item { background:rgba(255,255,255,.05); padding:10px; border-radius:8px; font-size:13px; border:1px solid rgba(255,255,255,.05); }
    .rule-item-title { font-weight:bold; color:#e0e0e0; display:block; margin-bottom:2px; }
    
    @media (max-width: 600px) { .rule-list { grid-template-columns: 1fr; } }
    .actionsGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top: 10px;
    }
    .actionsGrid .btn{ width:100% }

    /* Toast */
    .toastWrap{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom: calc(var(--dockH) + 18px + env(safe-area-inset-bottom, 0px));
      display:flex; flex-direction:column; gap:8px;
      /* Mobile safe area adjustments */
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      padding-left: calc(12px + env(safe-area-inset-left));
      padding-right: calc(12px + env(safe-area-inset-right));
      z-index:99;
      pointer-events:none;
    }
    /* Touch Targets */
    .toastWrap .btn, .toastWrap .chipbtn { min-height:44px; min-width:44px; }
    .toastWrap .opt { min-height:44px; }
    .toastWrap .opt label { padding:8px 0; }
    .toast{
      pointer-events:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.62);
      color:#fff;
      box-shadow:0 18px 50px rgba(0,0,0,.28);
      font-size:13px;
      max-width:min(640px, calc(100vw - 24px));
    }

    /* Hold progress */
    .prog{
      height:8px; border-radius:999px; background: rgba(255,255,255,.12);
      overflow:hidden; border:1px solid rgba(255,255,255,.10);
      margin-top:8px;
    }
    .prog > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,223,138,.95), rgba(55,214,122,.90));
    }
    /* =========================
       è¦–èªæ€§ä¿®æ­£ãƒ‘ãƒƒã‚¯
       - ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚·ãƒ£ãƒ¼ãƒ—ã«
       - ãƒãƒ¼ã‚­ãƒ³ã‚°ã‚’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èƒŒé¢ã«
       - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ•ãƒ¬ãƒ¼ãƒ å†…ã«åã‚ã‚‹
       ========================= */

/* æ–‡å­—ã®æ»²ã¿ã‚’æ¸›ã‚‰ã™ï¼ˆå…¨ä½“ï¼‰ */
body{
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: geometricPrecision;
}

/* 3Då¤‰å½¢ãŒãƒ†ã‚­ã‚¹ãƒˆã‚’æ»²ã¾ã›ã‚‹ã®ã§ä¸€æ—¦OFFï¼ˆæœ€å„ªå…ˆã§è¦‹ã‚„ã™ãã™ã‚‹ï¼‰ */
.tableStage{ perspective: none !important; }
.tableTilt{ transform: none !important; }

/* ãƒãƒ¼ã‚­ãƒ³ã‚°ãŒâ€œä¸Šã«è¢«ã£ã¦ã‚‹â€ã®ãŒæœ€å¤§ã®è¦‹ã¥ã‚‰ã•ï¼šèƒŒé¢ã¸ */
.tableSurface{ position: relative; }
.markings{
  z-index: 0 !important;
  filter: none !important;      /* drop-shadow ãŒæ»²ã¿ã‚„ã™ã„ */
  opacity: .60 !important;      /* æ§ãˆã‚ã« */
  pointer-events: none;
}

/* å®Ÿã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆDealer/Playerï¼‰ã¯å‰é¢ã¸ */
.dealerZone, .playerZone{
  z-index: 2 !important;
}

/* absoluteé…ç½®ã ã¨ä¸¸æ ã§è¦‹åˆ‡ã‚ŒãŒã¡ â†’ é€šå¸¸ãƒ•ãƒ­ãƒ¼ + paddingã§ä¸­ã«åã‚ã‚‹ */
/* absoluteé…ç½®ã ã¨ä¸¸æ ã§è¦‹åˆ‡ã‚ŒãŒã¡ â†’ é€šå¸¸ãƒ•ãƒ­ãƒ¼ + paddingã§ä¸­ã«åã‚ã‚‹ -> ã‚­ãƒ£ãƒ³ã‚»ãƒ« */
.tableSurface{
  display: block !important; /* absoluteã®å­è¦ç´ ã®ãŸã‚ã«ãƒ–ãƒ­ãƒƒã‚¯ã«æˆ»ã™ */
  /* flex-direction: column !important; */
  /* justify-content: space-between !important; */
  overflow: hidden;
  position: relative !important;
}

@media (max-width: 600px) {
  .tableSurface {
    /* absoluteã®å­è¦ç´ ã«ã¯paddingã¯ã‚ã¾ã‚Šé–¢ä¿‚ãªã„ãŒã€ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µã‚¤ã‚ºã‚’ç¶­æŒã™ã‚‹ */
    padding: 0 !important; 
    height: 520px !important; /* é«˜ã•ã‚’ç¢ºä¿ */
  }
  
  /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ Bet/Info */
  .card .bd { padding: 8px !important; }
  .card .hd { display:none; } /* "BET/INFO" ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éš ã™ */
  .dealerZone { top: 40px !important; } /* ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã‚’ä¸Šã«ãšã‚‰ã™ */
  .playerZone { bottom: 85px !important; } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä¸‹ã«ãšã‚‰ã™/åˆã‚ã›ã‚‹ */
  .divider { margin: 6px 0 !important; }
  
  /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ‰ãƒƒã‚¯ */
  .dock.full {
    min-height: 60px !important;
    gap: 6px !important;
    padding: 6px !important;
    bottom: calc(6px + env(safe-area-inset-bottom, 0px)) !important;
    --dockH: 60px; /* è¨ˆç®—ã«å¿…è¦ãªå ´åˆã¯å¤‰æ•°ã‚’æ›´æ–° */
  }
  .dock .btn {
    min-height: 48px !important;
    font-size: 14px !important;
    border-radius: 10px !important;
  }
  .dock .btn .k { display:none; } /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚­ãƒ¼ãƒ’ãƒ³ãƒˆã‚’éš ã™ */
  
  /* æ–°ã—ã„ãƒ‰ãƒƒã‚¯ã®é«˜ã•ã«åˆã‚ã›ã¦ãƒ©ãƒƒãƒ‘ãƒ¼ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
  .wrap { padding-bottom: calc(60px + 20px + env(safe-area-inset-bottom)) !important; }
}
    
    @media (max-width: 600px) {
      .tableSurface {
        padding: 40px 12px 180px !important; /* è¤‡æ•°è¡Œãƒ‰ãƒƒã‚¯ç”¨ã«ä¸‹éƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
      }
      .dealerZone, .playerZone {
        max-width: 100% !important;
      }
      /* ãƒ¢ãƒã‚¤ãƒ«ã§ãƒãƒ³ãƒ‰ãŒæ¨ªã«ä¸¦ã³ã™ãã‚‹ã¨è¾›ã„ã®ã§ã€å¾®èª¿æ•´ */
      .handArea {
        gap: 6px;
      }
    }

/* absolute ã‚’è§£é™¤ã—ã¦ã‚»ãƒ³ã‚¿ãƒ¼ã«åã‚ã‚‹ */
/* absolute ã‚’è§£é™¤ã—ã¦ã‚»ãƒ³ã‚¿ãƒ¼ã«åã‚ã‚‹ -> absoluteé…ç½®ã‚’å¾©å…ƒã™ã‚‹ãŸã‚ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ« */
/* 
.dealerZone, .playerZone{
  position: relative !important;
  top: auto !important; bottom: auto !important; left: auto !important;
  transform: none !important;
  width: 100% !important;
  margin: 0 auto !important;
}
*/
/* ä»£ã‚ã‚Šã«absoluteã‚’ä½¿ç”¨ã™ã‚‹ãŒå¹…ã‚’åˆ¶é™ã™ã‚‹ */
.dealerZone, .playerZone{
  position: absolute !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  width: 86% !important; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’è¨±å¯ */
  max-width: 600px !important;
}
.dealerZone{ top: 110px !important; } /* 70pxã‹ã‚‰ä¸‹ã’ãŸ */
.playerZone{ bottom: 90px !important; }

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›²ç‡ãŒå¼·ã™ãã‚‹ã¨è¦‹åˆ‡ã‚Œã‚„ã™ã„ â†’ å°‘ã—ç·©ã‚ã‚‹ */
.tableFrame{
  border-radius: 28px 28px 280px 280px !important;
}
.tableSurface{
  border-radius: 18px 18px 240px 240px !important;
  min-height: 620px !important;            /* ä½™ç™½ä¸è¶³ã«ã‚ˆã‚‹ä¸‹åˆ‡ã‚Œã‚’é˜²ã */
}

/* backdrop-filter ãŒæ–‡å­—ã‚’æ»²ã¾ã›ã‚‹æ™‚ãŒã‚ã‚‹ã®ã§ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã¯åˆ‡ã‚‹ */
.handBox{
  backdrop-filter: none !important;
}

/* å°ã•ã„æ–‡å­—ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆUP */
.muted{ color: rgba(255,255,255,.88) !important; }
.small{ color: rgba(255,255,255,.72) !important; }
.badge{ color: rgba(255,255,255,.84) !important; }

/* ã‚«ãƒ¼ãƒ‰é ˜åŸŸãŒä¸‹ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«å¾®èª¿æ•´ */
.playerZone .cards{ padding-bottom: 6px !important; }

.morePanel{
  display:block;
  margin-top:10px;
  padding:12px;
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
}
.moreHd{ opacity:.9; }
.moreGrid .btn{ font-weight:800; letter-spacing:.02em; }


.moreHd{
  font-weight:900;
  letter-spacing:.06em;
  font-size:12px;
  opacity:.92;
  margin-bottom:10px;
}
.moreGrid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:10px;
}
.moreGrid .btn{ width:100%; }

.metaLine{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.kv{
  display:inline-flex;
  align-items:baseline;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.18);
}
.kv .k{ font-size:11px; color:rgba(255,255,255,.78); letter-spacing:.04em; }
.kv .v{ font-family: var(--font-serif); font-size:22px; font-weight:900; color:#fff; }
#btnMore{ display:none; }

  
    /* ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ãƒ•ãƒ­ãƒ¼ ===== */
    .soSplash{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:28px 10px;
      text-align:center;
    }
    .soBig{
      font-size: clamp(28px, 6vw, 44px);
      font-weight: 1000;
      letter-spacing: .06em;
      color: #fff;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
      font-family: var(--font-serif);
    }
    .soSub{
      color: rgba(255,255,255,.78);
      font-weight: 800;
      letter-spacing:.04em;
    }
    .soResults{ display:none; width:100%; }
    .soStats{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .soStat{
      display:flex;
      align-items:baseline;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      min-width: 160px;
    }
    .soStat .k{ font-size:11px; color:rgba(255,255,255,.78); letter-spacing:.04em; }
    .soStat .v{ font-size:14px; font-weight: 1000; color:#fff; }
    .soLockRow{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .soLockNote{ font-size:12px; color:rgba(255,255,255,.78); }
    .soBtns{ margin-top:14px; justify-content:flex-end; gap:10px; }
    .soBannerWrap{
      margin-top:12px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.12);
      padding:10px;
    }
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒãƒŠãƒ¼ç”¨ã«ã‚µã‚¤ã‚ºãŒå¿…è¦ */
    #cg-so-banner{
      width: min(520px, 100%);
      height: 90px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }

  </style>
</head>

<!-- CrazyGames SDK v3 (å®‰å…¨ãªåˆæœŸåŒ–) -->
<script src="https://sdk.crazygames.com/crazygames-sdk-v3.js"></script>
<script>
  // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚„CrazyGamesä»¥å¤–ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„ãŸã‚ã®å®‰å…¨ãªãƒ©ãƒƒãƒ‘ãƒ¼ã€‚
  // è¨­å®š: CrazyGames "Basic Launch" æå‡ºç”¨ã«ã¯falseã«è¨­å®šã€‚
  const ENABLE_ADS = false;

  window.CG = window.CG || {};
  window.CG.ready = false;

  window.CG.init = async function () {
    try {
      if (!window.CrazyGames || !window.CrazyGames.SDK || !window.CrazyGames.SDK.init) return false;
      await window.CrazyGames.SDK.init();
      window.CG.ready = true;
      console.log("[CrazyGames] SDK ready");
      return true;
    } catch (e) {
      console.warn("[CrazyGames] SDK init failed:", e);
      return false;
    }
  };
// DOMContentLoadedã§åˆæœŸåŒ–
window.CG.p = new Promise((resolve) => {
  window.addEventListener("DOMContentLoaded", async () => {
    const ok = await window.CG.init();
    resolve(ok);
  });
});

</script>

<script>
  // ---- å†ªç­‰ã‚¤ãƒ™ãƒ³ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼ ----
  window.CG._loadingDepth = 0;
  window.CG._inGameplay = false;

  window.CG._call = async function (fn) {
    try {
      await window.CG.p;
      if (!window.CG.ready) return;
      fn();
    } catch (_) {}
  };

  window.CG.loadingStart = function () {
    return window.CG._call(() => {
      if (window.CG._loadingDepth++ === 0) window.CrazyGames.SDK.game.loadingStart();
    });
  };

  window.CG.loadingStop = function () {
    return window.CG._call(() => {
      if (window.CG._loadingDepth > 0 && --window.CG._loadingDepth === 0) window.CrazyGames.SDK.game.loadingStop();
    });
  };

  window.CG.gameplayStart = function () {
    return window.CG._call(() => {
      if (window.CG._inGameplay) return;
      window.CG._inGameplay = true;
      window.CrazyGames.SDK.game.gameplayStart();
    });
  };

  window.CG.gameplayStop = function () {
    return window.CG._call(() => {
      if (!window.CG._inGameplay) return;
      window.CG._inGameplay = false;
      window.CrazyGames.SDK.game.gameplayStop();
    });
  };


</script>
<script src="loc.js"></script>


<body>
  <div class="wrap">
<div class="topbar">
  <div class="brand">
    <div class="logo"></div>
    <div class="brandTxt">
      <h1>BLACKJACK</h1>
      <div class="sub">
        <span id="subLine" data-i18n="ui.booting">bootingâ€¦</span>
        <span id="engineBadge" class="statusBadge">
          <span class="dot"></span><span id="engineText" data-i18n="ui.loading">LOADING</span>
        </span>
      </div>
    </div>
  </div>

  <div class="stats-container">
    <div class="stats-row top">
      <div class="pill"><span data-i18n="stats.bank">Bank</span><b id="bank">-</b></div>
      <div class="pill"><span data-i18n="stats.round">Round</span><b id="round">-</b></div>
      <div class="pill"><span data-i18n="stats.time">Time</span><b id="time">-</b></div>
    </div>
    <div class="stats-row bottom">
      <button class="btn ghost" id="btnPause" title="Menu" data-i18n="menu.menu">MENU</button>
      <button class="btn ghost" id="btnHistory" title="History" data-i18n="menu.history">History</button>
      <button class="btn ghost" id="btnRanking" title="Leaderboard" data-i18n="menu.ranking">Ranking</button>
    </div>
  </div>
</div>


    <!-- TITLE -->
    <div class="screen active" id="screenTitle">
      <div class="card">
        <div class="titleHero">
          <div class="chipline" data-i18n="title.payout">ğŸ° BLACKJACK PAYS 3 TO 2 â€¢ INSURANCE PAYS 2 TO 1</div>
          <h2 data-i18n="title.main">Blackjack</h2>
          <p data-i18n="title.sub">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ã‚’ç›®æŒ‡ã›ï¼ï¼</p>

          <div class="ctaRow">
            <button class="btn primary ctaBig" id="btnStart" disabled data-i18n="title.deal_start">DEAL / START</button>
            <button class="btn ghost" id="btnHowTitle" data-i18n="title.how">éŠã³æ–¹</button>
          </div>
        </div>

        <div class="bd">
          <div class="row" style="justify-content:space-between; align-items:flex-end;">
            <div>
              <div class="muted" data-i18n="title.bet_hint">Betï¼ˆå¶æ•°æ¨å¥¨ï¼šInsurance = bet/2 ã§ç«¯æ•°å›é¿ï¼‰</div>
              <div class="row" style="margin-top:8px;">
                <input id="betInputTitle" type="number" value="100" step="10" min="10">
                <div class="chips">
                  <button class="chipbtn" data-add="10">+10</button>
                  <button class="chipbtn" data-add="50">+50</button>
                  <button class="chipbtn" data-add="100">+100</button>
                  <button class="chipbtn" data-add="200">+200</button>
                </div>
              </div>
              <div class="muted" id="betHint" style="margin-top:6px;"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted" style="display:flex; justify-content:space-between; align-items:center;">
             <span data-i18n="title.options">Optionsï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã§ON/OFFï¼‰</span>
             <button id="btnLangToggle" class="btn ghost" style="font-size:12px; padding:4px 8px;">EN / JP</button>
          </div>
          <div class="optGrid">
            <div class="opt"><label><input type="checkbox" id="optDouble" checked> <span data-i18n="opt.double">Double Down</span></label></div>
            <div class="opt"><label><input type="checkbox" id="optSplit" checked> <span data-i18n="opt.split">Split</span></label></div>
            <div class="opt"><label><input type="checkbox" id="optSurrender" checked> <span data-i18n="opt.surrender">Surrender (Late)</span></label></div>
            <div class="opt"><label><input type="checkbox" id="optInsurance" checked> <span data-i18n="opt.insurance">Insurance</span></label></div>
            <div class="opt"><label><input type="checkbox" id="optEvenMoney" checked> <span data-i18n="opt.even_money">Even Money</span></label></div>
            <div class="opt"><label><input type="checkbox" id="optDAS" checked> <span data-i18n="opt.das">DAS</span></label></div>
            <div class="opt"><label><input type="checkbox" id="optSplitBJ" checked> <span data-i18n="opt.split_bj">Split BJ as BJ</span></label></div>
            <div class="opt"><label><input type="checkbox" id="optH17" checked> <span data-i18n="opt.h17">Dealer hits Soft 17</span></label></div>
            <div class="opt"><label><input type="checkbox" id="optHaptic" checked> <span data-i18n="opt.haptic">Vibration (Haptics)</span></label></div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between">

            <button class="btn" id="btnHowTitle2" data-i18n="title.marking">ãƒãƒ¼ã‚­ãƒ³ã‚°/æ“ä½œ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div class="screen" id="screenGame">
      <div class="grid">
        <div class="card">
          <div class="hd">
            <h2 data-i18n="game.garage">CASINO TABLE</h2>
            <div class="pill" id="debugPhase" style="display:none; color:#888;"></div>
          </div>
          <div class="bd">
            <!-- Bet / Info ã‚«ãƒ¼ãƒ‰ (ä¸Šã«ç§»å‹•) -->
            <div class="card">
              <div class="hd">
                <h2 data-i18n="game.bet_info">BET / INFO</h2>
                <div class="badge" id="rulesMini">-</div>
              </div>
              <div class="bd">
                <div class="row">
                  <div class="muted" data-i18n="game.bet">Bet</div>
                  
                  <!-- ãƒ™ãƒƒãƒˆè¡¨ç¤º -->
                  <div style="display:flex; justify-content:center; margin-bottom:8px; width:100%;">
                     <input id="betInput" type="number" readonly value="100" style="
                         padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
                         background:rgba(0,0,0,.4); color:#fff; font-weight:bold; width:100%;
                         font-size:20px; text-align:center; outline:none;">
                  </div>

                  <!-- ãƒ™ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
                  <style>
                    .bet-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; width:100%; }
                    .btn-bet { 
                       padding:8px 2px; border-radius:8px; border:none; 
                       background:#444; color:#fff; font-weight:bold; cursor:pointer;
                       font-size:12px;
                    }
                    .btn-bet:active { background:#666; transform:scale(0.95); }
                    .btn-bet:disabled { opacity:0.5; transform:none; }
                    .btn-bet.plus { background: #2e7d32; }
                    .btn-bet.minus { background: #c62828; }
                  </style>
                  <div class="bet-grid">
                      <!-- ä¸Šæ®µ: ãƒ—ãƒ©ã‚¹ -->
                      <button class="btn-bet plus" onclick="updateBet(10)">+10</button>
                      <button class="btn-bet plus" onclick="updateBet(100)">+100</button>
                      <button class="btn-bet plus" onclick="updateBet(1000)">+1k</button>
                      <button class="btn-bet plus" onclick="updateBet(10000)">+10k</button>
                      <!-- ä¸‹æ®µ: ãƒã‚¤ãƒŠã‚¹ -->
                      <button class="btn-bet minus" onclick="updateBet(-10)">-10</button>
                      <button class="btn-bet minus" onclick="updateBet(-100)">-100</button>
                      <button class="btn-bet minus" onclick="updateBet(-1000)">-1k</button>
                      <button class="btn-bet minus" onclick="updateBet(-10000)">-10k</button>
                  </div>
                </div>

            <div class="divider"></div>
            <!-- Moreãƒ‘ãƒãƒ«å‰Šé™¤ -->
            <div class="divider"></div>
<div class="handBox" id="insSideBox" style="display:none; margin-top:12px;">
  <div class="row" style="justify-content:space-between;">
    <b data-i18n="ins.insurance">Insurance</b>
    <span class="muted" id="insHintSide">-</span>
  </div>

  <div class="row" style="margin-top:10px;">
    <input id="insAmountSide" type="number" value="0" step="2" min="0">
    <button class="btn" id="btnInsMaxSide" data-i18n="ins.max">MAX</button>
    <button class="btn ghost" id="btnInsZeroSide">0</button>
  </div>

  <div class="muted small" style="margin-top:8px;" data-i18n="ins.dock_hint">
    ä¸‹ã®DOCKã§ <b>YES / NO</b> ã‚’é¸æŠ
  </div>

  <div class="row" style="margin-top:10px;">
    <button class="btn" id="btnEvenMoneyIns" data-i18n="cmd.even_money">Even Money</button>
  </div>
</div>


          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <!-- ãƒ†ãƒ¼ãƒ–ãƒ« (ä¸‹ã«ç§»å‹•) -->
            <div class="tableStage">
              <div class="tableTilt">
                <div class="tableFrame">
                  <div class="tableSurface">

                    <!-- ãƒãƒ¼ã‚­ãƒ³ã‚° (â‘¡C) -->
                    <svg class="markings" viewBox="0 0 1000 650" preserveAspectRatio="none">
                      <path id="arcPayout" d="M140,510 C260,600 740,600 860,510" />
                      <path id="arcInner"  d="M210,475 C320,555 680,555 790,475" />
                      <path class="markLine" d="M160,515 C280,610 720,610 840,515" />
                      <path class="markDots" d="M210,478 C320,558 680,558 790,478" />

                      <text font-size="28" class="markText">
                        <textPath href="#arcPayout" startOffset="50%" text-anchor="middle" data-i18n="title.payout">
                          BLACKJACK PAYS 3 TO 2
                        </textPath>
                      </text>

                      <text font-size="20" class="markText" style="letter-spacing:.22em;">
                        <textPath href="#arcInner" startOffset="50%" text-anchor="middle" data-i18n="title.payout">
                          INSURANCE PAYS 2 TO 1
                        </textPath>
                      </text>

                      <!-- å°ã•ã„ãƒ«ãƒ¼ãƒ«ã®è¡Œ -->
                      <text x="500" y="100" text-anchor="middle" font-size="20" class="markSmall">
                        DEALER MUST DRAW TO 16 AND STAND ON 17 â€¢ 6 DECKS â€¢ HOUSE RULES APPLY
                      </text>
                    </svg>

                    <!-- ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ -->
                    <div class="dealerZone">
                      <div class="handBox" id="dealerBox">
                        <div class="row" style="justify-content:space-between;">
                          <div>
                            <b>Dealer</b>
                            <span class="muted" id="dealerScoreLine"></span>
                          </div>
                          <div class="badge" id="dealerHole">-</div>
                        </div>
                        <div class="cards" id="dealerCards"></div>
                      </div>
                    </div>

                    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
                    <div class="playerZone">
                      <div class="handArea" id="playerHands"></div>

                      <div class="banner" id="roundBanner" style="display:none;">
                        <div class="msg neutral" id="roundMsg">-</div>
                        <div class="muted" id="roundMeta">-</div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div><!-- /tableStage -->
          </div>
        </div>

  <!-- ä¸‹éƒ¨ãƒ‰ãƒƒã‚¯ -->
  <!-- ä¸‹éƒ¨ãƒ‰ãƒƒã‚¯ -->
  <nav class="dock full" aria-label="main controls">
    <!-- è¡Œ1 (ãƒ¢ãƒã‚¤ãƒ«) / å·¦ (ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—) -->
    <button class="btn primary" id="btnDeal" disabled><span data-i18n="dock.deal">DEAL</span></button>
    <button class="btn secondary small" id="btnDebugAce" disabled style="margin-left:4px; font-size:10px; padding:0 8px;">ACE</button>
    <button class="btn" id="btnHit" disabled><span data-i18n="dock.hit">HIT</span></button>
    <button class="btn" id="btnStand" disabled><span data-i18n="dock.stand">STAND</span></button>
    
    <!-- è¡Œ2 (ãƒ¢ãƒã‚¤ãƒ«) / å³ (ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—) -->
    <button class="btn" id="btnDouble" disabled><span data-i18n="cmd.double">DBL</span></button>
    <button class="btn" id="btnSplit" disabled><span data-i18n="cmd.split">SPLIT</span></button>
    
    <button class="btn danger" id="btnSurrender" disabled><span data-i18n="cmd.surrender">SURR</span></button>
    <button class="btn" id="btnEvenMoney" disabled style="display:none;"><span data-i18n="cmd.even_money">EVEN</span></button>
  </nav>
          </div><!-- /bd (CASINO TABLE) -->
        </div><!-- /card (CASINO TABLE) -->
      </div><!-- /grid -->
    </div><!-- /screenGame -->

  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->

  <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ãƒ•ãƒ­ãƒ¼ -->
  <div class="overlay" id="overlaySessionOver">
    <div class="modal">
      <div class="hd">
        <b>SESSION</b>
        <span class="badge neutral" id="soBadge">OVER</span>
      </div>
      <div class="bd">
        <div class="soSplash" id="soSplash">
          <div class="soBig" id="soBigText" data-i18n="so.session_over">SESSION OVER!!</div>
          <div class="soSub" id="soSubText" data-i18n="so.calculating">é›†è¨ˆä¸­â€¦</div>
        </div>

        <div class="soResults" id="soResults">
          <div class="soStats" id="soStats"></div>

          <div class="soLockRow">
            <div class="soLockNote" id="soLockNote" data-i18n="so.wait">Please waitâ€¦</div>
            <div class="soLockNote" id="soAdNote"></div>
          </div>

          <div class="soBannerWrap" id="soBannerWrap">
            <div class="muted" style="font-size:12px; margin-bottom:6px;" data-i18n="so.sponsored">Sponsored</div>
            <div id="cg-so-banner"></div>
          </div>

          <div class="row soBtns">
            <button class="btn ghost" id="btnSOTitle" disabled data-i18n="so.to_title">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
            <button class="btn primary" id="btnSORetry" disabled data-i18n="so.retry">EARN 5000 & RETRY</button>
          </div>
          <div class="row soBtns" id="soReviveRow" style="justify-content:center; margin-top:10px; display:none;">
             <button class="btn good" id="btnSORevive" style="width:100%; font-size:15px; padding:14px;" data-i18n="so.revive">
               ğŸ“º Watch Ad to Revive (+500)
             </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlayPause">
    <div class="modal">
      <div class="hd">
        <b data-i18n="pause.title">PAUSED</b>
        <button class="btn ghost" id="btnClosePause" data-i18n="pause.close">Close</button>
      </div>
      <div class="bd">
        <p class="muted" style="margin-top:0;" data-i18n="pause.msg">
          ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯çµ‚äº†ã—ã¾ã›ã‚“ã€‚<b>Continue</b>ã§å¾©å¸°ã€<b>Quit</b>ã§ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Œã¾ã™ã€‚
        </p>
        <div class="row" style="justify-content:flex-end; gap:10px;">
          <button class="btn" id="btnHowPause" data-i18n="title.how">éŠã³æ–¹</button>
          <button class="btn primary" id="btnContinue" data-i18n="pause.continue">Continue</button>
          <button class="btn danger" id="btnQuit" data-i18n="pause.quit">Quit to Title</button>
        </div>
      </div>
    </div>
  </div>
<!-- éŠã³æ–¹ -->
<div class="overlay" id="overlayHow">
  <div class="modal wide">
    <div class="hd">
      <b data-i18n="how.title">HOW TO PLAY</b>
      <button class="btn ghost" id="btnCloseHow" data-i18n="how.close">Close</button>
    </div>
    <div class="bd">
      
      <div class="rule-sec">
        <b data-i18n="how.goal_title">GOAL</b>
        <div data-i18n="how.goal_text">Beat the dealer...</div>
      </div>

      <div class="rule-sec">
        <b data-i18n="how.val_title">CARD VALUES</b>
        <div data-i18n="how.val_text">2-10...</div>
      </div>

      <div class="rule-sec">
        <b data-i18n="how.act_title">ACTIONS</b>
        <div class="rule-list">
          <div class="rule-item" data-i18n="how.act_hit">HIT</div>
          <div class="rule-item" data-i18n="how.act_stand">STAND</div>
          <div class="rule-item" data-i18n="how.act_double">DOUBLE</div>
          <div class="rule-item" data-i18n="how.act_split">SPLIT</div>
          <div class="rule-item" data-i18n="how.act_surrender">SURRENDER</div>
          <div class="rule-item" data-i18n="how.act_insurance">INSURANCE</div>
        </div>
      </div>

      <div class="row" style="align-items:flex-start; gap:24px; flex-wrap:wrap;">
        <div class="rule-sec" style="flex:1; min-width:240px;">
          <b data-i18n="how.dlr_title">DEALER RULES</b>
          <div data-i18n="how.dlr_text">Dealer must draw...</div>
        </div>

        <div class="rule-sec" style="flex:1; min-width:240px;">
          <b data-i18n="how.pay_title">PAYOUTS</b>
          <div style="display:flex; gap:10px; flex-wrap:wrap; font-size:13px; font-weight:bold;">
            <span class="pill" style="background:rgba(255,215,0,.15); color:#ffd700; padding:6px 10px;" data-i18n="how.pay_bj">BJ 3:2</span>
            <span class="pill" style="background:rgba(255,255,255,.1); padding:6px 10px;" data-i18n="how.pay_win">Win 1:1</span>
            <span class="pill" style="background:rgba(255,255,255,.1); padding:6px 10px;" data-i18n="how.pay_ins">Ins 2:1</span>
          </div>
        </div>
      </div>

      <div class="muted small" style="margin-top:16px; border-top:1px solid rgba(255,255,255,.1); padding-top:10px;">
        <span data-i18n="how.note">Note...</span>
      </div>

    </div>
  </div>
</div>

<!-- å±¥æ­´ -->
<div class="overlay" id="overlayHistory">
  <div class="modal">
    <div class="hd">
      <b data-i18n="hist.title">HISTORY</b>
      <button class="btn ghost" id="btnCloseHistory" data-i18n="hist.close">Close</button>
    </div>
    <div class="bd">
      <p class="muted small" style="margin-top:0;" data-i18n="hist.msg">
        ç›´è¿‘ã®ãƒ©ã‚¦ãƒ³ãƒ‰çµæœã‚’è¨˜éŒ²ã—ã¦ã„ã¾ã™ï¼ˆæœ€å¤§ 100 ä»¶ï¼‰ã€‚ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¦ã‚‚ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
      </p>
      <div class="handBox" id="historyList"
           style="max-height:320px; overflow:auto; margin-top:10px;">
        <div class="small muted">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>
    </div>
  </div>
</div>

<!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
<div class="overlay" id="overlayRanking">
  <div class="modal">
    <div class="hd">
      <b data-i18n="rank.title">RANKING</b>
      <button class="btn ghost" id="btnCloseRanking" data-i18n="rank.close">Close</button>
    </div>
    <div class="bd">
      <p class="muted small" style="margin-top:0;" data-i18n="rank.msg">
        ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœï¼ˆProfité †ï¼‰ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ï¼ˆæœ€å¤§ 50 ä»¶ï¼‰ã€‚
      </p>

      <div class="row" style="justify-content:space-between; margin-top:10px;">
        <div class="muted small" data-i18n="rank.name">Nameï¼ˆä»»æ„ï¼‰</div>
        <input id="nameInput" type="text" maxlength="12" placeholder="YOU" style="width:180px;">
      </div>

      <div class="handBox" id="rankingList"
           style="max-height:320px; overflow:auto; margin-top:10px;">
        <div class="small muted">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>
      <!-- ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®è¨˜éŒ²ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€ -->
      <!-- <div class="row" style="justify-content:flex-end; margin-top:10px; gap:10px;">
        <button class="btn danger" id="btnClearRanking">Clear</button>
      </div> -->
    </div>
  </div>
</div>



<!-- ã‚¤ãƒ³ã‚·ãƒ¥ãƒ©ãƒ³ã‚¹ (ã¼ã‹ã—ç„¡ã—) -->
<div class="overlay no-blur" id="overlayInsurance">
  <div class="modal">
    <div class="hd">
      <b data-i18n="ins.title">INSURANCE?</b>
    </div>
    <div class="bd">
      <div style="text-align:center; padding:20px 0;">
        <div class="soBig" style="font-size:32px; margin-bottom:10px;">DEALER ACE</div>
        
        <p class="muted" style="margin-bottom:20px;">
          ã‚¤ãƒ³ã‚·ãƒ¥ãƒ©ãƒ³ã‚¹ã«è³­ã‘ã¾ã™ã‹ï¼Ÿ
        </p>

        <!-- ãƒœã‚¿ãƒ³è¡Œ: Yes(å·¦), No(å³) -->
        <div class="row" style="justify-content:center; gap:24px; margin-bottom: 20px;">
          <button class="btn primary big" id="btnInsYes" style="min-width:140px;" data-i18n="ins.yes">YES</button>
          <button class="btn danger big" id="btnInsNo" style="min-width:140px;" data-i18n="ins.no">NO</button>
        </div>

        <!-- å…¥åŠ›è¡Œ -->
        <div class="row" style="justify-content:center; gap:10px; margin-bottom:8px;">
            <input id="insAmountOverlay" type="number" value="0" step="10" 
                   style="width:100px; padding:8px; background:rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.2); color:#fff; border-radius:8px; font-size:16px; text-align:center;">
            <button class="btn ghost" id="btnInsMaxOverlay">MAX</button>
        </div>
        
        <!-- ãƒ’ãƒ³ãƒˆ -->
        <div class="muted small" id="insHintOverlay" style="opacity:0.8;">-</div>

      </div>
    </div>
  </div>
</div>

  <div class="toastWrap" id="toastWrap"></div>

  <script>
    window.CG?.loadingStart?.();
    let prevPhase = null;
    

    // ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
    const $ = (id)=>document.getElementById(id);

    function toast(msg){
      const w = $("toastWrap");
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = msg;
      w.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, 1400);
      setTimeout(()=>{ el.remove(); }, 1900);
    }

    function seed64(){
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return {lo: a[0] >>> 0, hi: a[1] >>> 0};
    }

    function floorEven(x){
      x = Number(x||0);
      if (!Number.isFinite(x)) x = 0;
      if (x < 0) x = 0;
      return Math.floor(x/2)*2;
    }

    function fmtTime(ms){
      ms = Math.max(0, ms|0);
      const s = Math.ceil(ms/1000);
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${String(r).padStart(2,"0")}`;
    }

    document.querySelectorAll("button").forEach(b=>{
      b.addEventListener("click", ()=>{ vibrate(8); });
    });
    // ãƒãƒƒãƒ—ã¯ <button> ã§ã‚ã‚Œã°æ—¢ã«ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹ãŒ
    // ç‰¹å®šã®è¦ç´ ã§æ„Ÿè§¦ã‚’è‰¯ãã™ã‚‹ãŸã‚ã«è¿½åŠ 
    document.querySelectorAll(".chipbtn").forEach(b=>{
       b.addEventListener("touchstart", ()=>{ vibrate(12); }, {passive:true});
    });

    // ========= ãƒãƒ—ãƒ†ã‚£ã‚¯ã‚¹ =========
    function vibrate(ms){
      if (!$("optHaptic") || !$("optHaptic").checked) return;
      if (typeof navigator.vibrate !== "function") return;
      try{ navigator.vibrate(ms); } catch(e){}
    }

    function setEngineBadge(text, kind){
      const b = $("engineBadge");
      const t = $("engineText");
      t.textContent = text;
      b.classList.remove("good","bad");
      if (kind) b.classList.add(kind);
    }

    function animateNumber(el, from, to, duration=520){
      from = Number(from); to = Number(to);
      if (!Number.isFinite(from)) from = 0;
      if (!Number.isFinite(to)) to = 0;
      if (from === to){ el.textContent = String(to); return; }
      const start = performance.now();
      const diff = to - from;
      const ease = (x)=> 1 - Math.pow(1-x, 3);
      const step = (now)=>{
        const t = Math.min(1, (now - start) / duration);
        const v = Math.round(from + diff * ease(t));
        el.textContent = String(v);
        if (t < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

        // ========= å±¥æ­´ (localStorage) =========
    const HISTORY_KEY = "bjHistory_v1";

    function loadHistory(){
      try{
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr;
      } catch(e){
        console.warn("history load failed", e);
        return [];
      }
    }

    function saveHistory(list){
      try{
        localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
      } catch(e){
        console.warn("history save failed", e);
      }
    }

    // ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†æ™‚ã ã‘å‘¼ã³å‡ºã•ã‚Œã‚‹æƒ³å®š
    function pushHistoryEntry(st){
      if (!st) return;

      const phase = st.phase;
      const isEndPhase = (phase === "roundOver" || phase === "sessionOver");
      const wasEndPhase = (prevPhase === "roundOver" || prevPhase === "sessionOver");

      // ã€Œã•ã£ãã¾ã§ã¯ end çŠ¶æ…‹ã˜ã‚ƒãªãã¦ã€ä»Š end çŠ¶æ…‹ã«ãªã£ãŸç¬é–“ã€ã ã‘è¨˜éŒ²
      if (!isEndPhase || wasEndPhase) return;

      const hands = (st.player && st.player.hands) || [];
      const mainHand = hands[0] || {};

      const entry = {
        ts: Date.now(),
        sessionId: currentSessionId,
        round: st.session ? st.session.round : 0,
        bank: ("bank" in st) ? st.bank : 0,
        bet: ("bet" in mainHand) ? mainHand.bet : 0,
        net: (st.roundResult && "netProfit"     in st.roundResult) ? st.roundResult.netProfit     : 0,
        streak: (st.roundResult && "streak"     in st.roundResult) ? st.roundResult.streak       : 0,
        bonusPercent: (st.roundResult && "bonusPercent" in st.roundResult) ? st.roundResult.bonusPercent : 0,
        bonusApplied: (st.roundResult && "bonusApplied" in st.roundResult) ? st.roundResult.bonusApplied : 0,
      };

      const list = loadHistory();
      list.unshift(entry);          // æ–°ã—ã„ã‚‚ã®ã‚’å…ˆé ­ã«
      if (list.length > 100) list.length = 100; // æœ€å¤§100ä»¶
      saveHistory(list);
    }

    function formatHistoryTime(ts){
      const d = new Date(ts);
      const n = +d;
      if (!Number.isFinite(n)) return "-";
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${mm}/${dd} ${hh}:${mi}`;
    }

    function renderHistoryOverlay(){
      const box = $("historyList");
      if (!box) return;
      const hist = loadHistory();
      if (!hist.length){
        box.innerHTML = '<div class="small muted">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        return;
      }

      let html = '<table class="small" style="width:100%; border-collapse:collapse;">';
      html += '<thead><tr>';
      html += '<th style="text-align:left;padding:4px 8px;">Time</th>';
      html += '<th style="text-align:right;padding:4px 8px;">Round</th>';
      html += '<th style="text-align:right;padding:4px 8px;">Bet</th>';
      html += '<th style="text-align:right;padding:4px 8px;">Net</th>';
      html += '<th style="text-align:right;padding:4px 8px;">Bank</th>';
      html += '<th style="text-align:right;padding:4px 8px;">Streak</th>';
      html += '</tr></thead><tbody>';

      hist.slice(0, 40).forEach(e=>{
        const netClass =
          e.net > 0 ? ' style="color:#37d67a;"' :
          e.net < 0 ? ' style="color:#ff4d4d;"' : '';
        html += '<tr>';
        html += `<td style="padding:4px 8px;">${formatHistoryTime(e.ts)}</td>`;
        html += `<td style="padding:4px 8px;text-align:right;">${e.round}</td>`;
        html += `<td style="padding:4px 8px;text-align:right;">${e.bet}</td>`;
        html += `<td style="padding:4px 8px;text-align:right;"${netClass}>${e.net}</td>`;
        html += `<td style="padding:4px 8px;text-align:right;">${e.bank}</td>`;
        html += `<td style="padding:4px 8px;text-align:right;">${e.streak}</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      box.innerHTML = html;
    }

    // ========= ã‚¨ãƒ³ã‚¸ãƒ³ bjApi =========
    // blackjack_ui.js å´ã§ Engine / engineReady / bjApi ã‚’ç”¨æ„ã—ã¦ã„ã‚‹æƒ³å®š
    let Engine = null;
    let bjApi = null;
    let state = null;

function apiReady(){
  if (globalThis.bjApi) bjApi = globalThis.bjApi;
  if (globalThis.Engine) Engine = globalThis.Engine;
  return !!(globalThis.engineReady && Engine && bjApi);
}


    function syncEngine(){
      if (apiReady()){
        setEngineBadge("READY", "good");
        window.CG?.loadingStop?.();
        
        setEngineBadge("READY", "good");
        $("subLine").textContent = "ready.";
        $("btnStart").disabled = false;


        toast("Engine ready!");
        return;
      }
      setEngineBadge("LOADING", null);
      $("subLine").textContent = "loading engineâ€¦";
      requestAnimationFrame(syncEngine);
    }

    // ========= ã‚¿ã‚¤ãƒãƒ¼ =========
    let sessionMs = 300000;
    let startTickAt = 0;
    let pausedAt = 0;
    let pausedTotal = 0;
    let tickHandle = null;
    let lastTimePush = 0;

    function startTick(){
      stopTick();
      startTickAt = performance.now();
      pausedTotal = 0;
      pausedAt = 0;
      lastTimePush = 0;
      tickHandle = setInterval(()=>{
        if (!state) return;
        if (state.phase === "paused") return;

        const now = performance.now();
        const elapsed = now - startTickAt - pausedTotal;
        const left = Math.max(0, sessionMs - elapsed);

        if (now - lastTimePush > 1000){
          bjApi.set_time_left_ms(left|0);
          lastTimePush = now;
          refresh();
        } else {
          $("time").textContent = fmtTime(left|0);
        }
      }, 120);
    }

    function stopTick(){
      if (tickHandle){ clearInterval(tickHandle); tickHandle = null; }
    }

    function rulesMaskFromUI(){
      const RB_ALLOW_DOUBLE      = 1 << 0;
      const RB_ALLOW_SPLIT       = 1 << 1;
      const RB_ALLOW_SURRENDER   = 1 << 2;
      const RB_ALLOW_INSURANCE   = 1 << 3;
      const RB_ALLOW_EVEN_MONEY  = 1 << 4;
      const RB_ALLOW_DAS         = 1 << 5;
      const RB_SPLIT_BJ_AS_BJ    = 1 << 6;
      const RB_DEALER_HIT_S17    = 1 << 7;

      let m = 0;
      if ($("optDouble").checked)   m |= RB_ALLOW_DOUBLE;
      if ($("optSplit").checked)    m |= RB_ALLOW_SPLIT;
      if ($("optSurrender").checked)m |= RB_ALLOW_SURRENDER;
      if ($("optInsurance").checked)m |= RB_ALLOW_INSURANCE;
      if ($("optEvenMoney").checked)m |= RB_ALLOW_EVEN_MONEY;
      if ($("optDAS").checked)      m |= RB_ALLOW_DAS;
      if ($("optSplitBJ").checked)  m |= RB_SPLIT_BJ_AS_BJ;
      if ($("optH17").checked)      m |= RB_DEALER_HIT_S17;
      return m >>> 0;
    }

    function refresh(){
      //if (!state) return;
      if (!bjApi) return;
      const p = bjApi.get_state_json();
      const s = Engine.UTF8ToString(p);
      bjApi.free_ptr(p);
      state = JSON.parse(s);
      render();
      return state;
    }

    function callAction(fnName, ...args){
      const rc = bjApi[fnName](...args);
      const st = refresh();
      if (rc !== 0 || st.lastErrorCode !== 0){
        if (st.lastError) toast(st.lastError);
        console.warn("action", fnName, "rc=", rc, "err=", st.lastErrorCode, st.lastError);
      }
      return rc;
    }

function goScreen(name){
  const wasGame = $("screenGame").classList.contains("active");
  const willGame = (name === "game");

  $("screenTitle").classList.toggle("active", name==="title");
  $("screenGame").classList.toggle("active", willGame);
  
  // Hide title text in game
  document.querySelector(".topbar").classList.toggle("in-game", willGame);

  // CrazyGames: ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã®ã‚ªãƒ³/ã‚ªãƒ•
  if (willGame && !wasGame) window.CG?.gameplayStart?.();
  if (!willGame && wasGame) window.CG?.gameplayStop?.();
}

function setPause(paused) {
    if (paused) {
        $("overlayPause").classList.add("show");
        window.CG?.gameplayStop?.();
    } else {
        $("overlayPause").classList.remove("show");
        window.CG?.gameplayStart?.();
    }
}

//a
    // ========= ãƒªã‚»ãƒƒãƒˆ =========
    let resetArmed = false;
    let holdTimer = null;
    let holdStart = 0;


    function doResetToTitle(){
      stopTick();
      stopTick();
      callAction("reset_session");
      $("overlayPause").classList.remove("show");
      $("overlaySessionOver") && $("overlaySessionOver").classList.remove("show");
      // try{ window.CrazyGames?.SDK?.banner?.clearBanner?.(window.SO?.bannerId || "cg-so-banner"); }catch(e){}
      $("overlayHow").classList.remove("show");
      $("overlayMore") && $("overlayMore").classList.remove("show");
      $("overlayHistory") && $("overlayHistory").classList.remove("show");
      goScreen("title");

      $("subLine").textContent = t("ui.ready");
      toast(t("toast.reset_done"));
      // animation caches reset
      prevDealerCards = [];
      prevPlayerLens = [];
      prevBank = null;
    }

    // ========= ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ =========
    let prevBank = null;
    let prevDealerCards = [];
    let prevDealerJson = ""; // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let prevPlayerLens = [];
    let prevPlayerJson = ""; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let hideBoardAfterSet = false;   // â† ã“ã‚Œã‚’è¿½åŠ ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰

    // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼æç”»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
    let dealerShowCount = 0;
    let dealerAnimTimer = null;



// ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ãƒ•ãƒ­ãƒ¼ =====
// ä»•æ§˜ï¼šsessionOverã«å…¥ã£ãŸã‚‰
//   1) ä¸­å¤®ã« "SESSION OVER!!" ã‚’ 2ç§’è¡¨ç¤º
//   2) ãƒªã‚¶ãƒ«ãƒˆè¡¨ç¤ºã«åˆ‡æ›¿
//   3) ãã“ã‹ã‚‰æœ€ä½5ç§’ã¯ãƒœã‚¿ãƒ³æ“ä½œä¸å¯
//   4) ãã®é–“ã« midgameåºƒå‘Šã‚’è‡ªå‹•ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒœã‚¿ãƒ³ç´ã¥ã‘ç„¡ã—ï¼‰
//   5) 5ç§’çµŒé AND åºƒå‘Šçµ‚äº†ï¼ˆor error/unfilledï¼‰ã—ãŸã‚‰ãƒœã‚¿ãƒ³è§£æ”¾
window.SO = window.SO || {
  active:false,
  lockUntil:0,
  adDone:false,
  unlockTimer:null,
  splashTimer:null,
  adFailSafe:null,
  bannerShown:false,
  bannerId:"cg-so-banner",
  sessionCount:0, // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›æ•°ã‚«ã‚¦ãƒ³ã‚¿
};

function soSetView(stage){
  const splash = document.getElementById("soSplash");
  const results = document.getElementById("soResults");
  if (!splash || !results) return;
  splash.style.display  = (stage === "splash")  ? "flex"  : "none";
  results.style.display = (stage === "results") ? "block" : "none";
}

function soSetButtonsEnabled(enabled){
  const b1 = document.getElementById("btnSOTitle");
  const b2 = document.getElementById("btnSORetry");
  if (b1) b1.disabled = !enabled;
  if (b2) b2.disabled = !enabled;
}

function soClearTimers(){
  if (window.SO.unlockTimer){ clearInterval(window.SO.unlockTimer); window.SO.unlockTimer=null; }
  if (window.SO.splashTimer){ clearTimeout(window.SO.splashTimer); window.SO.splashTimer=null; }
  if (window.SO.adFailSafe){ clearTimeout(window.SO.adFailSafe); window.SO.adFailSafe=null; }
}

function soHideOverlay(){
  const ov = document.getElementById("overlaySessionOver");
  if (ov) ov.classList.remove("show");
  if (typeof ENABLE_ADS !== "undefined" && ENABLE_ADS) {
      // try{ window.CrazyGames?.SDK?.banner?.clearBanner?.(window.SO.bannerId); }catch(e){}
  }
  window.SO.bannerShown = false;
  window.SO.active = false;
  window.SO.adDone = false;
  soClearTimers();
}

function soFillStats(st){
  const stats = document.getElementById("soStats");
  if (!stats || !st) return;

  let totalNet = 0, maxStreak = 0;
  try{
    const hist = (typeof loadHistory === "function" && currentSessionId)
      ? loadHistory().filter(e => e.sessionId === currentSessionId)
      : [];
    totalNet = hist.reduce((a,e)=> a + (e.net|0), 0);
    maxStreak = hist.reduce((a,e)=> Math.max(a, e.streak|0), 0);
  }catch(e){}

  const finalBank = st.bank|0;
  const profit = finalBank - (sessionStartBank|0);

  const durMs = Math.max(0, (performance.now() - (startTickAt||0) - (pausedTotal||0)));
  const rounds = st.session ? `${st.session.round}/${st.session.roundLimit}` : "-";
  const timeLeft = st.session ? fmtTime(st.session.timeLeftMs) : "-";

  const items = [
    ["Final Bank", String(finalBank)],
    ["Profit", (profit>=0? "+":"") + String(profit)],
    ["Total Net", (totalNet>=0? "+":"") + String(totalNet)],
    ["Max Streak", String(maxStreak)],
    ["Rounds", rounds],
    ["Time Left", timeLeft],
    ["Duration", fmtTime(durMs)],
  ];

  stats.innerHTML = "";
  items.forEach(([k,v])=>{
    const el = document.createElement("span");
    el.className = "soStat";
    el.innerHTML = `<span class="k">${k}</span><b class="v">${v}</b>`;
    stats.appendChild(el);
  });

  // å¾©æ´»ãƒœã‚¿ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
  const reviveRow = document.getElementById("soReviveRow");
  if (st.bank <= 0 && st.session.timeLeftMs > 0 && st.session.round < st.session.roundLimit) {
      if(reviveRow) reviveRow.style.display = "flex";
  } else {
      if(reviveRow) reviveRow.style.display = "none";
  }
}

async function soRequestBanner(){
  if (window.SO.bannerShown) return;
  if (typeof ENABLE_ADS !== "undefined" && !ENABLE_ADS) return; // åºƒå‘Šç„¡åŠ¹

  const wrap = document.getElementById("soBannerWrap");
  if (wrap) wrap.style.display = "none";

  try{
    await window.CG?.p;
    if (!window.CG?.ready) throw 0;
    // await window.CrazyGames?.SDK?.banner?.requestResponsiveBanner?.(window.SO.bannerId);
    window.SO.bannerShown = true;
    if (wrap) wrap.style.display = "block";
  }catch(e){
    if (wrap) wrap.style.display = "none";
  }
}

function soRequestMidgame(){
  const note = document.getElementById("soAdNote");

  if (typeof ENABLE_ADS !== "undefined" && !ENABLE_ADS) {
     // åºƒå‘Šç„¡åŠ¹ï¼šå³ã‚¹ã‚­ãƒƒãƒ—
    window.SO.adDone = true;
    if (note) note.textContent = "";
    soUpdateLock();
    return;
  }

  // 2ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«åºƒå‘Šã‚’è¡¨ç¤º (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›: "every 2 sessions")
  // sessionCount ã¯ beginSessionOverFlow ã§ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹
  // 1å›ç›®: 1 -> ã‚¹ã‚­ãƒƒãƒ—
  // 2å›ç›®: 2 -> è¡¨ç¤º
  // 3å›ç›®: 3 -> ã‚¹ã‚­ãƒƒãƒ—
  if (window.SO.sessionCount % 2 !== 0){
    console.log("Skip ad (session count: " + window.SO.sessionCount + ")");
    window.SO.adDone = true;
    if (note) note.textContent = "";
    soUpdateLock();
    return;
  }


  const finish = () => {
    window.SO.adDone = true;
    if (note) note.textContent = "";
    soUpdateLock();
  };

  window.SO.adDone = false;
  if (note) note.textContent = t("so.calculating");

  try{
    const callbacks = {
      adStarted: () => { if (note) note.textContent = "Ad playingâ€¦"; },
      adFinished: finish,
      adError: () => finish(),
    };
    // window.CrazyGames?.SDK?.ad?.requestAd?.("midgame", callbacks);
  }catch(e){
    finish();
  }

  window.SO.adFailSafe = setTimeout(finish, 15000);
}

function doRevive(){
    if (window.SO.adReviveActive) return;

    if (typeof ENABLE_ADS !== "undefined" && !ENABLE_ADS) {
        // toast("Ads are disabled in this version.");
        console.log("Ads differred for Basic Launch");
        return;
    }
    window.SO.adReviveActive = true;
    const btn = document.getElementById("btnSORevive");
    const origText = btn.textContent;
    btn.textContent = "Loading Ad...";
    btn.disabled = true;

    const finish = (success) => {
        window.SO.adReviveActive = false;
        btn.textContent = origText;
        btn.disabled = false;
        
        if (success) {
            callAction("revive", 500); // 500ãƒãƒƒãƒ—ã§å¾©æ´»
            soHideOverlay();
            window.CG?.gameplayStart?.();
            toast("Revived with 500 chips!");
        } else {
            toast("Ad failed. Try again.");
        }
    };

    try {
        const callbacks = {
          adFinished: () => finish(true),
          adError: (error) => {
              console.warn("Reward ad error:", error);
              finish(false);
          },
        };
        // window.CrazyGames?.SDK?.ad?.requestAd?.("rewarded", callbacks);
    } catch(e) {
        console.error(e);
        finish(false);
    }
}

function soUpdateLock(){
  const lockNote = document.getElementById("soLockNote");
  const remain = Math.max(0, window.SO.lockUntil - performance.now());

  if (remain > 0){
    if (lockNote) lockNote.textContent = `${t("js.result_showing")} (${(remain/1000).toFixed(1)}s)`;
    return;
  }
  if (!window.SO.adDone){
    if (lockNote) lockNote.textContent = t("js.ad_waiting");
    return;
  }
  if (lockNote) lockNote.textContent = t("js.selectable");
  soSetButtonsEnabled(true);
  if (window.SO.unlockTimer){ clearInterval(window.SO.unlockTimer); window.SO.unlockTimer=null; }
}

function beginSessionOverFlow(st){
  if (window.SO.active) return;
  window.SO.active = true;

  // çµæœã‚’è¦‹ã›ã‚‹ãŸã‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºå‰ã«4ç§’å¾…æ©Ÿ
  toast(t("so.delay"));
  setTimeout(() => {
    window.SO.adDone = false;
    window.SO.bannerShown = false;
    window.SO.sessionCount = (window.SO.sessionCount || 0) + 1; // ã‚«ã‚¦ãƒ³ã‚¿ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    soClearTimers();


    const ov = document.getElementById("overlaySessionOver");
    if (ov) ov.classList.add("show");
    soSetButtonsEnabled(false);
    soSetView("splash");

    window.CG?.gameplayStop?.();

    window.SO.splashTimer = setTimeout(()=>{
      soSetView("results");
      soFillStats(st);

      window.SO.lockUntil = performance.now() + 5000;
      soSetButtonsEnabled(false);
      soUpdateLock();

      soRequestBanner();
      soRequestMidgame();

      window.SO.unlockTimer = setInterval(soUpdateLock, 100);
    }, 2000);
  }, 2000);
}


    // ========= æç”»å‡¦ç† =========
    function render(){

      function setDis(id, disabled){
        const el = document.getElementById(id);
        if (el) el.disabled = !!disabled;
      }

      if (!state) return;

      const phase = state.phase;
      // roundOver / sessionOver ä»¥å¤–ã®ãƒ•ã‚§ãƒ¼ã‚ºã«ç§»ã£ãŸã‚‰ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
      if (phase !== "roundOver" && phase !== "sessionOver") {
        hideBoardAfterSet = false;
      }
      const hideBoard =
        hideBoardAfterSet && (phase === "roundOver" || phase === "sessionOver");
      
      if($("debugPhase")) {
          $("debugPhase").style.display = "flex"; 
          $("debugPhase").textContent = "phase: " + state.phase;
      }
      
      if($("subLine") && $("screenGame") && $("screenGame").classList.contains("active")) {
          $("subLine").textContent = `phase: ${state.phase}`;
      }

      // æ‰€æŒé‡‘ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const bankEl = $("bank");
      const bankPill = bankEl.closest(".pill");
      const newBank = Number(state.bank);
      if (prevBank === null){
        bankEl.textContent = String(newBank);
      } else if (prevBank !== newBank){
        animateNumber(bankEl, prevBank, newBank, 520);
        bankPill.classList.remove("bankFlash"); void bankPill.offsetWidth; bankPill.classList.add("bankFlash");
      }
      prevBank = newBank;

      $("round").textContent = `${state.session.round}/${state.session.roundLimit}`;
      $("time").textContent = fmtTime(state.session.timeLeftMs);

      if ($("phaseBadge")) $("phaseBadge").textContent = state.phase;
      $("rulesMini").textContent = [
        state.rules.allowDouble ? "Dbl" : "",
        state.rules.allowSplit ? "Spl" : "",
        state.rules.allowSurrender ? "Sur" : "",
        state.rules.allowInsurance ? "Ins" : "",
        state.rules.allowEvenMoney ? "EM" : "",
        state.rules.allowDAS ? "DAS" : "",
        state.rules.splitBJAsBJ ? "SplitBJ" : "",
        state.rules.dealerHitSoft17 ? "H17" : "S17"
      ].filter(Boolean).join(" â€¢ ") || "-";

      // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼
      const totalText = hideBoard
        ? "-"
        : (state.dealer.holeKnown ? String(state.dealer.score) : "?");

      const shownText = hideBoard ? "-" : state.dealer.scoreShown;

      $("dealerScoreLine").innerHTML = `
        <span class="metaLine">
          <span class="kv"><span class="k">Shown</span><b class="v">${shownText}</b></span>
          <span class="kv"><span class="k">Total</span><b class="v">${totalText}</b></span>
        </span>
      `;

      $("dealerHole").textContent = hideBoard
        ? "-"
        : (state.dealer.holeKnown ? t("dyn.hole_open") : t("dyn.hole_hidden"));


      const dWrap = $("dealerCards");
      let rawDealerCards = hideBoard ? [] : (state.dealer.cards || []);

      // --- ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
      const targetCount = rawDealerCards.length;
      const isRoundOver = (state.phase === "roundOver" || state.phase === "sessionOver");
      //const isRoundOver = (state.phase === "roundOver" || state.phase === "sessionOver");

      if (!isRoundOver) {
        // ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ä»¥å¤–ã¯å³åº§ã«å…¨ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆåŒæœŸï¼‰
        if (dealerAnimTimer) { clearTimeout(dealerAnimTimer); dealerAnimTimer = null; }
        dealerShowCount = targetCount;
      } else {
        // ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†æ™‚ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã‹ç¢ºèª
        if (dealerShowCount === 0 && targetCount > 0 && !dealerAnimTimer) {
             // åˆå›ãƒ­ãƒ¼ãƒ‰ã§ã„ããªã‚Š roundOver ã ã£ãŸå ´åˆãªã©ã¯æ—©é€ã‚Š
             dealerShowCount = targetCount;
        } else if (dealerShowCount < targetCount) {
             // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¿…è¦
             if (!dealerAnimTimer) {
                 dealerAnimTimer = setTimeout(() => {
                     dealerShowCount++;
                     dealerAnimTimer = null;
                     render(); // æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚å†æç”»ãƒˆãƒªã‚¬ãƒ¼
                 }, 600);
             }
        } else {
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†
             if (dealerAnimTimer) { clearTimeout(dealerAnimTimer); dealerAnimTimer = null; }
        }
      }
      
      const isDealerAnimating = (dealerShowCount < targetCount);
      // ã‚«ã‚¦ãƒ³ãƒˆã«åŸºã¥ã„ã¦ã‚«ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šå‡ºã™
      const dealerCards = rawDealerCards.slice(0, dealerShowCount);

      // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯

      const dealerJson = JSON.stringify({
         cards: dealerCards,
         holeKnown: state.dealer.holeKnown,
         scoreShown: state.dealer.scoreShown,
         score: state.dealer.score
      });
      
      if (dealerJson !== prevDealerJson) {
        dWrap.innerHTML = "";
        dealerCards.forEach((c, idx)=>{

        const el = document.createElement("div");
        const prev = prevDealerCards[idx];

        if (c === "?"){
          el.className = "cardBack";
        } else {
          el.className = "cardFace";
          el.textContent = c;
        }

        const isNew = idx >= prevDealerCards.length;
        const reveal = (prev === "?" && c !== "?");
        if (isNew) el.classList.add("dealIn");
        if (reveal) el.classList.add("flipIn");

        dWrap.appendChild(el);
        dWrap.appendChild(el);
      });
      } // DealerJson ãƒã‚§ãƒƒã‚¯çµ‚äº†
      prevDealerCards = dealerCards.slice();

      prevDealerJson = dealerJson; // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥


      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒ³ãƒ‰
      const ph = $("playerHands");
      const hands =
        (!hideBoard && state.player && state.player.hands)
          ? state.player.hands
          : [];


      
      const playerJson = JSON.stringify(hands.map(h => ({
        cards: h.cards,
        score: h.score,
        bet: h.bet,
        flags: h.flags,
        active: (hands.indexOf(h) === state.player.activeHandIndex)
      })));

      if (playerJson !== prevPlayerJson) {
        ph.innerHTML = "";
        hands.forEach((h, i)=>{

        const box = document.createElement("div");
        box.className = "handBox" + (i === state.player.activeHandIndex ? " active" : "");

        const flags = [];
        if (h.flags.blackjack) flags.push("BJ");
        if (h.flags.bust) flags.push("BUST");
        if (h.flags.doubled) flags.push("DBL");
        if (h.flags.surrendered) flags.push("SUR");
        if (h.flags.fromSplit) flags.push("SPLIT");
        if (h.flags.splitAces) flags.push("A-SPLIT");

        const badgeClass =
          h.flags.blackjack ? "good" :
          (h.flags.bust || h.flags.surrendered) ? "bad" : "";

        const header = document.createElement("div");
        header.className = "row";
        header.style.justifyContent = "space-between";
header.innerHTML = `
  <div>
    <b>Player ${hands.length > 1 ? `Hand ${i + 1}` : ""}</b>
    <div class="metaLine" style="margin-top:6px;">
      <span class="kv"><span class="k">Score</span><b class="v">${h.score}</b></span>
      <span class="kv"><span class="k">Bet</span><b class="v">${h.bet}</b></span>
    </div>
  </div>
  <div class="badge ${badgeClass}">${flags.length ? flags.join(" â€¢ ") : t("dyn.playing")}</div>
`;

        box.appendChild(header);

        const cards = document.createElement("div");
        cards.className = "cards";
        const prevLen = prevPlayerLens[i] ?? 0;

        (h.cards||[]).forEach((cc, idx)=>{
          const ce = document.createElement("div");
          ce.className = "cardFace";
          ce.textContent = cc;
          if (idx >= prevLen) ce.classList.add("dealIn"); // â‘£A ã‚¹ãƒ©ã‚¤ãƒ‰
          cards.appendChild(ce);
        });

        box.appendChild(cards);
        ph.appendChild(box);

        prevPlayerLens[i] = (h.cards||[]).length;
        prevPlayerLens[i] = (h.cards||[]).length;
      });
      } // playerJson ãƒã‚§ãƒƒã‚¯çµ‚äº†
      prevPlayerJson = playerJson; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥




      // state.can ã«åŸºã¥ãæ“ä½œã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–
// state.can ã«åŸºã¥ãæ“ä½œã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–
const can = state.can || {};
const insMode = (state.phase === "offerInsurance");

// === ãƒ‰ãƒƒã‚¯ã®ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ ===
if (insMode) {
  // Insurance ä¸­ã¯ DOCK = YES / NO å°‚ç”¨
  setDis("btnDeal", true);
  setDis("btnDebugAce", true);
  setDis("btnHit", !can.insurance);
  setDis("btnStand", !can.insurance);
  setDis("btnDouble", true);
  setDis("btnSplit", true);
  setDis("btnSurrender", true);
} else {
  // ãƒ™ãƒƒãƒ†ã‚£ãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒ­ã‚¸ãƒƒã‚¯
  const forceEnableDeal = ((state.phase === "betting" || state.phase === "roundOver") && state.bank > 0);
  setDis("btnDeal", (!can.deal && !forceEnableDeal) || uiLocked);
  setDis("btnDebugAce", (!can.deal && !forceEnableDeal) || uiLocked);

  setDis("btnHit", !can.hit || uiLocked);
  setDis("btnStand", !can.stand || uiLocked); // Stand ã‚‚ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³é˜²æ­¢ã§ãƒ­ãƒƒã‚¯ï¼Ÿ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«Deal/Hitã—ã¦ã‚‹ã€‚
  // ã—ã‹ã—é€šå¸¸ Stand ã¯ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãƒ—ãƒ¬ã‚¤ã«ç¹‹ãŒã‚‹ã®ã§ãƒ­ãƒƒã‚¯ã¯å®‰å…¨ã€‚
  // Double/Split -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œä¾‹å¤–ã€ã¨è¨€ã£ãŸã®ã§ã€uiLocked ã¯è¿½åŠ ã—ãªã„
  setDis("btnDouble", !can.double);
  setDis("btnSplit", !can.split);
  setDis("btnSurrender", !can.surrender);
}

// ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å†…éƒ¨ãƒ™ãƒƒãƒˆçŠ¶æ…‹ã¨åŒæœŸï¼ˆå¿…è¦ãªå ´åˆï¼‰
// setDis("betSelect", !(state.phase === "betting" || state.phase === "roundOver"));

// === å³ãƒ‘ãƒãƒ«å´ã‚‚åŒæ§˜ ===
if (insMode) {
  // ã‚¤ãƒ¼ãƒ–ãƒ³ãƒãƒãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯: å¯èƒ½ãªã‚‰ã‚µãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã¨å…¥ã‚Œæ›¿ãˆ
  const showEven = !!can.evenMoney;
  const btnSur = $("btnSurrender");
  const btnEven = $("btnEvenMoney");
  
  if (showEven) {
      if(btnSur) btnSur.style.display = "none";
      if(btnEven) { btnEven.style.display = "flex"; btnEven.disabled = false; }
  } else {
      if(btnSur) { btnSur.style.display = "flex"; btnSur.disabled = !can.surrender; }
      if(btnEven) btnEven.style.display = "none";
  }
}
// ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ãƒ­ã‚¸ãƒƒã‚¯å‰Šé™¤æ¸ˆ

       // const isRoundOver = (state.phase === "roundOver" || state.phase === "sessionOver");
      // ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚ã‚ã£ãŸç¬é–“ã ã‘å±¥æ­´ã«è¿½åŠ 
      pushHistoryEntry(state);
      finalizeSessionRanking(state);
      if (state.phase === "sessionOver") beginSessionOverFlow(state);

      $("roundBanner").style.display = (isRoundOver && !isDealerAnimating) ? "flex" : "none";

      // å‹åˆ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ãƒˆãƒªã‚¬ãƒ¼
      if (isRoundOver) {
         if (!isDealerAnimating) {
            const net = state.roundResult.netProfit;
            if (!winEffectDone && net > 0) {
                window.triggerWinEffect && window.triggerWinEffect();
                winEffectDone = true;
            }
         }
      } else {
         winEffectDone = false;
      }


      const net = state.roundResult.netProfit|0;
      const msgEl = $("roundMsg");
      const metaEl = $("roundMeta");
      if (isRoundOver){
        /*
        // "WIN +100" ç­‰ã‚’2ç§’ã®é…å»¶ä¸­ã‚‚è¡¨ç¤ºã—ãŸã¾ã¾ã«ã™ã‚‹
        if (state.phase === "sessionOver"){
          msgEl.textContent = t("so.session_over");
          msgEl.className = "msg neutral";
        } else */
        if (net > 0){
          msgEl.textContent = `${t("dyn.win")} +${net}`;
          msgEl.className = "msg win";
        } else if (net < 0){
          msgEl.textContent = `${t("dyn.lose")} ${net}`;
          msgEl.className = "msg lose";
        } else {
          msgEl.textContent = `${t("dyn.push")} Â±0`;
          msgEl.className = "msg neutral";
        }
        metaEl.textContent = `${t("dyn.streak")} ${state.roundResult.streak} / ${t("dyn.bonus")} ${state.roundResult.bonusPercent}% (+${state.roundResult.bonusApplied})`;
      }



      const v = floorEven($("betInput").value);
      $("betHint").textContent = `${t("dyn.input")}=${$("betInput").value} â†’ ${t("dyn.even")}=${v}`;


      // ===== ãƒ™ãƒƒãƒˆã®ãƒ­ãƒƒã‚¯/ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ =====
// BETã‚’ç·¨é›†ã§ãã‚‹ã®ã¯ã€Œé…ã‚‹å‰ã€orã€Œå‹æ•—ç¢ºå®šå¾Œã€ã ã‘
  const betEditable = (state.phase === "betting" || state.phase === "roundOver" || state.phase === "sessionOver");
// å…¥åŠ›æ¬„ã¨SETãƒœã‚¿ãƒ³
setDis("betInGame", !betEditable);
setDis("btnSetBet", !betEditable);

// +10 +50 ... ã®ãƒãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚‚å…¨éƒ¨
document.querySelectorAll("[data-add2]").forEach((b) => {
  b.disabled = !betEditable;
});
// ===== Insurance DOCK + ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« =====
//const insMode = (state.phase === "offerInsurance");
document.querySelector(".dock").classList.toggle("insMode", insMode);

// DOCKãƒ©ãƒ™ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆ
function setDockLabel(id, label, key){
  const el = $(id);
  if (!el) return;
  el.innerHTML = `${label} <span class="k">${key}</span>`;
}



if (insMode){
  // æ–°ã—ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
  $("overlayInsurance").classList.add("show");
  
  const mx = state.insurance.max|0;
  $("insHintOverlay").textContent = `${t("dyn.max")} ${mx} (bet/2)`;
  
  const a = $("insAmountOverlay");
  a.max = mx;
  a.step = 10;
  
  // ãƒ•ã‚§ãƒ¼ã‚ºã«å…¥ã£ãŸã°ã‹ã‚Šã®å ´åˆã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
  if (prevPhase !== "offerInsurance"){
    a.value = mx;
  } else {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ç¶­æŒã—ã¤ã¤ã‚¯ãƒ©ãƒ³ãƒ—
    a.value = Math.min(a.value, mx); // å˜ç´”ã‚¯ãƒ©ãƒ³ãƒ—
  }

  // é‡‘é¡ãŒ0ã®å ´åˆã«YESãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ãŒè‰¯ã„UXï¼‰
  // $("btnInsYes").disabled = (Number(a.value) <= 0);

} else {
  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã™
  $("overlayInsurance").classList.remove("show");
}


// render() ã®æœ€å¾Œã«
prevPhase = state.phase;

//       // ãƒ©ã‚¦ãƒ³ãƒ‰ãŒçµ‚ã‚ã£ãŸç¬é–“ã ã‘å±¥æ­´ã‚’è¿½åŠ 
// if (prevPhase !== "roundOver" && prevPhase !== "sessionOver"
//     && (state.phase === "roundOver" || state.phase === "sessionOver")) {
//   pushHistoryEntry(state);
// }

prevPhase = state.phase;


      updateBettingControls(); // ãƒ™ãƒƒãƒˆãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹æ›´æ–°
      console.log("render ok", state.phase);

    }


if (state && (state.phase === "betting" || state.phase === "roundOver")) {
    prevDealerCards = [];
    prevDealerJson = "";
    prevPlayerLens = [];
    prevPlayerJson = "";
}


    // ========= UI ã‚¤ãƒ™ãƒ³ãƒˆ =========
    // ========= UI ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒœã‚¿ãƒ³) =========
    // onclickå±æ€§ç”¨ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
    window.updateBet = function(addVal) {
      if (!state) return;
      let cur = Number($("betInput").value || 0);
      let next = cur + addVal;
      if (next < 0) next = 0;
      if (state.bank < next) next = floorEven(state.bank); // æ‰€æŒé‡‘ã§ã‚­ãƒ£ãƒƒãƒ—
      
      $("betInput").value = next;
      // if ($("betSelect")) $("betSelect").value = next; // å‰Šé™¤æ¸ˆ
      
      // æ›´æ–°ã‚’é€ä¿¡
      callAction("set_bet", next);
    };

    // ç„¡åŠ¹åŒ–ã®ãŸã‚ã®UIæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
    function updateBettingControls() {
        if (!state) return;
        const canBet = (state.phase === "betting" || state.phase === "roundOver");
        
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        const btns = document.querySelectorAll(".btn-bet");
        btns.forEach(b => b.disabled = !canBet);
        
        if (!canBet) {
            $("betInput").style.opacity = "0.5";
        } else {
            $("betInput").style.opacity = "1";
        }
    }

    // ç›´æ¥å…¥åŠ›ã®å¤‰æ›´
    function onBetInputChange(e) {
      if (!state) return;
      let val = floorEven(e.target.value);
      if (val < 0) val = 0;
      if (state.bank < val) val = floorEven(state.bank);

      // å…¥åŠ›ã‚’åŒæœŸ
      $("betInput").value = val;
      if ($("betInGame")) $("betInGame").value = val;
      if ($("betSelect")) $("betSelect").value = val;

      if (state.phase === "betting" || state.phase === "roundOver") {
         callAction("set_bet", val);
         if (state.phase === "roundOver") hideBoardAfterSet = true;
      }
    }

    if ($("betInput")) $("betInput").onchange = onBetInputChange;
    if ($("betInGame")) $("betInGame").onchange = onBetInputChange;

    $("btnHowTitle").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnHowTitle2").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnHowPause").onclick = ()=> $("overlayHow").classList.add("show");
    $("btnCloseHow").onclick = ()=> $("overlayHow").classList.remove("show");
    
    $("btnLangToggle").onclick = () => {
      const current = window.LOC.lang;
      const next = current === "en" ? "ja" : "en";
      window.LOC.lang = next;
    };

        // å±¥æ­´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    $("btnHistory").onclick = ()=>{
      renderHistoryOverlay();
      $("overlayHistory").classList.add("show");
    };
    $("btnCloseHistory").onclick = ()=> $("overlayHistory").classList.remove("show");

// ========= ãƒ©ãƒ³ã‚­ãƒ³ã‚° (localStorage) =========
const RANK_KEY = "bjRanking_v1";
const NAME_KEY = "bjPlayerName_v1";

let currentSessionId = null;
let sessionStartBank = 0;
let sessionFinalized = false;

function loadRanking(){
  try{
    const raw = localStorage.getItem(RANK_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch(e){
    console.warn("ranking load failed", e);
    return [];
  }
}
function saveRanking(list){
  try{
    localStorage.setItem(RANK_KEY, JSON.stringify(list));
  } catch(e){
    console.warn("ranking save failed", e);
  }
}
function fmtDur(ms){
  ms = Math.max(0, ms|0);
  const s = Math.floor(ms/1000);
  const m = Math.floor(s/60);
  const r = s%60;
  return `${m}:${String(r).padStart(2,"0")}`;
}

function getPlayerName(){
  const inp = $("nameInput");
  const v = (inp ? inp.value : "").trim().slice(0,12);
  const name = v || (localStorage.getItem(NAME_KEY) || "YOU");
  localStorage.setItem(NAME_KEY, name);
  return name;
}

function addRankingRecord(rec){
  const list = loadRanking();
  list.unshift(rec);
  if (list.length > 50) list.length = 50;

  // åˆ©ç›Š é™é † â†’ æœ€çµ‚æ‰€æŒé‡‘ é™é † â†’ çµŒéæ™‚é–“ æ˜‡é †
  list.sort((a,b)=>{
    const pa = (a.profit|0), pb = (b.profit|0);
    if (pb !== pa) return pb - pa;
    const ba = (a.finalBank|0), bb = (b.finalBank|0);
    if (bb !== ba) return bb - ba;
    return (a.durationMs|0) - (b.durationMs|0);
  });

  saveRanking(list);
}

function renderRankingOverlay(){
  const box = $("rankingList");
  if (!box) return;

  const list = loadRanking();
  if (!list.length){
    box.innerHTML = `<div class="small muted">${t("rank.none")}</div>`;
    return;
  }

  let html = '<table class="small" style="width:100%; border-collapse:collapse;">';
  html += '<thead><tr>';
  html += '<th style="text-align:left;padding:4px 8px;">#</th>';
  html += '<th style="text-align:left;padding:4px 8px;">Name</th>';
  html += '<th style="text-align:right;padding:4px 8px;">Profit</th>';
  html += '<th style="text-align:right;padding:4px 8px;">Final</th>';
  html += '<th style="text-align:right;padding:4px 8px;">Streak</th>';
  html += '<th style="text-align:right;padding:4px 8px;">Time</th>';
  html += '<th style="text-align:left;padding:4px 8px;">When</th>';
  html += '</tr></thead><tbody>';

  list.slice(0, 30).forEach((e, i)=>{
    const profit = e.profit|0;
    const pStyle = profit>0 ? ' style="color:#37d67a;"'
                 : profit<0 ? ' style="color:#ff4d4d;"' : '';
    html += '<tr>';
    html += `<td style="padding:4px 8px;">${i+1}</td>`;
    html += `<td style="padding:4px 8px;">${(e.name||"YOU")}</td>`;
    html += `<td style="padding:4px 8px;text-align:right;"${pStyle}>${profit>=0?`+${profit}`:profit}</td>`;
    html += `<td style="padding:4px 8px;text-align:right;">${e.finalBank|0}</td>`;
    html += `<td style="padding:4px 8px;text-align:right;">${e.maxStreak|0}</td>`;
    html += `<td style="padding:4px 8px;text-align:right;">${fmtDur(e.durationMs|0)}</td>`;
    html += `<td style="padding:4px 8px;">${formatHistoryTime(e.ts)}</td>`;
    html += '</tr>';
  });

  html += '</tbody></table>';
  box.innerHTML = html;
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«1å›ã ã‘å‘¼ã¶
function finalizeSessionRanking(st){
  if (sessionFinalized) return;
  if (!st || st.phase !== "sessionOver") return;
  if (!currentSessionId) return;

  sessionFinalized = true;

  // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ©ã‚¦ãƒ³ãƒ‰å±¥æ­´ã ã‘é›†ã‚ã‚‹ï¼ˆsessionIdãŒç„¡ã„æ—§ãƒ‡ãƒ¼ã‚¿ã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼‰
  const hist = loadHistory().filter(e => e.sessionId === currentSessionId);

  const totalNet = hist.reduce((a,e)=> a + (e.net|0), 0);
  const maxStreak = hist.reduce((a,e)=> Math.max(a, e.streak|0), 0);

  const durationMs = Math.max(0, (performance.now() - startTickAt - pausedTotal));
  const finalBank = st.bank|0;
  const profit = finalBank - (sessionStartBank|0);

  addRankingRecord({
    ts: Date.now(),
    name: getPlayerName(),
    sessionId: currentSessionId,
    profit,
    finalBank,
    totalNet,
    maxStreak,
    rounds: st.session?.round|0,
    durationMs,
  });

  // è¡¨ç¤ºã—ã¦æ°—æŒã¡ã‚ˆãã™ã‚‹ï¼ˆä»»æ„ï¼‰
  toast(`${t("rank.saved")}${profit>=0?`+${profit}`:profit}`);
}

// === ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é–“å¼•ãï¼ˆã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ï¼‰ ===
let uiLocked = false;
let uiLockTimer = null;
function lockUI(ms){
  uiLocked = true;
  render(); // ãƒœã‚¿ãƒ³æ›´æ–°
  if(uiLockTimer) clearTimeout(uiLockTimer);
  uiLockTimer = setTimeout(()=>{
    uiLocked = false;
    render();
  }, ms);
}


$("btnPause").onclick = ()=>{
  if (state && state.phase === "paused") return;
  //if (!state) return toast("ã‚²ãƒ¼ãƒ ä¸­ã«ä½¿ãˆã¾ã™");
  //if (!$("screenGame").classList.contains("active")) return toast("ã‚²ãƒ¼ãƒ ä¸­ã«ä½¿ãˆã¾ã™");

  // å¯èƒ½ãªã‚‰ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒãƒ¼ã‚ºã‚’å‘¼ã³å‡ºã™
  if(state) {
    callAction("set_paused", 1);
    pausedAt = performance.now();
  }
  setPause(true);
};

$("btnClosePause").onclick = $("btnContinue").onclick = ()=>{
  if (pausedAt){
    pausedTotal += performance.now() - pausedAt;
    pausedAt = 0;
  }
  callAction("set_paused", 0);
  setPause(false);
};

$("btnQuit").onclick = ()=> doResetToTitle();
$("btnSORevive").onclick = doRevive;

    // ========= UI ã‚¤ãƒ™ãƒ³ãƒˆ (Insurance) =========
    if ($("btnInsMaxSide")) {
        $("btnInsMaxSide").onclick = () => {
          if(!state) return;
          $("insAmountSide").value = state.insurance.max;
        };
    }
    if ($("btnInsZeroSide")) {
        $("btnInsZeroSide").onclick = () => {
          if(!state) return;
          $("insAmountSide").value = 0;
        };
    }
    
    $("btnEvenMoneyIns").onclick = () => {callAction("take_even_money");};


$("btnDebugAce").onclick = () => {
  $("btnDeal").disabled = true;
  $("btnDebugAce").disabled = true;
  // ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ãªã®ã§è‡ªå‹•ã‚­ãƒ£ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥ï¼ˆå¦¥å½“ãªãƒ™ãƒƒãƒˆã¨ä»®å®šï¼‰
  setTimeout(()=>{ 
    lockUI(800); 
    callAction("debug_deal_ace"); 
  }, 50);
};

$("btnDeal").onclick = ()=> {
  $("btnHit").disabled = true;
  $("btnStand").disabled = true;

  // ãƒ‡ã‚£ãƒ¼ãƒ«å‰ã«ãƒ™ãƒƒãƒˆã‚’è‡ªå‹•ã‚­ãƒ£ãƒƒãƒ—
  if (state && (state.phase === "betting" || state.phase === "roundOver")) {
    let bet = floorEven($("betInput").value); // betInGame ã‹ã‚‰å¤‰æ›´
    if (state.bank < bet) {

      bet = floorEven(state.bank);
      $("betInput").value = bet;
      // å¯èƒ½ãªã‚‰ã‚»ãƒ¬ã‚¯ãƒˆã‚’åŒæœŸ
      const sel = $("betSelect");
      if(sel) sel.value = bet;
      
      callAction("set_bet", bet);
      toast(t("toast.bet_adjusted"));
    }
  }

  setTimeout(()=>{ 
    lockUI(800); // ãƒ‡ã‚£ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯é•·ã„
    callAction("deal"); 
  }, 50);
};





    // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™å®Œäº†ã‚¬ãƒ¼ãƒ‰ï¼‰
    $("btnStart").onclick = () => {
      try{ soHideOverlay(); }catch(e){}

      sessionEndAdDone = false; 
      if (!apiReady()){
        toast(t("ui.engine_not_ready"));
        return;
      }

      // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ãƒ™ãƒƒãƒˆå…¥åŠ›ã‹ã‚‰å€¤ã‚’å–å¾—
      let bet = 100;
      if ($("betInputTitle")) bet = Number($("betInputTitle").value);
      if (!bet || bet < 10) bet = 10;
      bet = floorEven(bet);
      if (bet > 5000) bet = 5000; // åˆæœŸbankã§ã‚­ãƒ£ãƒƒãƒ—

      const {lo,hi} = seed64();
      const mask = rulesMaskFromUI();
      const sessionSeconds = 300;
      const roundLimit = 12;

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
      callAction("start_session", lo, hi, mask, sessionSeconds, roundLimit);

      // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ– =====
      currentSessionId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
      sessionStartBank = Number(state?.bank || 0);
      sessionFinalized = false;

      const savedName = localStorage.getItem(NAME_KEY);
      if (savedName && $("nameInput")) $("nameInput").value = savedName;

      // ãƒ™ãƒƒãƒˆè¨­å®šãƒ»åŒæœŸ
      if ($("betInput")) $("betInput").value = bet;
      callAction("set_bet", bet);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
      prevDealerCards = [];
      prevPlayerLens = [];
      prevBank = null;
      hideBoardAfterSet = false;

      lockUI(800);
      goScreen("game");
      startTick();
      toast(t("toast.good_luck"));
    };

if ($("btnSetBet")) $("btnSetBet").onclick = ()=>{
  if (!state) return;
  const phase = state.phase;
  let v = floorEven($("betInput").value);
  if (state.bank < v) v = floorEven(state.bank); // ç¾åœ¨ã®æ‰€æŒé‡‘ã§ã‚­ãƒ£ãƒƒãƒ—
  $("betInput").value = v;

  // BETTING / roundOver ä¸­ã¯ä»Šã¾ã§é€šã‚Šã‚¨ãƒ³ã‚¸ãƒ³ã« bet ã‚’é€ã‚‹
  if (phase === "betting" || phase === "roundOver") {
    callAction("set_bet", v);

    // roundOver ä¸­ã« SET ã—ãŸã‚‰ç›¤é¢ã‚’æ¶ˆã—ã¦ã€Œæ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰å¾…ã¡ã€ã®è¦‹ãŸç›®ã«ã™ã‚‹
    if (phase === "roundOver") {
      hideBoardAfterSet = true;
      render();
    }
    return;
  }

  // â˜… sessionOver ä¸­ã« SET ã‚’æŠ¼ã—ãŸå ´åˆ â†’ ç›¤é¢ã ã‘æ¶ˆã™
  if (phase === "sessionOver") {
    // hideBoardAfterSet = true; //// boardHidden = true ã§ç©ºã«æã
    render();      // ã‚¨ãƒ³ã‚¸ãƒ³ã«ã¯è§¦ã‚‰ãšã€è¦‹ãŸç›®ã ã‘æ›´æ–°
    return;
  }
};


    // ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (ãƒ‰ãƒƒã‚¯)
$("btnHit").onclick = ()=> {
  if (!state) return;
  if (uiLocked) return; // é€£æ‰“ç„¡è¦–

  if (state.phase === "offerInsurance") {
    const mx = state.insurance?.max ?? 0;
    let v = floorEven($("insAmountSide").value);
    v = Math.max(0, Math.min(v, mx));
    $("insAmountSide").value = v;
    return callAction("buy_insurance", v); // ã¯ã„
  }

  lockUI(600); // ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ~420ms + ãƒãƒ¼ã‚¸ãƒ³
  return callAction("hit");
};

$("btnStand").onclick = ()=> {
  if (!state) return;
  if (uiLocked && state.phase !== "offerInsurance") return; // ã‚¤ãƒ³ã‚·ãƒ¥ãƒ©ãƒ³ã‚¹å›ç­”ã¯è¨±å¯ï¼Ÿ ã„ã‚„ã€æ¨™æº–ãƒ­ãƒƒã‚¯ãƒ«ãƒ¼ãƒ«ã§ã€‚

  if (state.phase === "offerInsurance"){
    $("insAmountSide").value = 0;
    return callAction("buy_insurance", 0);   // ã„ã„ãˆ
  }
  lockUI(1000); // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹å¾…ã¡
  return callAction("stand");
};

// æ–°ã—ã„ãƒ‰ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒŠãƒ¼
$("btnDouble").onclick = ()=> callAction("double_down");
$("btnSplit").onclick = ()=> callAction("split");
$("btnSurrender").onclick = ()=> callAction("surrender");
$("btnEvenMoney").onclick = ()=> callAction("take_even_money");

// ã‚¤ãƒ³ã‚·ãƒ¥ãƒ©ãƒ³ã‚¹ (æ–°è¦)
$("btnInsNo").onclick = () => {
  callAction("buy_insurance", 0);
  $("overlayInsurance").classList.remove("show");
};
$("btnInsYes").onclick = () => {
  const val = Number($("insAmountOverlay").value);
  callAction("buy_insurance", val);
  $("overlayInsurance").classList.remove("show");
};
$("btnInsMaxOverlay").onclick = () => {
  if(!state) return;
  const mx = state.insurance.max|0;
  $("insAmountOverlay").value = mx;
};

// ãƒ™ãƒƒãƒˆé¸æŠãƒªã‚¹ãƒŠãƒ¼
if ($("betSelect")) $("betSelect").onchange = (e) => {
  if (!state) return;
  const val = Number(e.target.value); 
  
  // å…¥åŠ›ã‚’åŒæœŸ
  if($("betInput")) $("betInput").value = val;
  if($("betInGame")) $("betInGame").value = val;

  // æœ‰åŠ¹ãªãƒ™ãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚ºãªã‚‰å³åº§ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
  if (state.phase === "betting" || state.phase === "roundOver") {
     callAction("set_bet", val);
     if (state.phase === "roundOver") {
        hideBoardAfterSet = true;
        render();
     }
  }
};

// ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ãƒœã‚¿ãƒ³
$("btnSOTitle").onclick = ()=> doResetToTitle();
$("btnSORetry").onclick = ()=> {
  doResetToTitle();
  setTimeout(()=> $("btnStart").click(), 200);
};


$("btnRanking").onclick = ()=> {
  renderRankingOverlay();
  $("overlayRanking").classList.add("show");
};
$("btnCloseRanking").onclick = ()=> $("overlayRanking").classList.remove("show");

//ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‰Šé™¤æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™
// $("btnClearRanking").onclick = ()=> {
//   saveRanking([]);
//   renderRankingOverlay();
//   toast("Ranking cleared");
// };

$("nameInput")?.addEventListener("input", ()=>{
  const v = $("nameInput").value.trim().slice(0,12) || "YOU";
  localStorage.setItem(NAME_KEY, v);
});

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    window.addEventListener("keydown", (e)=>{
      if (!apiReady() || !$("screenGame").classList.contains("active")) return;
      const k = e.key.toLowerCase();
      if (k === "d") $("btnDeal").click();
      if (k === "h") $("btnHit").click();
      if (k === "s") $("btnStand").click();
      if (k === "escape"){
        if ($("overlayHow").classList.contains("show")) {
            $("overlayHow").classList.remove("show");
        } else if ($("overlayPause").classList.contains("show")) {
            $("btnClosePause").click();
        }
  }
      if (state && state.phase === "offerInsurance"){
      if (k === "y") $("btnHit").click();
      if (k === "n") $("btnStand").click();
      if (k === "m") {
        const btn = $("btnDockMore");
        if (btn) btn.click();
      }
      return;
    }

    });

    // ãƒ™ãƒƒãƒˆãƒ’ãƒ³ãƒˆ (ã‚¨ãƒ³ã‚¸ãƒ³æ¥ç¶šå‰ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ç”¨)
    function updateBetHintPreEngine(){
      const el = $("betInputTitle") || $("betInput");
      if (!el) return;
      const v = floorEven(el.value);
      if ($("betHint")) $("betHint").textContent = `å…¥åŠ›=${el.value} â†’ å¶æ•°åŒ–=${v}`;
    }
    if ($("betInputTitle")) $("betInputTitle").addEventListener("input", updateBetHintPreEngine);
    else if ($("betInput")) $("betInput").addEventListener("input", updateBetHintPreEngine);
    updateBetHintPreEngine();

    // ã‚¨ãƒ³ã‚¸ãƒ³åŒæœŸãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
    syncEngine();
  
  </script>



<!-- Last Build Scripts -->
<script src="blackjack.js"></script>
<script src="blackjack_ui.js"></script>

<style>
  #fxCanvas { position: fixed; inset: 0; pointer-events: none; z-index: 9999; }
</style>
<script>
  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
  const fxCanvas = document.createElement("canvas");
  fxCanvas.id = "fxCanvas";
  document.body.appendChild(fxCanvas);
  const fxCtx = fxCanvas.getContext("2d");
  let particles = [];

  function resizeFx(){
    fxCanvas.width = window.innerWidth;
    fxCanvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeFx);
  resizeFx();



  class Particle {
    constructor(x, y, color){
      this.x = x; this.y = y;
      const ang = Math.random() * Math.PI * 2;
      const spd = Math.random() * 6 + 2;
      this.vx = Math.cos(ang) * spd;
      this.vy = Math.sin(ang) * spd - 3; 
      this.color = color;
      this.life = 1.0;
      this.decay = Math.random() * 0.01 + 0.015;
      this.grav = 0.15;
    }
    update(){
      this.x += this.vx;
      this.y += this.vy;
      this.vy += this.grav;
      this.vx *= 0.96;
      this.life -= this.decay;
    }
    draw(ctx){
      ctx.globalAlpha = Math.max(0, this.life);
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.arc(this.x, this.y, 4, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1.0;
    }
  }

  function spawnConfetti(x, y){
    const colors = ["#d8b15a", "#ffdf8a", "#ffffff", "#37d67a"];
    for(let i=0; i<40; i++){
      particles.push(new Particle(x, y, colors[Math.floor(Math.random()*colors.length)]));
    }
  }

  function loopFx(){
    fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
    for(let i=particles.length-1; i>=0; i--){
      const p = particles[i];
      p.update();
      if(p.life <= 0) particles.splice(i, 1);
      else p.draw(fxCtx);
    }
    requestAnimationFrame(loopFx);
  }
  loopFx();
  
  window.triggerWinEffect = () => {
    const cx = window.innerWidth / 2;
    const cy = window.innerHeight / 2;
    spawnConfetti(cx, cy);
    spawnConfetti(cx - 100, cy - 50);
    spawnConfetti(cx + 100, cy - 50);
  };
</script>
</body>
</html>
